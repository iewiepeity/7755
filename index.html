<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿å¿æˆ‘æˆ‘å‰µè§’å°å¹«æ‰‹</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap">
  <style>
    :root {
      /* === æ ¸å¿ƒè®Šæ•¸ === */
      --radius-sm: 8px;
      --radius-md: 16px;
      --radius-lg: 28px;
      --radius-full: 999px;
      
      --shadow-xs: 0 2px 4px rgba(0,0,0,0.04);
      --shadow-sm: 0 6px 16px rgba(0,0,0,0.06);
      --shadow-md: 0 12px 32px -8px rgba(0,0,0,0.12);
      --shadow-float: 0 20px 50px -12px rgba(var(--focus-rgb), 0.25);
      
      --transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* æ›´æœ‰å½ˆæ€§çš„å‹•ç•« */
      
      /* èƒŒæ™¯è‰²ç³»å®šç¾© */
      --bg-pink: #fff5f9; --accent-pink: #ff80b0; --focus-rgb-pink: 255, 128, 176;
      --bg-cream: #fffbf0; --accent-cream: #ffad6b; --focus-rgb-cream: 255, 173, 107;
      --bg-mint: #f2fffa; --accent-mint: #4cd9a4; --focus-rgb-mint: 76, 217, 164;
      --bg-lavender: #fcfaff; --accent-lavender: #b185ff; --focus-rgb-lavender: 177, 133, 255;
      --bg-sky: #f5fbff; --accent-sky: #6ab0ff; --focus-rgb-sky: 106, 176, 255;
      --bg-lemon: #fffff5; --accent-lemon: #facc15; --focus-rgb-lemon: 250, 204, 21;
      --bg-grey: #f9fafb; --accent-grey: #8d99ae; --focus-rgb-grey: 141, 153, 174;
      --bg-black: #18181b; --accent-black: #71717a; --focus-rgb-black: 113, 113, 122;

      /* é è¨­è®Šæ•¸ */
      --page-bg: var(--bg-pink);
      --card-bg: rgba(255, 255, 255, 0.9);
      --sidebar-bg: rgba(255, 255, 255, 0.8);
      --text-main: #334155;
      --text-sub: #64748b;
      --border-color: rgba(0,0,0,0.06);
      --focus-color: var(--accent-pink);
      --focus-rgb: var(--focus-rgb-pink);
      --btn-bg: var(--accent-pink);
      --btn-text: #fff;
      
      /* èŠå¤©å®¤ */
      --chat-bg: #20232a;
      --chat-bubble-sys: #3a3f4b;
      --chat-bubble-user: var(--btn-bg);
      --chat-text: #e0e0e0;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0; /* ç‚ºäº†é€²åº¦æ¢ */
      font-family: "Noto Sans TC", system-ui, -apple-system, sans-serif;
      line-height: 1.75;
      color: var(--text-main);
      background-color: var(--page-bg);
      background-image: 
        radial-gradient(at 0% 0%, rgba(var(--focus-rgb), 0.1) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(var(--focus-rgb), 0.05) 0px, transparent 50%);
      background-attachment: fixed;
      transition: background 0.5s ease;
      min-height: 100vh;
      padding-bottom: 80px; /* é¿å… footer è¢«é®ä½ */
    }

    /* === ä¸»é¡Œè‰² === */
    body.theme-pink { --page-bg: var(--bg-pink); --focus-color: #ff80b0; --focus-rgb: var(--focus-rgb-pink); --btn-bg: #ff80b0; }
    body.theme-cream { --page-bg: var(--bg-cream); --focus-color: #ffad6b; --focus-rgb: var(--focus-rgb-cream); --btn-bg: #ffad6b; }
    body.theme-mint { --page-bg: var(--bg-mint); --focus-color: #4cd9a4; --focus-rgb: var(--focus-rgb-mint); --btn-bg: #4cd9a4; }
    body.theme-lavender { --page-bg: var(--bg-lavender); --focus-color: #b185ff; --focus-rgb: var(--focus-rgb-lavender); --btn-bg: #b185ff; }
    body.theme-sky { --page-bg: var(--bg-sky); --focus-color: #6ab0ff; --focus-rgb: var(--focus-rgb-sky); --btn-bg: #6ab0ff; }
    body.theme-lemon { --page-bg: var(--bg-lemon); --focus-color: #facc15; --focus-rgb: var(--focus-rgb-lemon); --btn-bg: #facc15; --btn-text: #5c4e00; }
    body.theme-grey { --page-bg: var(--bg-grey); --focus-color: #8d99ae; --focus-rgb: var(--focus-rgb-grey); --btn-bg: #8d99ae; }
    
    body.theme-black { 
      --page-bg: var(--bg-black); 
      --card-bg: rgba(39, 39, 42, 0.95);
      --sidebar-bg: rgba(39, 39, 42, 0.9);
      --text-main: #f4f4f5;
      --text-sub: #a1a1aa;
      --border-color: rgba(255,255,255,0.1);
      --focus-color: #a1a1aa;
      --focus-rgb: 161, 161, 170;
      --btn-bg: #52525b;
      --btn-text: #fff;
    }

    /* === é ‚éƒ¨é€²åº¦æ¢ === */
    .progress-header {
      position: sticky;
      top: 0;
      z-index: 999;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border-color);
      padding: 8px 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 10px rgba(0,0,0,0.03);
      transition: background 0.3s;
    }
    body.theme-black .progress-header { background: rgba(24, 24, 27, 0.8); }

    .progress-container {
      width: 100%;
      max-width: 800px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .progress-label { font-size: 0.75rem; font-weight: 700; color: var(--focus-color); white-space: nowrap; }
    .progress-track {
      flex: 1;
      height: 8px;
      background: rgba(0,0,0,0.05);
      border-radius: 99px;
      overflow: hidden;
    }
    body.theme-black .progress-track { background: rgba(255,255,255,0.1); }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--focus-color), #fff);
      background-size: 200% 100%;
      border-radius: 99px;
      transition: width 0.5s ease;
      animation: shimmer 2s infinite linear;
    }
    @keyframes shimmer { 0% { background-position: 100% 0; } 100% { background-position: -100% 0; } }

    /* === ä½ˆå±€å®¹å™¨ === */
    .layout-shell {
      display: flex;
      align-items: flex-start;
      gap: 32px;
      max-width: 1120px;
      margin: 30px auto;
      padding: 0 20px;
      position: relative;
    }

    .main-area { flex: 1; min-width: 0; }

    /* === å´é‚Šæ¬„ === */
    .sidebar {
      flex: 0 0 250px;
      width: 250px;
      position: sticky;
      top: 70px; /* é¿é–‹é€²åº¦æ¢ */
      background: var(--sidebar-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 16px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      overflow: hidden;
      transition: var(--transition);
      z-index: 50;
    }
    .sidebar.is-collapsed { flex: 0 0 72px; width: 72px; padding: 16px 10px; }
    .sidebar.is-collapsed .sidebar-title, .sidebar.is-collapsed .sidebar-sub { display: none; }
    
    .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); }
    .sidebar.is-collapsed .sidebar-header { justify-content: center; }
    .sidebar-title { font-weight: 700; color: var(--text-main); font-size: 1rem; }
    .sidebar-sub { font-size: 0.75rem; color: var(--text-sub); opacity: 0.8; }
    
    .sidebar-nav { display: flex; flex-direction: column; gap: 6px; }
    .sidebar-nav button {
      width: 100%; text-align: left; background: transparent; color: var(--text-main);
      border: none; padding: 10px 12px; border-radius: var(--radius-md);
      transition: var(--transition); display: flex; align-items: center; font-size: 0.9rem;
    }
    .sidebar-nav button:hover { background: rgba(var(--focus-rgb), 0.1); color: var(--focus-color); transform: translateX(3px); }
    .sidebar.is-collapsed .sidebar-nav button { justify-content: center; padding: 10px 0; }
    .sidebar.is-collapsed .sidebar-nav button span.btn-icon { margin: 0; font-size: 1.3rem; }
    .sidebar-nav button span.btn-icon { margin-right: 10px; width: 24px; text-align: center; font-size: 1.1rem; }

    /* === æ¨™é¡Œèˆ‡é ‚éƒ¨ === */
    .top-bar { max-width: 1120px; margin: 30px auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 20px; }
    h1 { 
      font-family: "Noto Serif TC", serif; font-size: 2.4rem; margin: 0 0 8px 0; font-weight: 700; letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--text-main) 30%, var(--focus-color));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      animation: titleFlow 5s ease infinite alternate;
    }
    @keyframes titleFlow { from { filter: hue-rotate(0deg); } to { filter: hue-rotate(10deg); } }
    
    .tagline { color: var(--text-sub); font-size: 1rem; }

    /* === å¡ç‰‡å€å¡Š === */
    .section {
      background: var(--card-bg);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border-radius: var(--radius-lg);
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-xs);
      border: 1px solid rgba(255,255,255,0.8);
      transition: var(--transition);
    }
    body.theme-black .section { border-color: rgba(255,255,255,0.05); }
    
    .section:hover { 
      box-shadow: var(--shadow-float); 
      transform: translateY(-4px) scale(1.005); 
      border-color: rgba(var(--focus-rgb), 0.3);
    }
    
    .section.collapsed { padding-bottom: 24px; opacity: 0.7; transform: none; box-shadow: none; }
    .section.collapsed .section-body { display: none; }
    .section-body { margin-top: 24px; animation: fadeIn 0.4s ease; }

    h2 { 
      font-size: 1.25rem; display: flex; align-items: center; justify-content: space-between; 
      padding-bottom: 12px; border-bottom: 1px solid var(--border-color); margin: 0; color: var(--text-main); font-weight: 700;
    }

    /* === è¼¸å…¥èˆ‡è¡¨å–® === */
    .label-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; flex-wrap: wrap; }
    label { font-weight: 600; color: var(--text-main); margin-right: 8px; font-size: 0.9rem; opacity: 0.9; }

    input[type="text"], input[type="search"], input[type="date"], select, textarea {
      width: 100%; padding: 12px 16px; font-size: 1rem; font-family: inherit; color: var(--text-main);
      background: rgba(255,255,255,0.4); border: 1px solid var(--border-color); border-radius: var(--radius-md);
      transition: var(--transition); margin-bottom: 10px; outline: none;
    }
    body.theme-black input, body.theme-black select, body.theme-black textarea { background: rgba(0,0,0,0.2); }
    
    textarea { min-height: 120px; line-height: 1.7; resize: vertical; }
    
    input:focus, select:focus, textarea:focus { 
      background: #fff; border-color: var(--focus-color); 
      box-shadow: 0 0 0 4px rgba(var(--focus-rgb), 0.15);
    }
    body.theme-black input:focus, body.theme-black textarea:focus { background: rgba(30,30,35,0.8); }

    /* === æ¨™ç±¤è† å›Šè¼¸å…¥ (Smart Tags) === */
    .tags-container {
      display: flex; flex-wrap: wrap; gap: 8px; padding: 8px;
      background: rgba(255,255,255,0.4); border: 1px solid var(--border-color); border-radius: var(--radius-md);
      min-height: 50px; transition: var(--transition); cursor: text; margin-bottom: 10px;
    }
    body.theme-black .tags-container { background: rgba(0,0,0,0.2); }
    .tags-container:focus-within { background: #fff; border-color: var(--focus-color); box-shadow: 0 0 0 4px rgba(var(--focus-rgb), 0.15); }
    body.theme-black .tags-container:focus-within { background: rgba(30,30,35,0.8); }
    
    .tag-pill {
      background: var(--focus-color); color: #fff; padding: 4px 10px; border-radius: 99px; font-size: 0.85rem;
      display: flex; align-items: center; gap: 6px; animation: popIn 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .tag-remove { cursor: pointer; opacity: 0.7; font-weight: bold; font-size: 1rem; line-height: 1; }
    .tag-remove:hover { opacity: 1; }
    
    .tags-input {
      flex: 1; border: none; background: transparent; padding: 4px; font-size: 1rem; color: var(--text-main); outline: none; min-width: 80px;
      margin: 0 !important; box-shadow: none !important;
    }
    .tags-input:focus { background: transparent !important; box-shadow: none !important; }

    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    /* === æŒ‰éˆ• === */
    button {
      cursor: pointer; border: none; border-radius: var(--radius-full); padding: 10px 22px; font-size: 0.95rem;
      font-family: inherit; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;
      background: var(--btn-bg); color: var(--btn-text);
      box-shadow: 0 4px 10px rgba(var(--focus-rgb), 0.2);
      transition: var(--transition); margin-right: 8px; margin-bottom: 8px;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(var(--focus-rgb), 0.3); }
    button:active { transform: translateY(0); }
    
    .button-secondary, .button-mini { background: transparent; color: var(--text-main); border: 1px solid var(--border-color); box-shadow: none; }
    .button-secondary:hover, .button-mini:hover { background: rgba(255,255,255,0.8); color: var(--focus-color); border-color: var(--focus-color); }
    body.theme-black .button-secondary:hover { background: rgba(255,255,255,0.1); }
    
    .button-mini { padding: 4px 12px; font-size: 0.8rem; border-radius: 10px; }
    
    .sidebar-toggle-btn { width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; background: transparent; border-radius: 50%; border: 1px solid var(--border-color); color: var(--text-sub); }

    /* === è¼¸å‡ºå€èˆ‡èŠå¤©é è¦½ === */
    #output {
      background: #1e1e1e; color: #e0e0e0; padding: 24px; border-radius: var(--radius-md);
      font-family: "Menlo", monospace; font-size: 0.9rem; white-space: pre-wrap; line-height: 1.6;
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.5); margin-top: 20px;
    }

    .chat-container {
      background: var(--chat-bg); border-radius: 24px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);
      max-width: 480px; margin: 20px auto; box-shadow: 0 20px 50px -10px rgba(0,0,0,0.5); font-family: -apple-system, sans-serif;
    }
    .chat-header { background: rgba(255,255,255,0.05); padding: 16px; text-align: center; color: #fff; font-weight: 600; border-bottom: 1px solid #333; }
    .chat-body { padding: 20px; display: flex; flex-direction: column; gap: 16px; min-height: 320px; }
    .msg-system { color: #888; font-size: 0.8rem; text-align: center; background: rgba(255,255,255,0.05); padding: 6px 12px; border-radius: 12px; align-self: center; max-width: 90%; }
    .msg-row { display: flex; gap: 12px; align-items: flex-start; }
    .msg-avatar { width: 40px; height: 40px; background: #555; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; flex-shrink: 0; font-weight: bold; }
    .msg-bubble { background: var(--chat-bubble-sys); color: var(--chat-text); padding: 12px 16px; border-radius: 4px 20px 20px 20px; font-size: 0.95rem; max-width: 85%; line-height: 1.5; }

    /* === Toast åå¸è¨Šæ¯ === */
    .toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast {
      background: rgba(20, 20, 20, 0.85); color: #fff; padding: 10px 24px; border-radius: 50px;
      font-size: 0.9rem; font-weight: 500; box-shadow: 0 10px 30px rgba(0,0,0,0.2); backdrop-filter: blur(8px);
      animation: toastIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; pointer-events: auto;
      display: flex; align-items: center; gap: 8px; border: 1px solid rgba(255,255,255,0.1);
    }
    .toast.fade-out { animation: toastOut 0.3s forwards; }
    @keyframes toastIn { from { opacity: 0; transform: translateY(20px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes toastOut { to { opacity: 0; transform: translateY(10px); } }

    /* === å›åˆ°é é¦– === */
    #backToTopBtn {
      position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; border-radius: 50%;
      background: var(--btn-bg); color: #fff; font-size: 1.5rem; box-shadow: 0 8px 24px rgba(var(--focus-rgb), 0.35);
      z-index: 999; opacity: 0; visibility: hidden; transform: translateY(20px); transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      display: flex; align-items: center; justify-content: center; padding: 0; margin: 0;
    }
    #backToTopBtn.show { opacity: 1; visibility: visible; transform: translateY(0); }
    #backToTopBtn:hover { transform: translateY(-4px) scale(1.1); }

    /* === è¼”åŠ©æ–‡å­— === */
    .field-utils { display: flex; justify-content: flex-end; align-items: center; gap: 8px; margin-top: -8px; margin-bottom: 20px; font-size: 0.75rem; color: var(--text-sub); }
    .char-count-circle {
      width: 20px; height: 20px; border-radius: 50%; border: 2px solid #ddd; display: inline-block;
      position: relative; margin-right: 4px; transition: all 0.3s;
    }
    .char-count-circle::after {
      content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; border-radius: 50%;
      border: 2px solid var(--focus-color); border-top-color: transparent; border-right-color: transparent;
      transform: rotate(var(--deg, 0deg)); opacity: 0; transition: opacity 0.3s;
    }
    .char-count-circle.active::after { opacity: 1; }
    
    /* æ‰‹æ©Ÿç‰ˆ RWD */
    @media (max-width: 850px) {
      .layout-shell { flex-direction: column; gap: 20px; margin: 10px auto; padding: 0 12px; }
      .sidebar { width: 100%; position: static; margin-bottom: 0; padding: 12px; z-index: 1; }
      .sidebar-header, .sidebar-sub, .sidebar-toggle-btn { display: none; }
      .sidebar-nav { flex-direction: row; overflow-x: auto; gap: 8px; padding-bottom: 4px; scrollbar-width: none; }
      .sidebar-nav::-webkit-scrollbar { display: none; }
      .sidebar-nav button { width: auto; white-space: nowrap; padding: 8px 16px; border-radius: 99px; border: 1px solid var(--border-color); background: rgba(255,255,255,0.5); }
      .sidebar-nav button span.btn-icon { margin-right: 6px; }
    }
    
    /* å¼·åˆ¶æ‰‹æ©Ÿæ’ç‰ˆ */
    body.layout-mobile { max-width: 600px !important; margin: 0 auto !important; padding: 0 10px 80px !important; }
    body.layout-mobile .layout-shell { flex-direction: column; gap: 16px; margin-top: 10px; }
    body.layout-mobile .sidebar {
      width: 100%; position: sticky; top: 54px; z-index: 100; padding: 8px; border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: visible !important; transition: none !important;
    }
    body.layout-mobile .sidebar-nav {
      display: flex; flex-direction: row; overflow-x: auto; gap: 6px; padding: 2px;
      -ms-overflow-style: none; scrollbar-width: none;
    }
    body.layout-mobile .sidebar-nav button { flex: 0 0 auto; width: auto; white-space: nowrap; padding: 6px 14px; font-size: 0.85rem; border-radius: 99px; }
    body.layout-mobile .sidebar-nav button:hover, body.layout-mobile .sidebar-nav button:active {
      background: var(--focus-color); color: #fff; border-color: var(--focus-color); transform: none;
    }
  </style>
</head>
<body class="theme-pink layout-desktop">

  <div class="progress-header">
    <div class="progress-container">
      <div class="progress-label">è¨­å®šå®Œæˆåº¦ <span id="progressText">0%</span></div>
      <div class="progress-track">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <div class="top-bar">
    <div>
      <h1>ğŸ’• å¿å¿æˆ‘æˆ‘å‰µè§’å°å¹«æ‰‹</h1>
      <div class="tagline">å¡«å¯«è¨­å®šï¼Œä¸€éµç”Ÿæˆ AI è§’è‰²å¡ Markdownï¼Œè®“æ•…äº‹é–‹å§‹ã€‚</div>
    </div>
    <div class="theme-select">
      <select onchange="changeTheme(this.value)" style="width:auto; display:inline-block; padding:8px 14px; border-radius:12px; cursor:pointer;">
        <option value="pink" selected>ğŸŒ¸ æ«»èŠ±ç²‰</option>
        <option value="cream">ğŸ å¥¶æ²¹ç™½</option>
        <option value="mint">ğŸŒ¿ è–„è·ç¶ </option>
        <option value="lavender">ğŸ”® è–°è¡£è‰</option>
        <option value="sky">â˜ï¸ å¤©ç©ºè—</option>
        <option value="lemon">ğŸ‹ æª¸æª¬é»ƒ</option>
        <option value="grey">ğŸŒ«ï¸ æ¥µç°¡ç°</option>
        <option value="black">ğŸŒ™ æ·±å¤œé»‘</option>
      </select>
    </div>
  </div>

  <div class="layout-shell">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">ğŸ“ åŠŸèƒ½å°èˆª</div>
        <button type="button" class="sidebar-toggle-btn" onclick="toggleSidebar()" title="æ”¶åˆ/å±•é–‹">â—€</button>
      </div>
      <div class="sidebar-sub">é»æ“Šå¿«é€Ÿè·³è½‰</div>
      <nav class="sidebar-nav">
        <button type="button" class="sidebar-main" onclick="scrollToSection('sec-archive')"><span class="btn-icon">ğŸ“‚</span>å­˜æª”ç®¡ç†</button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-info')"><span class="btn-icon">ğŸ’â€â™€ï¸</span>è§’è‰²è³‡è¨Š</button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-basic')"><span class="btn-icon">ğŸŒ</span>åŸºæœ¬è³‡è¨Š</button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-personality')"><span class="btn-icon">ğŸ’—</span>æ€§æ ¼ç‰¹è³ª</button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-speech')"><span class="btn-icon">ğŸ—£ï¸</span>èªªè©±é¢¨æ ¼</button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-prompt')"><span class="btn-icon">ğŸ§ </span>Prompt</button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-first')"><span class="btn-icon">ğŸ¬</span>é–‹å ´å°è©±</button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-output')"><span class="btn-icon">ğŸ“</span>è¼¸å‡ºé è¦½</button>
        <button type="button" class="sidebar-main" onclick="scrollToSection('sec-layout')"><span class="btn-icon">ğŸ“±</span>ç‰ˆé¢åˆ‡æ›</button>
      </nav>
    </aside>

    <main class="main-area">

      <div class="section" id="sec-archive">
        <h2><span>ğŸ“‚ è§’è‰²å­˜æª”</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-archive')">â‡•</button></h2>
        <div class="section-body">
          <div class="label-row">
             <div style="flex:1; margin-right:12px;">
              <select id="filterCategory" onchange="refreshCharListFromStorage()"><option value="">å…¨éƒ¨åˆ†é¡</option></select>
            </div>
            <div style="flex:1;">
              <input id="searchName" type="search" placeholder="æœå°‹è§’è‰²..." oninput="refreshCharListFromStorage()" />
            </div>
          </div>
          <div id="charList" style="margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; min-height:40px;"></div>
          <div style="margin-top:20px; padding-top:20px; border-top:1px dashed var(--border-color); display:flex; gap:10px;">
            <button type="button" onclick="newCharacter()">â• æ–°è§’è‰²</button>
            <button type="button" onclick="saveCurrentChar()">ğŸ’¾ å„²å­˜</button>
            <button type="button" class="button-secondary" onclick="deleteCurrentChar()" style="margin-left:auto;">ğŸ—‘ åˆªé™¤</button>
          </div>
        </div>
      </div>

      <div class="section" id="sec-info">
        <h2><span>ğŸ’â€â™€ï¸ è§’è‰²è³‡è¨Š</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-info')">â‡•</button></h2>
        <div class="section-body">
          <div class="label-row">
            <label>è§’è‰²åç¨± *</label>
            <button type="button" class="button-mini" onclick="clearOne('charName')">æ¸…ç©º</button>
          </div>
          <input id="charName" type="text" class="required-field" placeholder="ä¾‹å¦‚ï¼šæ—æœˆå¦‚" oninput="updateChatPreview()" />

          <div class="label-row">
             <div style="flex:1; margin-right:16px;">
               <label>å¹´é½¡</label>
               <input id="charAge" type="text" class="required-field" placeholder="18æ­²" />
            </div>
            <div style="flex:1;">
               <label>è·æ¥­</label>
               <input id="charJob" type="text" class="required-field" placeholder="å­¸ç”Ÿ" />
            </div>
          </div>
          
          <div class="label-row"><label>è§’è‰²åˆ†é¡</label></div>
          <input id="charCategory" type="text" placeholder="ç¾ä»£ã€å¥‡å¹»..." />

          <div class="label-row"><label>ä¸€å¥è©±ä»‹ç´¹ *</label></div>
          <textarea id="charQuote" class="required-field" style="min-height:80px;" placeholder="é¡¯ç¤ºåœ¨åˆ—è¡¨çš„çŸ­ä»‹ç´¹"></textarea>

          <div class="label-row"><label>æ¨™ç±¤ (è¼¸å…¥å¾ŒæŒ‰ Enter)</label></div>
          <div class="tags-container" id="tagsContainer" onclick="document.getElementById('tagInput').focus()">
            <input type="text" id="tagInput" class="tags-input" placeholder="è¼¸å…¥æ¨™ç±¤..." />
          </div>
          <input type="hidden" id="charTags" /> <div class="label-row"><label>å‰µä½œè€…ç­†è¨˜</label></div>
          <textarea id="creatorNote" style="min-height:80px;"></textarea>
        </div>
      </div>
      
      <div class="section" id="sec-gender">
         <h2><span>ğŸš» æ€§åˆ¥</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-gender')">â‡•</button></h2>
        <div class="section-body">
          <select id="gender" class="required-field">
            <option value="æœªè¨­ç½®" selected>æœªè¨­ç½®</option>
            <option value="ç”·æ€§">ç”·æ€§</option>
            <option value="å¥³æ€§">å¥³æ€§</option>
            <option value="ç„¡æ€§åˆ¥">ç„¡æ€§åˆ¥</option>
          </select>
        </div>
      </div>

      <div class="section" id="sec-basic">
        <h2><span>ğŸŒ åŸºæœ¬è³‡è¨Š (ä¸–ç•Œè§€)</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-basic')">â‡•</button></h2>
        <div class="section-body">
           <div class="label-row" style="justify-content:flex-end;">
              <button type="button" class="button-mini" onclick="saveTemplateFromField('basicInfo','basicInfo')">å­˜ç‚ºæ¨¡æ¿</button>
          </div>
          <textarea id="basicInfo" class="required-field" placeholder="å¿…å¡«ã€‚ä¸–ç•Œè§€ã€èƒŒæ™¯æ•…äº‹..."></textarea>
        </div>
      </div>

      <div class="section" id="sec-personality">
        <h2><span>ğŸ’— æ€§æ ¼ç‰¹è³ª</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-personality')">â‡•</button></h2>
        <div class="section-body">
          <div class="label-row" style="justify-content:flex-end;">
              <button type="button" class="button-mini" onclick="saveTemplateFromField('personality','personality')">å­˜ç‚ºæ¨¡æ¿</button>
          </div>
          <textarea id="personality" class="required-field" placeholder="å¿…å¡«ã€‚å…§åœ¨æ€§æ ¼ã€å°ç©å®¶çš„æ…‹åº¦..."></textarea>
        </div>
      </div>
      
      <div class="section" id="sec-speech">
        <h2><span>ğŸ—£ï¸ èªªè©±é¢¨æ ¼</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-speech')">â‡•</button></h2>
        <div class="section-body">
          <div class="label-row" style="justify-content:flex-end;">
              <button type="button" class="button-mini" onclick="saveTemplateFromField('speechStyle','speechStyle')">å­˜ç‚ºæ¨¡æ¿</button>
          </div>
          <textarea id="speechStyle" class="required-field" placeholder="å¿…å¡«ã€‚å£é ­ç¦ªã€èªæ°£ã€ç”¨è©ç¿’æ…£..."></textarea>
        </div>
      </div>
      
      <div class="section" id="sec-prompt">
        <h2><span>ğŸ§  Prompt å„ªåŒ–</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-prompt')">â‡•</button></h2>
        <div class="section-body">
          <div class="label-row"><label>System Role (ç³»çµ±æŒ‡ä»¤)</label></div>
          <textarea id="promptRole" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä½..."></textarea>
          <div class="label-row"><label>Response Guideline (å›æ‡‰è¦å‰‡)</label></div>
          <textarea id="promptGuideline" placeholder="ä¾‹å¦‚ï¼šè«‹ç”¨ç¬¬ä¸€äººç¨±..."></textarea>
        </div>
      </div>

      <div class="section" id="sec-first">
        <h2><span>ğŸ¬ é–‹å ´èˆ‡å°è©±</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-first')">â‡•</button></h2>
        <div class="section-body">
          <div class="label-row"><label>ç¬¬ä¸€æ¬¡èŠå¤©å ´æ™¯ (æ—ç™½)</label></div>
          <textarea id="firstScene" oninput="updateChatPreview()" placeholder="è¨­å®šå ´æ™¯..."></textarea>
          <div class="label-row"><label>è§’è‰²å°è©±ç¯„ä¾‹</label></div>
          <textarea id="sampleDialogue" oninput="updateChatPreview()" placeholder="è§’è‰²ç¬¬ä¸€å¥æœƒèªªçš„è©±..."></textarea>
        </div>
      </div>
      
      <div class="section" id="sec-fav">
        <h2><span>ğŸ€ å–œå¥½èˆ‡ç”Ÿæ—¥</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-fav')">â‡•</button></h2>
        <div class="section-body">
          <input id="likes" type="text" placeholder="å–œæ­¡çš„æ±è¥¿" />
          <input id="dislikes" type="text" placeholder="è¨å­çš„æ±è¥¿" />
          <input id="birthday" type="date" />
        </div>
      </div>
      
      <div class="section" id="sec-extra">
        <h2><span>ğŸ“Œ é™„åŠ è³‡è¨Š</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-extra')">â‡•</button></h2>
        <div class="section-body">
          <div id="extraContainer"></div>
          <button type="button" onclick="addExtra()">ï¼‹ æ–°å¢ä¸€ç­†</button>
        </div>
      </div>
      
      <div class="section" id="sec-event">
        <h2><span>ğŸ“š å‰µä½œè€…äº‹ä»¶</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-event')">â‡•</button></h2>
        <div class="section-body">
          <div id="eventContainer"></div>
          <button type="button" onclick="addEvent()">ï¼‹ æ–°å¢äº‹ä»¶</button>
        </div>
      </div>

      <div class="section" id="sec-output">
        <h2><span>ğŸ“ è¼¸å‡ºèˆ‡é è¦½</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-output')">â‡•</button></h2>
        <div class="section-body">
           <div class="actions-row" style="justify-content:center; margin-bottom:30px;">
             <button onclick="generateMarkdown()" style="width:100%; padding:14px; font-size:1.1rem;">âœ¨ ç”Ÿæˆ AI çµæ§‹åŒ–è¨­å®š</button>
           </div>

           <h3 style="margin-top:30px; border-left:4px solid var(--focus-color); padding-left:12px;">ğŸ’¬ æ¨¡æ“¬æ‰‹æ©Ÿå°è©±</h3>
           <div class="chat-container">
            <div class="chat-header"><span id="chatHeaderName">è§’è‰²åç¨±</span></div>
            <div class="chat-body">
              <div class="msg-system" id="previewScene">ï¼ˆç­‰å¾…è¼¸å…¥å ´æ™¯...ï¼‰</div>
              <div class="msg-row">
                <div class="msg-avatar" id="previewAvatar">A</div>
                <div class="msg-bubble" id="previewDialogue">ï¼ˆç­‰å¾…è¼¸å…¥å°è©±...ï¼‰</div>
              </div>
            </div>
          </div>
          
          <div style="margin-top:30px; display:flex; gap:10px; flex-wrap:wrap;">
             <button class="button-secondary" type="button" onclick="downloadTxt()">â¬‡ ä¸‹è¼‰ .txt</button>
             <button class="button-secondary" type="button" onclick="exportAllData()">ğŸ“¦ å‚™ä»½å…¨éƒ¨ (.json)</button>
             <label class="button-secondary" style="cursor:pointer; display:flex; align-items:center; margin:0 0 8px 0;">
                ğŸ“‚ åŒ¯å…¥å‚™ä»½
                <input id="allFile" type="file" accept=".json" style="display:none;" onchange="importAllData()" />
             </label>
          </div>

          <div id="output"></div>
        </div>
      </div>
      
      <div class="section" id="sec-template-center">
        <h2><span>ğŸ§° æ¨¡æ¿ç®¡ç†</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-template-center')">â‡•</button></h2>
        <div class="section-body">
            <select id="tplFilter" onchange="renderTemplateManager()"><option value="">å…¨éƒ¨é¡å‹</option></select>
            <div id="tplManagerList" style="margin-top:16px;"></div>
        </div>
      </div>
      
      <div class="section" id="sec-layout">
        <h2><span>ğŸ“± ç‰ˆé¢åˆ‡æ›</span></h2>
        <div class="section-body">
          <div style="display:flex; gap:10px;">
              <button class="button-secondary" onclick="setLayout('desktop')">ğŸ’» é›»è…¦ç‰ˆ</button>
              <button class="button-secondary" onclick="setLayout('mobile')">ğŸ“± æ‰‹æ©Ÿç‰ˆ</button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <button type="button" id="backToTopBtn" onclick="scrollToTop()" title="å›åˆ°é é¦–">â–²</button>

  <script>
    const EXTRA_MAX = 10;
    const EVENT_MAX = 20;
    const STORAGE_KEY = 'qing_char_pro_v2'; // æ›´æ–° key é¿å…è¡çª
    const TEMPLATE_TYPES = ['basicInfo','personality','speechStyle','extra','event'];
    const TEMPLATE_TYPE_LABELS = {
      basicInfo: 'åŸºæœ¬è³‡è¨Š', personality: 'æ€§æ ¼', speechStyle: 'èªªè©±é¢¨æ ¼', extra: 'é™„åŠ è³‡è¨Š', event: 'å‰µä½œè€…äº‹ä»¶'
    };

    /* ========= æ ¸å¿ƒåˆå§‹åŒ– ========= */
    window.addEventListener('DOMContentLoaded', () => {
      initLayoutByWidth();
      loadInitialFromStore();
      setupAutoSave();
      initTagInput(); // åˆå§‹åŒ–æ¨™ç±¤ç³»çµ±
      updateProgress(); // åˆå§‹åŒ–é€²åº¦æ¢
      
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(initLayoutByWidth, 200);
      });
    });

    /* ========= é€²åº¦æ¢ç³»çµ± ========= */
    function updateProgress() {
      // å¿…å¡«æ¬„ä½ ID åˆ—è¡¨
      const requiredIds = ['charName', 'charAge', 'charJob', 'charQuote', 'basicInfo', 'personality', 'speechStyle'];
      let filledCount = 0;
      
      // æª¢æŸ¥ä¸€èˆ¬æ¬„ä½
      requiredIds.forEach(id => {
        const el = document.getElementById(id);
        if(el && el.value.trim() !== '') filledCount++;
      });
      
      // æª¢æŸ¥æ€§åˆ¥ (ä¸èƒ½æ˜¯æœªè¨­ç½®)
      const gender = document.getElementById('gender');
      if(gender && gender.value !== 'æœªè¨­ç½®') filledCount++;
      
      const total = requiredIds.length + 1;
      const percent = Math.round((filledCount / total) * 100);
      
      const bar = document.getElementById('progressBar');
      const text = document.getElementById('progressText');
      
      if(bar) bar.style.width = `${percent}%`;
      if(text) text.textContent = `${percent}%`;
    }

    /* ========= æ™ºæ…§æ¨™ç±¤ç³»çµ± (Chips) ========= */
    function initTagInput() {
        const container = document.getElementById('tagsContainer');
        const input = document.getElementById('tagInput');
        const hiddenInput = document.getElementById('charTags');
        
        if(!container || !input) return;

        // å¾ hidden input æ¢å¾©æ¨™ç±¤
        function renderTags() {
            // æ¸…é™¤èˆŠçš„ pills (ä¿ç•™ input)
            const pills = container.querySelectorAll('.tag-pill');
            pills.forEach(p => p.remove());
            
            const tags = hiddenInput.value.split(' ').filter(t => t.trim() !== '');
            tags.forEach(tagText => {
                const pill = document.createElement('div');
                pill.className = 'tag-pill';
                pill.innerHTML = `<span>${tagText}</span><span class="tag-remove" onclick="removeTag('${tagText}')">Ã—</span>`;
                container.insertBefore(pill, input);
            });
        }

        // ç›£è½ Enter éµ
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const txt = input.value.trim();
                if (txt) {
                    let currentTags = hiddenInput.value.split(' ').filter(t => t.trim() !== '');
                    if (!currentTags.includes(txt)) {
                        currentTags.push(txt);
                        hiddenInput.value = currentTags.join(' ');
                        renderTags();
                        saveCurrentChar(); // å­˜æª”
                    }
                    input.value = '';
                }
            }
            // Backspace åˆªé™¤æœ€å¾Œä¸€å€‹
            if (e.key === 'Backspace' && input.value === '') {
                 let currentTags = hiddenInput.value.split(' ').filter(t => t.trim() !== '');
                 if(currentTags.length > 0) {
                     currentTags.pop();
                     hiddenInput.value = currentTags.join(' ');
                     renderTags();
                     saveCurrentChar();
                 }
            }
        });
        
        // å…¨åŸŸå‡½å¼ä¾› onclick ä½¿ç”¨
        window.removeTag = function(text) {
            let currentTags = hiddenInput.value.split(' ').filter(t => t.trim() !== '');
            currentTags = currentTags.filter(t => t !== text);
            hiddenInput.value = currentTags.join(' ');
            renderTags();
            saveCurrentChar();
        };
        
        // åˆå§‹æ¸²æŸ“
        renderTags();
    }

    /* ========= èŠå¤©é è¦½ ========= */
    function updateChatPreview() {
        const name = document.getElementById('charName').value || "è§’è‰²";
        const scene = document.getElementById('firstScene').value || "ï¼ˆç­‰å¾…è¼¸å…¥å ´æ™¯...ï¼‰";
        const dialogue = document.getElementById('sampleDialogue').value || "ï¼ˆç­‰å¾…è¼¸å…¥å°è©±...ï¼‰";
        
        document.getElementById('chatHeaderName').textContent = name;
        const avatarEl = document.getElementById('previewAvatar');
        if(avatarEl) {
            avatarEl.textContent = name.charAt(0);
            avatarEl.style.backgroundColor = getComputedStyle(document.body).getPropertyValue('--focus-color');
        }
        
        document.getElementById('previewScene').innerHTML = scene.replace(/\n/g, '<br>');
        document.getElementById('previewDialogue').innerHTML = dialogue.replace(/\n/g, '<br>');
    }

    /* ========= Toast Notification ========= */
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      if (!container) return;
      const toast = document.createElement('div');
      toast.className = 'toast';
      let icon = 'âœ…';
      if(type === 'error') icon = 'âŒ';
      if(type === 'warn') icon = 'âš ï¸';
      toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
      container.appendChild(toast);
      setTimeout(() => {
        toast.classList.add('fade-out');
        toast.addEventListener('animationend', () => toast.remove());
      }, 3000);
    }

    /* ========= é€šç”¨å·¥å…·èˆ‡å­˜æª” ========= */
    function limitText(text, max) { return text.trim().slice(0, max); }
    function changeTheme(theme) {
      document.body.classList.remove('theme-pink','theme-cream','theme-mint','theme-lavender','theme-sky','theme-lemon','theme-grey','theme-black');
      document.body.classList.add(`theme-${theme}`);
    }
    function setLayout(mode) {
      document.body.classList.remove('layout-desktop','layout-mobile');
      document.body.classList.add(`layout-${mode}`);
    }
    function initLayoutByWidth() {
      if (window.innerWidth <= 850) setLayout('mobile'); else setLayout('desktop');
    }
    function toggleSidebar() {
      const sb = document.querySelector('.sidebar');
      if(sb) {
          sb.classList.toggle('is-collapsed');
          const btn = document.querySelector('.sidebar-toggle-btn');
          if(btn) btn.textContent = sb.classList.contains('is-collapsed') ? 'â–¶' : 'â—€';
      }
    }
    function scrollToSection(id) {
      const el = document.getElementById(id);
      if(el) {
        expandSection(id);
        const y = el.getBoundingClientRect().top + window.pageYOffset - 80;
        window.scrollTo({top:y, behavior:'smooth'});
      }
    }
    function toggleSectionCollapse(id) { document.getElementById(id).classList.toggle('collapsed'); }
    function expandSection(id) { document.getElementById(id).classList.remove('collapsed'); }

    /* ... ä¿ç•™ä¹‹å‰çš„ getStore, setStore, saveCurrentChar ç­‰é‚è¼¯ ... */
    /* ç‚ºäº†ç¯€çœç¯‡å¹…ï¼Œé€™è£¡æ”¾å…¥æ ¸å¿ƒé‚è¼¯çš„ç°¡åŒ–ç‰ˆï¼ŒåŠŸèƒ½èˆ‡ä¹‹å‰ä¸€è‡´ä½†åŠ ä¸Šäº† updateProgress() */
    
    function getStore() {
       const raw = localStorage.getItem(STORAGE_KEY);
       if(!raw) return { currentId: null, chars: {}, templates: {basicInfo:[], personality:[], speechStyle:[], extra:[], event:[]} };
       try { return JSON.parse(raw); } catch(e) { return { currentId: null, chars: {}, templates: {} }; }
    }
    function setStore(s) { localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
    
    function saveCurrentChar() {
       const store = getStore();
       let id = store.currentId || ('char_' + Date.now());
       store.currentId = id;
       
       // æ”¶é›†è³‡æ–™
       const fields = ['charName','charAge','charJob','charQuote','charDesc','charTags','creatorNote','basicInfo','personality','speechStyle','firstScene','sampleDialogue','likes','dislikes','birthday','gender','modelType','promptRole','promptGuideline'];
       const data = { fields: {}, extras: [], events: [] };
       fields.forEach(fid => { 
           const el = document.getElementById(fid);
           if(el) data.fields[fid] = el.value || "";
       });
       
       // æ”¶é›†å‹•æ…‹æ¬„ä½
       document.querySelectorAll('.extra-block').forEach(b => {
           data.extras.push({ title: b.querySelector('.extra-title-field').value, text: b.querySelector('.extra-field').value });
       });
       document.querySelectorAll('.event-block').forEach(b => {
           data.events.push({ title: b.querySelector('.event-title-field').value, text: b.querySelector('.event-field').value });
       });

       store.chars[id] = { 
           meta: { name: data.fields.charName || "æœªå‘½å", createdAt: Date.now() },
           data: data 
       };
       
       setStore(store);
       renderCharList(store);
       updateProgress(); // æ›´æ–°é€²åº¦æ¢
    }
    
    function loadInitialFromStore() {
       const store = getStore();
       if(!store.currentId && Object.keys(store.chars).length) store.currentId = Object.keys(store.chars)[0];
       if(store.currentId && store.chars[store.currentId]) {
           fillFormFromData(store.chars[store.currentId].data);
       }
       renderCharList(store);
    }
    
    function fillFormFromData(data) {
        if(!data) return;
        // å¡«å…¥ä¸€èˆ¬æ¬„ä½
        for(let key in data.fields) {
            const el = document.getElementById(key);
            if(el) el.value = data.fields[key];
        }
        // å¡«å…¥å‹•æ…‹æ¬„ä½ (å…ˆæ¸…ç©ºå†æ–°å¢)
        document.getElementById('extraContainer').innerHTML = '';
        document.getElementById('eventContainer').innerHTML = '';
        if(data.extras) data.extras.forEach(ex => addExtraWithVal(ex.title, ex.text));
        if(data.events) data.events.forEach(ev => addEventWithVal(ev.title, ev.text));
        
        // è§¸ç™¼æ›´æ–°
        initTagInput(); // é‡æ–°æ¸²æŸ“æ¨™ç±¤
        updateChatPreview();
        updateProgress();
    }

    /* ========= å‹•æ…‹æ¬„ä½è¼”åŠ© ========= */
    function addExtra() { addExtraWithVal('',''); }
    function addExtraWithVal(title, text) {
        const div = document.createElement('div'); div.className = 'extra-block';
        div.innerHTML = `
           <div class="label-row"><label>æ¨™é¡Œ</label><input type="text" class="extra-title-field" value="${title}" oninput="saveCurrentChar()"></div>
           <textarea class="extra-field" oninput="saveCurrentChar()">${text}</textarea>
           <div style="text-align:right; margin-top:4px;"><button class="button-mini" onclick="this.closest('.extra-block').remove(); saveCurrentChar();">åˆªé™¤</button></div>
        `;
        document.getElementById('extraContainer').appendChild(div);
    }
    function addEvent() { addEventWithVal('',''); }
    function addEventWithVal(title, text) {
        const div = document.createElement('div'); div.className = 'event-block';
        div.innerHTML = `
           <div class="label-row"><label>äº‹ä»¶æ¨™é¡Œ</label><input type="text" class="event-title-field" value="${title}" oninput="saveCurrentChar()"></div>
           <textarea class="event-field" oninput="saveCurrentChar()">${text}</textarea>
           <div style="text-align:right; margin-top:4px;"><button class="button-mini" onclick="this.closest('.event-block').remove(); saveCurrentChar();">åˆªé™¤</button></div>
        `;
        document.getElementById('eventContainer').appendChild(div);
    }

    /* ========= åˆ—è¡¨æ¸²æŸ“ ========= */
    function renderCharList(store) {
        const list = document.getElementById('charList');
        list.innerHTML = '';
        Object.entries(store.chars).forEach(([id, item]) => {
            const btn = document.createElement('button');
            btn.className = (id === store.currentId) ? 'button-mini' : 'button-secondary';
            if(id === store.currentId) { btn.style.background = 'var(--focus-color)'; btn.style.color='#fff'; }
            btn.textContent = item.meta.name;
            btn.onclick = () => { store.currentId = id; setStore(store); fillFormFromData(item.data); renderCharList(store); };
            list.appendChild(btn);
        });
    }
    
    function newCharacter() {
        const store = getStore();
        store.currentId = 'char_' + Date.now();
        setStore(store);
        // æ¸…ç©ºç•«é¢
        document.querySelectorAll('input:not([type=hidden]), textarea').forEach(el => el.value = '');
        document.getElementById('extraContainer').innerHTML = '';
        document.getElementById('eventContainer').innerHTML = '';
        document.getElementById('charTags').value = ''; // æ¸…ç©ºæ¨™ç±¤
        initTagInput();
        saveCurrentChar();
        showToast("å·²å»ºç«‹æ–°è§’è‰² âœ¨");
    }
    
    function deleteCurrentChar() {
        const store = getStore();
        if(store.currentId && confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
            delete store.chars[store.currentId];
            store.currentId = Object.keys(store.chars)[0] || null;
            setStore(store);
            location.reload(); // ç°¡å–®æš´åŠ›é‡æ•´
        }
    }
    
    /* ========= è‡ªå‹•å„²å­˜ç›£è½ ========= */
    function setupAutoSave() {
        document.body.addEventListener('input', (e) => {
            if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                saveCurrentChar();
                updateProgress();
            }
        });
        document.body.addEventListener('change', (e) => {
            if(e.target.tagName === 'SELECT') {
                saveCurrentChar();
                updateProgress();
            }
        });
    }

    /* ========= Markdown ç”Ÿæˆ ========= */
    function generateMarkdown() {
      saveCurrentChar();
      const d = getStore().chars[getStore().currentId].data.fields;
      const extras = getStore().chars[getStore().currentId].data.extras;
      const events = getStore().chars[getStore().currentId].data.events;
      
      let md = `# è§’è‰²è¨­å®šï¼š${d.charName}\n\n## åŸºæœ¬æª”æ¡ˆ\n`;
      md += `- å¹´é½¡ï¼š${d.charAge}\n- è·æ¥­ï¼š${d.charJob}\n- æ€§åˆ¥ï¼š${d.gender}\n- ç°¡ä»‹ï¼š${d.charQuote}\n\n`;
      
      md += `## æ ¸å¿ƒè¨­å®š\n### å¤–è²Œèˆ‡è©³æƒ…\n${d.charDesc}\n\n### æ€§æ ¼ç‰¹è³ª\n${d.personality}\n\n### èªªè©±é¢¨æ ¼\n${d.speechStyle}\n\n`;
      
      md += `## ä¸–ç•Œè§€\n${d.basicInfo}\n\n`;
      
      if(extras.length) {
          md += `## é™„åŠ è¨­å®š\n`;
          extras.forEach((ex, i) => md += `### ${ex.title || `é …ç›® ${i+1}`}\n${ex.text}\n\n`);
      }
      
      if(events.length) {
          md += `## é—œéµäº‹ä»¶\n`;
          events.forEach((ev, i) => md += `### ${ev.title || `äº‹ä»¶ ${i+1}`}\n${ev.text}\n\n`);
      }
      
      if(d.firstScene) md += `## é–‹å ´æƒ…å¢ƒ\n${d.firstScene}\n\n`;
      if(d.sampleDialogue) md += `## å°è©±ç¯„ä¾‹\n${d.sampleDialogue}\n\n`;
      
      document.getElementById('output').textContent = md;
      scrollToSection('sec-output');
      showToast("Markdown å·²ç”Ÿæˆï¼");
    }

    /* ========= åŒ¯å‡ºåŒ¯å…¥ ========= */
    function exportAllData() {
        const blob = new Blob([localStorage.getItem(STORAGE_KEY)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `qing_backup_${Date.now()}.json`;
        a.click(); showToast("å‚™ä»½å·²ä¸‹è¼‰ ğŸ“¦");
    }
    
    function importAllData() {
        const file = document.getElementById('allFile').files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                JSON.parse(e.target.result); // æ¸¬è©¦æ ¼å¼
                localStorage.setItem(STORAGE_KEY, e.target.result);
                location.reload();
            } catch(err) { showToast("æª”æ¡ˆæ ¼å¼éŒ¯èª¤", "error"); }
        };
        reader.readAsText(file);
    }
    
    function downloadTxt() {
        generateMarkdown();
        const txt = document.getElementById('output').textContent;
        const blob = new Blob([txt], {type: 'text/plain'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `${document.getElementById('charName').value}_setting.txt`;
        a.click();
    }

    function clearOne(id) {
        document.getElementById(id).value = '';
        saveCurrentChar();
        updateChatPreview();
    }

    /* ========= å›åˆ°é é¦– ========= */
    function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
    window.addEventListener('scroll', () => {
      const btn = document.getElementById('backToTopBtn');
      if (window.scrollY > 300) btn.classList.add('show'); else btn.classList.remove('show');
    });
  </script>
</body>
</html>
