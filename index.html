<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿å¿æˆ‘æˆ‘å‰µè§’å°å¹«æ‰‹ (éŠæˆ²ç‰ˆ)</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap">
  <style>
    :root {
      /* === æ ¸å¿ƒè®Šæ•¸ === */
      --radius-sm: 8px;
      --radius-md: 16px;
      --radius-lg: 24px;
      --radius-full: 999px;
      
      --shadow-xs: 0 2px 4px rgba(0,0,0,0.03);
      --shadow-sm: 0 6px 16px rgba(0,0,0,0.06);
      --shadow-md: 0 12px 32px -8px rgba(0,0,0,0.1);
      --shadow-float: 0 20px 50px -12px rgba(var(--focus-rgb), 0.2);
      
      --transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      
      /* èƒŒæ™¯è‰²ç³»å®šç¾© */
      --bg-pink: #fff5f9; --accent-pink: #ff80b0; --focus-rgb-pink: 255, 128, 176;
      --bg-cream: #fffbf0; --accent-cream: #ffad6b; --focus-rgb-cream: 255, 173, 107;
      --bg-mint: #f2fffa; --accent-mint: #4cd9a4; --focus-rgb-mint: 76, 217, 164;
      --bg-lavender: #fcfaff; --accent-lavender: #b185ff; --focus-rgb-lavender: 177, 133, 255;
      --bg-sky: #f5fbff; --accent-sky: #6ab0ff; --focus-rgb-sky: 106, 176, 255;
      --bg-lemon: #fffff5; --accent-lemon: #facc15; --focus-rgb-lemon: 250, 204, 21;
      --bg-grey: #f9fafb; --accent-grey: #8d99ae; --focus-rgb-grey: 141, 153, 174;
      --bg-black: #18181b; --accent-black: #71717a; --focus-rgb-black: 113, 113, 122;

      /* é è¨­è®Šæ•¸ */
      --page-bg: var(--bg-pink);
      --card-bg: rgba(255, 255, 255, 0.9);
      --sidebar-bg: rgba(255, 255, 255, 0.85);
      --text-main: #334155;
      --text-sub: #64748b;
      --border-color: rgba(0,0,0,0.08);
      --focus-color: var(--accent-pink);
      --focus-rgb: var(--focus-rgb-pink);
      --btn-bg: var(--accent-pink);
      --btn-text: #fff;
      
      /* èŠå¤©å®¤ */
      --chat-bg: #20232a;
      --chat-bubble-sys: #3a3f4b;
      --chat-bubble-user: var(--btn-bg);
      --chat-text: #e0e0e0;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: "Noto Sans TC", system-ui, -apple-system, sans-serif;
      line-height: 1.75;
      color: var(--text-main);
      background-color: var(--page-bg);
      background-image: 
        radial-gradient(at 0% 0%, rgba(var(--focus-rgb), 0.1) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(var(--focus-rgb), 0.05) 0px, transparent 50%);
      background-attachment: fixed;
      transition: background 0.5s ease;
      min-height: 100vh;
      padding-bottom: 100px;
    }

    /* === ä¸»é¡Œè‰² === */
    body.theme-pink { --page-bg: var(--bg-pink); --focus-color: #ff80b0; --focus-rgb: var(--focus-rgb-pink); --btn-bg: #ff80b0; }
    body.theme-cream { --page-bg: var(--bg-cream); --focus-color: #ffad6b; --focus-rgb: var(--focus-rgb-cream); --btn-bg: #ffad6b; }
    body.theme-mint { --page-bg: var(--bg-mint); --focus-color: #4cd9a4; --focus-rgb: var(--focus-rgb-mint); --btn-bg: #4cd9a4; }
    body.theme-lavender { --page-bg: var(--bg-lavender); --focus-color: #b185ff; --focus-rgb: var(--focus-rgb-lavender); --btn-bg: #b185ff; }
    body.theme-sky { --page-bg: var(--bg-sky); --focus-color: #6ab0ff; --focus-rgb: var(--focus-rgb-sky); --btn-bg: #6ab0ff; }
    body.theme-lemon { --page-bg: var(--bg-lemon); --focus-color: #facc15; --focus-rgb: var(--focus-rgb-lemon); --btn-bg: #facc15; --btn-text: #5c4e00; }
    body.theme-grey { --page-bg: var(--bg-grey); --focus-color: #8d99ae; --focus-rgb: var(--focus-rgb-grey); --btn-bg: #8d99ae; }
    body.theme-black { 
      --page-bg: var(--bg-black); 
      --card-bg: rgba(39, 39, 42, 0.95);
      --sidebar-bg: rgba(39, 39, 42, 0.9);
      --text-main: #f4f4f5;
      --text-sub: #a1a1aa;
      --border-color: rgba(255,255,255,0.1);
      --focus-color: #a1a1aa;
      --focus-rgb: 161, 161, 170;
      --btn-bg: #52525b;
      --btn-text: #fff;
    }

    /* === é€²åº¦æ¢ === */
    .progress-header {
      position: sticky; top: 0; z-index: 999;
      background: rgba(255,255,255,0.9); backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border-color); padding: 10px 20px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.02);
    }
    body.theme-black .progress-header { background: rgba(24, 24, 27, 0.9); }
    .progress-container { width: 100%; max-width: 800px; display: flex; align-items: center; gap: 12px; }
    .progress-label { font-size: 0.8rem; font-weight: 700; color: var(--focus-color); white-space: nowrap; }
    .progress-track { flex: 1; height: 6px; background: rgba(0,0,0,0.05); border-radius: 99px; overflow: hidden; }
    body.theme-black .progress-track { background: rgba(255,255,255,0.1); }
    .progress-bar {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, var(--focus-color), #ffffff80);
      background-size: 200% 100%; border-radius: 99px; transition: width 0.6s ease;
    }

    /* === ä½ˆå±€ === */
    .layout-shell { display: flex; align-items: flex-start; gap: 32px; max-width: 1120px; margin: 30px auto; padding: 0 20px; position: relative; }
    .main-area { flex: 1; min-width: 0; }

    /* === å´é‚Šæ¬„ === */
    .sidebar {
      flex: 0 0 250px; width: 250px; position: sticky; top: 70px;
      background: var(--sidebar-bg); backdrop-filter: blur(20px);
      padding: 16px; border-radius: var(--radius-lg); border: 1px solid var(--border-color);
      overflow: hidden; transition: var(--transition); z-index: 50;
      box-shadow: var(--shadow-sm);
    }
    .sidebar.is-collapsed { flex: 0 0 72px; width: 72px; padding: 16px 10px; }
    .sidebar.is-collapsed .sidebar-title, .sidebar.is-collapsed .sidebar-sub { display: none; }
    .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); }
    .sidebar.is-collapsed .sidebar-header { justify-content: center; }
    .sidebar-title { font-weight: 700; color: var(--text-main); font-size: 1rem; }
    .sidebar-sub { font-size: 0.75rem; color: var(--text-sub); opacity: 0.8; }
    .sidebar-nav { display: flex; flex-direction: column; gap: 6px; }
    .sidebar-nav button {
      width: 100%; text-align: left; background: transparent; color: var(--text-main);
      border: none; padding: 10px 12px; border-radius: var(--radius-md);
      transition: var(--transition); display: flex; align-items: center; font-size: 0.9rem;
    }
    .sidebar-nav button:hover { background: rgba(var(--focus-rgb), 0.1); color: var(--focus-color); transform: translateX(4px); }
    .sidebar.is-collapsed .sidebar-nav button { justify-content: center; padding: 10px 0; }
    .sidebar.is-collapsed .sidebar-nav button span.btn-icon { margin: 0; font-size: 1.3rem; }
    .sidebar-nav button span.btn-icon { margin-right: 10px; width: 24px; text-align: center; font-size: 1.1rem; }

    /* === å¡ç‰‡å€å¡Š === */
    .section {
      background: var(--card-bg); backdrop-filter: blur(24px);
      border-radius: var(--radius-lg); padding: 32px; margin-bottom: 24px;
      box-shadow: var(--shadow-sm); border: 1px solid rgba(255,255,255,0.6);
      transition: var(--transition);
    }
    body.theme-black .section { border-color: rgba(255,255,255,0.08); box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .section:hover { box-shadow: var(--shadow-float); transform: translateY(-4px); border-color: rgba(var(--focus-rgb), 0.3); }
    .section.collapsed { padding-bottom: 24px; opacity: 0.7; transform: none; box-shadow: none; }
    .section.collapsed .section-body { display: none; }
    .section-body { margin-top: 24px; animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    h2 { font-size: 1.2rem; display: flex; align-items: center; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); margin: 0; color: var(--text-main); font-weight: 700; }

    /* === è¼¸å…¥æ¡† === */
    .label-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; flex-wrap: wrap; }
    label { font-weight: 600; color: var(--text-main); margin-right: 8px; font-size: 0.9rem; opacity: 0.9; }
    input[type="text"], input[type="search"], input[type="date"], select, textarea {
      width: 100%; padding: 12px 16px; font-size: 1rem; font-family: inherit; color: var(--text-main);
      background: rgba(255,255,255,0.5); border: 1px solid var(--border-color); border-radius: var(--radius-md);
      transition: var(--transition); margin-bottom: 0; outline: none;
    }
    body.theme-black input, body.theme-black select, body.theme-black textarea { background: rgba(0,0,0,0.2); }
    textarea { min-height: 120px; line-height: 1.7; resize: vertical; }
    input:focus, select:focus, textarea:focus { background: #fff; border-color: var(--focus-color); box-shadow: 0 0 0 4px rgba(var(--focus-rgb), 0.15); }
    body.theme-black input:focus, body.theme-black textarea:focus { background: rgba(30,30,35,0.8); }

    /* === æ¨™ç±¤è¼¸å…¥ === */
    .tags-container {
      display: flex; flex-wrap: wrap; gap: 8px; padding: 8px;
      background: rgba(255,255,255,0.5); border: 1px solid var(--border-color); border-radius: var(--radius-md);
      min-height: 50px; transition: var(--transition); cursor: text; margin-bottom: 20px;
    }
    body.theme-black .tags-container { background: rgba(0,0,0,0.2); }
    .tags-container:focus-within { background: #fff; border-color: var(--focus-color); box-shadow: 0 0 0 4px rgba(var(--focus-rgb), 0.15); }
    body.theme-black .tags-container:focus-within { background: rgba(30,30,35,0.8); }
    .tag-pill { background: var(--focus-color); color: #fff; padding: 4px 12px; border-radius: 99px; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; animation: popIn 0.3s; }
    .tag-remove { cursor: pointer; font-weight: bold; opacity: 0.8; }
    .tags-input { flex: 1; border: none; background: transparent; padding: 4px; font-size: 1rem; outline: none; min-width: 100px; margin: 0 !important; box-shadow: none !important; }
    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    /* === æŒ‰éˆ• === */
    button {
      cursor: pointer; border: none; border-radius: var(--radius-full); padding: 10px 24px; font-size: 0.95rem;
      font-family: inherit; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;
      background: var(--btn-bg); color: var(--btn-text);
      box-shadow: 0 4px 12px rgba(var(--focus-rgb), 0.25);
      transition: var(--transition); margin-right: 8px; margin-bottom: 8px;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(var(--focus-rgb), 0.35); filter: brightness(1.05); }
    button:active { transform: translateY(0); }
    .button-secondary, .button-mini { background: transparent; color: var(--text-main); border: 1px solid var(--border-color); box-shadow: none; }
    .button-secondary:hover, .button-mini:hover { background: rgba(255,255,255,0.6); color: var(--focus-color); border-color: var(--focus-color); }
    body.theme-black .button-secondary:hover { background: rgba(255,255,255,0.1); }
    .button-mini { padding: 4px 14px; font-size: 0.8rem; border-radius: 12px; }
    .sidebar-toggle-btn { width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; background: transparent; border-radius: 50%; border: 1px solid var(--border-color); color: var(--text-sub); }

    /* === æ¨™é¡Œèˆ‡æ¨™èª === */
    .top-bar { max-width: 1120px; margin: 30px auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 20px; }
    h1 { 
      font-family: "Noto Serif TC", serif; font-size: 2.2rem; margin: 0 0 8px 0; font-weight: 700; 
      background: linear-gradient(120deg, var(--text-main) 0%, var(--focus-color) 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .tagline { color: var(--text-sub); font-size: 1rem; }

    /* === éŠæˆ²ç®¡ç†å°ˆç”¨æ¨£å¼ === */
    .tabs-header {
      display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px;
    }
    .tab-btn {
      background: transparent; border: none; padding: 8px 16px; font-size: 0.9rem; color: var(--text-sub); cursor: pointer; border-radius: 8px 8px 0 0; margin: 0; box-shadow: none;
      transition: var(--transition); flex-shrink: 0; position: relative;
    }
    .tab-btn.active { color: var(--focus-color); background: rgba(var(--focus-rgb), 0.08); font-weight: bold; }
    .tab-btn.active::after {
      content: ''; position: absolute; bottom: -5px; left: 0; width: 100%; height: 2px; background: var(--focus-color);
    }
    .story-stage-content { display: none; animation: fadeIn 0.3s ease; }
    .story-stage-content.active { display: block; }
    
    .option-card {
      background: rgba(255,255,255,0.5); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; margin-top: 12px;
      position: relative; transition: var(--transition);
    }
    body.theme-black .option-card { background: rgba(0,0,0,0.2); }
    .option-card:hover { border-color: var(--focus-color); }
    .option-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-sub); font-weight: bold; }

    /* === è¼”åŠ©æ¨£å¼ === */
    .field-utils { display: flex; justify-content: space-between; align-items: center; padding: 4px 8px; margin-top: 0; margin-bottom: 20px; font-size: 0.8rem; color: var(--text-sub); }
    .field-counter.limit-reach { color: #ef4444; font-weight: bold; }
    .field-copy { font-size: 0.75rem; padding: 2px 10px; border-radius: 6px; }

    #output { background: #1e1e1e; color: #e5e5e5; padding: 24px; border-radius: var(--radius-md); font-family: "Menlo", monospace; font-size: 0.9rem; white-space: pre-wrap; line-height: 1.7; box-shadow: inset 0 2px 10px rgba(0,0,0,0.5); margin-top: 20px; border: 1px solid #333; }
    
    .chat-container { background: var(--chat-bg); border-radius: 28px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); max-width: 420px; margin: 20px auto; box-shadow: 0 20px 60px -10px rgba(0,0,0,0.5); }
    .chat-header { background: rgba(255,255,255,0.05); padding: 16px; text-align: center; color: #fff; font-weight: 600; border-bottom: 1px solid #333; font-size: 1rem; }
    .chat-body { padding: 24px 16px; display: flex; flex-direction: column; gap: 20px; min-height: 320px; }
    .msg-system { color: #9ca3af; font-size: 0.8rem; text-align: center; background: rgba(255,255,255,0.08); padding: 6px 14px; border-radius: 99px; align-self: center; max-width: 90%; }
    .msg-row { display: flex; gap: 10px; align-items: flex-start; }
    .msg-avatar { width: 42px; height: 42px; background: #4b5563; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; flex-shrink: 0; font-weight: bold; font-size: 1.1rem; }
    .msg-bubble { background: var(--chat-bubble-sys); color: var(--chat-text); padding: 12px 18px; border-radius: 4px 20px 20px 20px; font-size: 0.95rem; max-width: 85%; }

    /* Toast */
    .toast-container { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 12px; pointer-events: none; }
    .toast { background: rgba(20, 20, 20, 0.9); color: #fff; padding: 12px 24px; border-radius: 50px; font-size: 0.95rem; font-weight: 500; box-shadow: 0 10px 40px rgba(0,0,0,0.3); backdrop-filter: blur(12px); animation: toastIn 0.4s forwards; pointer-events: auto; display: flex; align-items: center; gap: 10px; border: 1px solid rgba(255,255,255,0.1); }
    .toast.fade-out { animation: toastOut 0.3s forwards; }
    @keyframes toastIn { from { opacity: 0; transform: translateY(30px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes toastOut { to { opacity: 0; transform: translateY(10px); } }

    #backToTopBtn { position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; border-radius: 50%; background: var(--btn-bg); color: #fff; font-size: 1.5rem; box-shadow: 0 8px 24px rgba(var(--focus-rgb), 0.35); z-index: 999; opacity: 0; visibility: hidden; transform: translateY(20px); transition: all 0.4s; display: flex; align-items: center; justify-content: center; padding: 0; margin: 0; }
    #backToTopBtn.show { opacity: 1; visibility: visible; transform: translateY(0); }
    #backToTopBtn:hover { transform: translateY(-4px) scale(1.1); }

    /* RWD */
    @media (max-width: 850px) {
      .layout-shell { flex-direction: column; gap: 20px; margin: 20px auto; padding: 0 16px; }
      .sidebar { width: 100%; position: static; margin-bottom: 0; padding: 12px; z-index: 1; }
      .sidebar-header, .sidebar-sub, .sidebar-toggle-btn { display: none; }
      .sidebar-nav { flex-direction: row; overflow-x: auto; gap: 8px; padding-bottom: 4px; scrollbar-width: none; }
      .sidebar-nav button { width: auto; white-space: nowrap; padding: 8px 16px; border-radius: 99px; border: 1px solid var(--border-color); background: rgba(255,255,255,0.6); }
      .section { padding: 24px; }
    }
    body.layout-mobile { max-width: 600px !important; margin: 0 auto !important; padding: 0 0 100px !important; }
    body.layout-mobile .layout-shell { flex-direction: column; gap: 16px; margin-top: 10px; padding: 0 12px; }
    body.layout-mobile .sidebar { width: 100%; position: sticky; top: 50px; z-index: 100; padding: 8px 4px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: visible !important; transition: none !important; }
    body.layout-mobile .sidebar-nav { display: flex; flex-direction: row; overflow-x: auto; gap: 6px; padding: 2px 4px; -ms-overflow-style: none; scrollbar-width: none; }
    body.layout-mobile .sidebar-nav button { flex: 0 0 auto; width: auto; white-space: nowrap; padding: 8px 16px; font-size: 0.9rem; border-radius: 99px; }
    body.layout-mobile .sidebar-nav button:hover, body.layout-mobile .sidebar-nav button:active { background: var(--focus-color); color: #fff; border-color: var(--focus-color); transform: none; }
  </style>
</head>
<body class="theme-pink layout-desktop">

  <div class="progress-header">
    <div class="progress-container">
      <div class="progress-label">è¨­å®šå®Œæˆåº¦ <span id="progressText">0%</span></div>
      <div class="progress-track"><div class="progress-bar" id="progressBar"></div></div>
    </div>
  </div>
  <div class="toast-container" id="toastContainer"></div>

  <div class="top-bar">
    <div>
      <h1>ğŸ’• å¿å¿æˆ‘æˆ‘å‰µè§’å°å¹«æ‰‹</h1>
      <div class="tagline">å¡«å¯«è¨­å®šï¼Œä¸€éµç”Ÿæˆ AI è§’è‰²å¡èˆ‡éŠæˆ²è…³æœ¬ã€‚</div>
    </div>
    <div class="theme-select">
      <select onchange="changeTheme(this.value)" style="width:auto; display:inline-block; padding:8px 14px; border-radius:12px; cursor:pointer;">
        <option value="pink" selected>ğŸŒ¸ æ«»èŠ±ç²‰</option>
        <option value="cream">ğŸ å¥¶æ²¹ç™½</option>
        <option value="mint">ğŸŒ¿ è–„è·ç¶ </option>
        <option value="lavender">ğŸ”® è–°è¡£è‰</option>
        <option value="sky">â˜ï¸ å¤©ç©ºè—</option>
        <option value="lemon">ğŸ‹ æª¸æª¬é»ƒ</option>
        <option value="grey">ğŸŒ«ï¸ æ¥µç°¡ç°</option>
        <option value="black">ğŸŒ™ æ·±å¤œé»‘</option>
      </select>
    </div>
  </div>

  <div class="layout-shell">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">ğŸ“ åŠŸèƒ½å°èˆª</div>
        <button type="button" class="sidebar-toggle-btn" onclick="toggleSidebar()">â—€</button>
      </div>
      <div class="sidebar-sub">é»æ“Šå¿«é€Ÿè·³è½‰</div>
      <nav class="sidebar-nav">
        <button type="button" class="sidebar-main" onclick="scrollToSection('sec-archive')"><span class="btn-icon">ğŸ“‚</span>è§’è‰²å­˜æª”</button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-info')"><span class="btn-icon">ğŸ’â€â™€ï¸</span>è§’è‰²è³‡è¨Š</button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-basic')"><span class="btn-icon">ğŸŒ</span>åŸºæœ¬è³‡è¨Š</button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-personality')"><span class="btn-icon">ğŸ’—</span>æ€§æ ¼ç‰¹è³ª</button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-speech')"><span class="btn-icon">ğŸ—£ï¸</span>èªªè©±é¢¨æ ¼</button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-prompt')"><span class="btn-icon">ğŸ§ </span>Prompt</button>
        <button type="button" class="sidebar-main" onclick="scrollToSection('sec-game-mgr')"><span class="btn-icon">ğŸ®</span>éŠæˆ²ç®¡ç†</button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-first')"><span class="btn-icon">ğŸ¬</span>é–‹å ´å°è©±</button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-fav')"><span class="btn-icon">ğŸ€</span>å–œå¥½ç”Ÿæ—¥</button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-output')"><span class="btn-icon">ğŸ“</span>è¼¸å‡ºé è¦½</button>
        <button type="button" class="sidebar-main" onclick="scrollToSection('sec-layout')"><span class="btn-icon">ğŸ“±</span>ç‰ˆé¢åˆ‡æ›</button>
      </nav>
    </aside>

    <main class="main-area">

      <!-- å­˜æª”å€ -->
      <div class="section" id="sec-archive">
        <h2><span>ğŸ“‚ è§’è‰²å­˜æª”</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-archive')">â‡•</button></h2>
        <div class="section-body">
          <div class="label-row">
             <div style="flex:1; margin-right:12px;">
              <select id="filterCategory" onchange="refreshCharListFromStorage()"><option value="">å…¨éƒ¨åˆ†é¡</option></select>
            </div>
            <div style="flex:1;">
              <input id="searchName" type="search" placeholder="æœå°‹è§’è‰²..." oninput="refreshCharListFromStorage()" />
            </div>
          </div>
          <div id="charList" style="margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; min-height:40px;"></div>
          <div style="margin-top:20px; padding-top:20px; border-top:1px dashed var(--border-color); display:flex; gap:10px;">
            <button type="button" onclick="newCharacter()">â• æ–°è§’è‰²</button>
            <button type="button" onclick="saveCurrentChar()">ğŸ’¾ å„²å­˜</button>
            <button type="button" class="button-secondary" onclick="deleteCurrentChar()" style="margin-left:auto;">ğŸ—‘ åˆªé™¤</button>
          </div>
        </div>
      </div>

      <!-- è§’è‰²è³‡è¨Š -->
      <div class="section" id="sec-info">
        <h2><span>ğŸ’â€â™€ï¸ è§’è‰²è³‡è¨Š</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-info')">â‡•</button></h2>
        <div class="section-body">
          <div class="label-row"><label>è§’è‰²åç¨± * (15å­—)</label><button type="button" class="button-mini" onclick="clearOne('charName')">æ¸…ç©º</button></div>
          <input id="charName" type="text" data-maxlength="15" placeholder="ä¾‹å¦‚ï¼šæ—æœˆå¦‚" oninput="updateChatPreview()" />

          <div class="label-row">
             <div style="flex:1; margin-right:16px;">
               <label>å¹´é½¡ (15å­—)</label><input id="charAge" type="text" data-maxlength="15" placeholder="18æ­²" />
            </div>
            <div style="flex:1;">
               <label>è·æ¥­ (15å­—)</label><input id="charJob" type="text" data-maxlength="15" placeholder="å­¸ç”Ÿ" />
            </div>
          </div>
          <div class="label-row"><label>è§’è‰²åˆ†é¡</label></div>
          <input id="charCategory" type="text" placeholder="ç¾ä»£ã€å¥‡å¹»..." />

          <div class="label-row"><label>ä¸€å¥è©±ä»‹ç´¹ * (80å­—)</label></div>
          <textarea id="charQuote" data-maxlength="80" style="min-height:80px;" placeholder="é¡¯ç¤ºåœ¨åˆ—è¡¨çš„çŸ­ä»‹ç´¹"></textarea>

          <div class="label-row"><label>æ•˜è¿° (700å­—)</label></div>
          <textarea id="charDesc" data-maxlength="700" placeholder="è§’è‰²çš„å¤–è²Œã€æ°£è³ªç­‰è©³ç´°æå¯«"></textarea>

          <div class="label-row"><label>æ¨™ç±¤</label></div>
          <div class="tags-container" id="tagsContainer" onclick="document.getElementById('tagInput').focus()">
            <input type="text" id="tagInput" class="tags-input" placeholder="è¼¸å…¥æ¨™ç±¤æŒ‰ Enter..." />
          </div>
          <input type="hidden" id="charTags" />
          
          <div class="label-row"><label>å‰µä½œè€…ç­†è¨˜ (200å­—)</label></div>
          <textarea id="creatorNote" data-maxlength="200" style="min-height:80px;"></textarea>
        </div>
      </div>
      
      <div class="section" id="sec-gender">
         <h2><span>ğŸš» æ€§åˆ¥</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-gender')">â‡•</button></h2>
        <div class="section-body">
          <select id="gender"><option value="æœªè¨­ç½®" selected>æœªè¨­ç½®</option><option value="ç”·æ€§">ç”·æ€§</option><option value="å¥³æ€§">å¥³æ€§</option><option value="ç„¡æ€§åˆ¥">ç„¡æ€§åˆ¥</option></select>
        </div>
      </div>

      <!-- æ ¸å¿ƒè¨­å®š -->
      <div class="section" id="sec-basic">
        <h2><span>ğŸŒ åŸºæœ¬è³‡è¨Š (700å­—)</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-basic')">â‡•</button></h2>
        <div class="section-body">
           <div class="label-row" style="justify-content:flex-end;"><button type="button" class="button-mini" onclick="saveTemplateFromField('basicInfo','basicInfo')">å­˜ç‚ºæ¨¡æ¿</button></div>
          <textarea id="basicInfo" data-maxlength="700" placeholder="å¿…å¡«ã€‚ä¸–ç•Œè§€ã€èƒŒæ™¯æ•…äº‹..."></textarea>
        </div>
      </div>

      <div class="section" id="sec-personality">
        <h2><span>ğŸ’— æ€§æ ¼ç‰¹è³ª (700å­—)</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-personality')">â‡•</button></h2>
        <div class="section-body">
          <div class="label-row" style="justify-content:flex-end;"><button type="button" class="button-mini" onclick="saveTemplateFromField('personality','personality')">å­˜ç‚ºæ¨¡æ¿</button></div>
          <textarea id="personality" data-maxlength="700" placeholder="å¿…å¡«ã€‚å…§åœ¨æ€§æ ¼ã€å°ç©å®¶çš„æ…‹åº¦..."></textarea>
        </div>
      </div>
      
      <div class="section" id="sec-speech">
        <h2><span>ğŸ—£ï¸ èªªè©±é¢¨æ ¼ (700å­—)</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-speech')">â‡•</button></h2>
        <div class="section-body">
          <div class="label-row" style="justify-content:flex-end;"><button type="button" class="button-mini" onclick="saveTemplateFromField('speechStyle','speechStyle')">å­˜ç‚ºæ¨¡æ¿</button></div>
          <textarea id="speechStyle" data-maxlength="700" placeholder="å¿…å¡«ã€‚å£é ­ç¦ªã€èªæ°£..."></textarea>
        </div>
      </div>
      
      <div class="section" id="sec-prompt">
        <h2><span>ğŸ§  Prompt å„ªåŒ–</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-prompt')">â‡•</button></h2>
        <div class="section-body">
          <div class="label-row"><label>ä½¿ç”¨æ¨¡å‹</label></div>
          <select id="modelType"><option value="gemini-3">Gemini 3</option><option value="claude-sonnet">Claude Sonnet</option><option value="claude-Haiku">Claude Haiku</option></select>
          <div class="label-row" style="margin-top:16px;"><label>System Role</label></div>
          <textarea id="promptRole" placeholder="ç³»çµ±æŒ‡ä»¤..."></textarea>
          <div class="label-row"><label>Response Guideline</label></div>
          <textarea id="promptGuideline" placeholder="å›æ‡‰è¦å‰‡..."></textarea>
          <div style="background:rgba(0,0,0,0.03); padding:12px; border-radius:12px; margin-top:16px;">
            <div id="promptTokenInfo" style="font-size:0.8rem; color:var(--text-sub);"></div>
          </div>
        </div>
      </div>

      <!-- éŠæˆ²ç®¡ç† (New) -->
      <div class="section" id="sec-game-mgr">
        <h2><span>ğŸ® éŠæˆ²ç®¡ç†</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-game-mgr')">â‡•</button></h2>
        <div class="section-body">
          <!-- 1. åŸºæœ¬è³‡è¨Š -->
          <h3 style="font-size:1rem; border-left:4px solid var(--focus-color); padding-left:10px; margin-bottom:16px;">1. éŠæˆ²ä»‹ç´¹</h3>
          <div class="label-row"><label>éŠæˆ²æ¨™é¡Œ (30å­—)</label></div>
          <input id="gameTitle" type="text" data-maxlength="30" placeholder="è¼¸å…¥éŠæˆ²æ¨™é¡Œ..." oninput="saveCurrentChar()" />
          <div class="label-row"><label>éŠæˆ²ä»‹ç´¹ (30å­—)</label></div>
          <textarea id="gameIntro" data-maxlength="30" style="min-height:60px;" placeholder="ç°¡çŸ­ä»‹ç´¹..." oninput="saveCurrentChar()"></textarea>

          <!-- 2. ç§å¯†ç‰©èª -->
          <h3 style="font-size:1rem; border-left:4px solid var(--focus-color); padding-left:10px; margin:30px 0 16px 0;">2. ç§å¯†ç‰©èª</h3>
          
          <!-- éšæ®µåˆ‡æ› Tabs -->
          <div class="tabs-header">
            <button type="button" class="tab-btn active" onclick="switchStoryTab(0)">ç†Ÿäºº</button>
            <button type="button" class="tab-btn" onclick="switchStoryTab(1)">æœ‹å‹</button>
            <button type="button" class="tab-btn" onclick="switchStoryTab(2)">å¿ƒå‹•</button>
            <button type="button" class="tab-btn" onclick="switchStoryTab(3)">æˆ€äºº</button>
            <button type="button" class="tab-btn" onclick="switchStoryTab(4)">çµå©š</button>
          </div>

          <!-- æ•…äº‹ç·¨è¼¯å€å¡Š (5å€‹å°æ‡‰) -->
          <div id="story-container">
            <!-- JS æœƒå‹•æ…‹ç”Ÿæˆ 5 å€‹éšæ®µçš„ç·¨è¼¯å™¨ -->
          </div>

          <!-- 3. ç™¼ä½ˆè¨­å®š -->
          <h3 style="font-size:1rem; border-left:4px solid var(--focus-color); padding-left:10px; margin:30px 0 16px 0;">3. ç™¼ä½ˆè¨­å®š</h3>
          <div class="label-row" style="align-items:center;">
            <div style="flex:1; margin-right:16px;">
              <label>ä½¿ç”¨ç­‰ç´š</label>
              <select id="gameAgeRating" onchange="saveCurrentChar()">
                <option value="all">æ‰€æœ‰å¹´é½¡å±¤</option>
                <option value="adult">æˆäººé™å®š (R18)</option>
              </select>
            </div>
            <div style="flex:1;">
               <label>å…¬é–‹è¨­å®š</label>
               <select id="gamePublicSetting" onchange="saveCurrentChar()">
                 <option value="free">å…è²»</option>
                 <option value="paid">ä»˜è²» (10æœé†¬)</option>
               </select>
            </div>
          </div>
        </div>
      </div>

      <div class="section" id="sec-first">
        <h2><span>ğŸ¬ é–‹å ´èˆ‡å°è©± (800å­—)</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-first')">â‡•</button></h2>
        <div class="section-body">
          <div class="label-row"><label>ç¬¬ä¸€æ¬¡èŠå¤©å ´æ™¯</label></div>
          <textarea id="firstScene" data-maxlength="800" oninput="updateChatPreview()" placeholder="è¨­å®šå ´æ™¯..."></textarea>
          <div class="label-row"><label>è§’è‰²å°è©±ç¯„ä¾‹</label></div>
          <textarea id="sampleDialogue" data-maxlength="800" oninput="updateChatPreview()" placeholder="è§’è‰²ç¬¬ä¸€å¥æœƒèªªçš„è©±..."></textarea>
        </div>
      </div>
      
      <div class="section" id="sec-fav">
        <h2><span>ğŸ€ å–œå¥½èˆ‡ç”Ÿæ—¥ (50å­—)</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-fav')">â‡•</button></h2>
        <div class="section-body">
          <input id="likes" type="text" data-maxlength="50" placeholder="å–œæ­¡çš„æ±è¥¿" />
          <input id="dislikes" type="text" data-maxlength="50" placeholder="è¨å­çš„æ±è¥¿" />
          <input id="birthday" type="date" />
        </div>
      </div>
      
      <div class="section" id="sec-extra">
        <h2><span>ğŸ“Œ é™„åŠ è³‡è¨Š (500å­—)</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-extra')">â‡•</button></h2>
        <div class="section-body"><div id="extraContainer"></div><button type="button" onclick="addExtra()">ï¼‹ æ–°å¢ä¸€ç­†</button></div>
      </div>
      
      <div class="section" id="sec-event">
        <h2><span>ğŸ“š å‰µä½œè€…äº‹ä»¶ (2000å­—)</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-event')">â‡•</button></h2>
        <div class="section-body"><div id="eventContainer"></div><button type="button" onclick="addEvent()">ï¼‹ æ–°å¢äº‹ä»¶</button></div>
      </div>

      <div class="section" id="sec-output">
        <h2><span>ğŸ“ è¼¸å‡ºèˆ‡é è¦½</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-output')">â‡•</button></h2>
        <div class="section-body">
           <div class="actions-row" style="justify-content:center; margin-bottom:30px;">
             <button onclick="generateMarkdown()" style="width:100%; padding:14px; font-size:1.1rem;">âœ¨ ç”Ÿæˆ Markdown è…³æœ¬</button>
           </div>
           <h3 style="margin-top:30px; border-left:4px solid var(--focus-color); padding-left:12px;">ğŸ’¬ æ¨¡æ“¬æ‰‹æ©Ÿå°è©±</h3>
           <div class="chat-container">
            <div class="chat-header"><span id="chatHeaderName">è§’è‰²åç¨±</span></div>
            <div class="chat-body">
              <div class="msg-system" id="previewScene">...</div>
              <div class="msg-row"><div class="msg-avatar" id="previewAvatar">A</div><div class="msg-bubble" id="previewDialogue">...</div></div>
            </div>
          </div>
          <div style="margin-top:30px; display:flex; gap:10px; flex-wrap:wrap;">
             <button class="button-secondary" type="button" onclick="downloadTxt()">â¬‡ ä¸‹è¼‰ .txt</button>
             <button class="button-secondary" type="button" onclick="exportAllData()">ğŸ“¦ å‚™ä»½å…¨éƒ¨</button>
             <label class="button-secondary" style="cursor:pointer; display:flex; align-items:center; margin:0 0 8px 0;">
                ğŸ“‚ åŒ¯å…¥å‚™ä»½<input id="allFile" type="file" accept=".json" style="display:none;" onchange="importAllData()" />
             </label>
          </div>
          <div id="output"></div>
        </div>
      </div>
      
      <div class="section" id="sec-template-center">
        <h2><span>ğŸ§° æ¨¡æ¿ç®¡ç†</span><button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-template-center')">â‡•</button></h2>
        <div class="section-body"><select id="tplFilter" onchange="renderTemplateManager()"><option value="">å…¨éƒ¨é¡å‹</option></select><div id="tplManagerList" style="margin-top:16px;"></div></div>
      </div>
      
      <div class="section" id="sec-layout">
        <h2><span>ğŸ“± ç‰ˆé¢åˆ‡æ›</span></h2>
        <div class="section-body"><div style="display:flex; gap:10px;"><button class="button-secondary" onclick="setLayout('desktop')">ğŸ’» é›»è…¦ç‰ˆ</button><button class="button-secondary" onclick="setLayout('mobile')">ğŸ“± æ‰‹æ©Ÿç‰ˆ</button></div></div>
      </div>
    </main>
  </div>

  <button type="button" id="backToTopBtn" onclick="scrollToTop()" title="å›åˆ°é é¦–">â–²</button>

  <script>
    const EXTRA_MAX = 10;
    const EVENT_MAX = 20;
    const STORAGE_KEY = 'qing_char_game_v5'; 
    const TEMPLATE_TYPES = ['basicInfo','personality','speechStyle','extra','event'];
    const TEMPLATE_TYPE_LABELS = { basicInfo: 'åŸºæœ¬è³‡è¨Š', personality: 'æ€§æ ¼', speechStyle: 'èªªè©±é¢¨æ ¼', extra: 'é™„åŠ è³‡è¨Š', event: 'å‰µä½œè€…äº‹ä»¶' };
    
    const STORY_STAGES = ['ç†Ÿäººéšæ®µ', 'æœ‹å‹éšæ®µ', 'å¿ƒå‹•éšæ®µ', 'æˆ€äººéšæ®µ', 'çµå©šéšæ®µ'];

    /* ========= åˆå§‹åŒ– ========= */
    window.addEventListener('DOMContentLoaded', () => {
      initLayoutByWidth();
      // åˆå§‹åŒ–éŠæˆ²æ•…äº‹ç·¨è¼¯å™¨ UI
      initStoryEditors();
      loadInitialFromStore();
      setupAutoSave();
      setupFieldUtils();
      initTagInput();
      updateProgress();
      
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(initLayoutByWidth, 200);
      });
    });

    /* ========= éŠæˆ²ç®¡ç†é‚è¼¯ ========= */
    function initStoryEditors() {
      const container = document.getElementById('story-container');
      container.innerHTML = '';
      
      STORY_STAGES.forEach((stage, idx) => {
        const div = document.createElement('div');
        div.className = `story-stage-content ${idx === 0 ? 'active' : ''}`;
        div.id = `story-stage-${idx}`;
        
        div.innerHTML = `
          <div class="label-row"><label>è§£é–æç¤ºèª (60å­—)</label></div>
          <input type="text" id="storyHint_${idx}" data-maxlength="60" placeholder="ä¾‹å¦‚ï¼šå¥½æ„Ÿåº¦é”åˆ°20è§£é–..." oninput="saveCurrentChar()">
          
          <div class="label-row"><label>æ•…äº‹æ¨™é¡Œ (30å­—)</label></div>
          <input type="text" id="storyTitle_${idx}" data-maxlength="30" placeholder="æ¨™é¡Œ..." oninput="saveCurrentChar()">
          
          <div class="label-row"><label>æ•…äº‹å…§å®¹ (2000å­—)</label></div>
          <textarea id="storyContent_${idx}" data-maxlength="2000" style="min-height:150px;" placeholder="æ’°å¯«åŠ‡æƒ…..." oninput="saveCurrentChar()"></textarea>
          
          <div style="margin-top:16px; padding:12px; background:rgba(0,0,0,0.03); border-radius:12px;">
             <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                <label style="margin:0;">ğŸ”€ å•Ÿç”¨å¤šé‡çµå±€</label>
                <input type="checkbox" id="storyMulti_${idx}" style="width:20px; height:20px; margin:0;" onchange="toggleOptions(${idx}); saveCurrentChar()">
             </div>
             
             <div id="optionsContainer_${idx}" style="display:none; border-top:1px dashed var(--border-color); padding-top:12px; margin-top:8px;">
                <div id="optionsList_${idx}"></div>
                <button type="button" class="button-mini" style="margin-top:8px; width:100%;" onclick="addOption(${idx})">ï¼‹ æ–°å¢é¸é …</button>
             </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function switchStoryTab(idx) {
      document.querySelectorAll('.tab-btn').forEach((b, i) => {
        if(i === idx) b.classList.add('active'); else b.classList.remove('active');
      });
      document.querySelectorAll('.story-stage-content').forEach((d, i) => {
        if(i === idx) d.classList.add('active'); else d.classList.remove('active');
      });
      // åˆ‡æ›æ™‚é‡æ–°ç¶å®šå­—æ•¸çµ±è¨ˆ
      setupFieldUtils();
    }
    
    function toggleOptions(idx) {
        const chk = document.getElementById(`storyMulti_${idx}`);
        const con = document.getElementById(`optionsContainer_${idx}`);
        con.style.display = chk.checked ? 'block' : 'none';
    }
    
    function addOption(stageIdx, data = null) {
       const list = document.getElementById(`optionsList_${stageIdx}`);
       const optDiv = document.createElement('div');
       optDiv.className = 'option-card';
       const id = Date.now();
       
       const text = data ? data.text : '';
       const content = data ? data.content : '';
       const score = data ? data.score : 0;

       optDiv.innerHTML = `
          <div class="option-header">é¸é …è¨­å®š <span style="cursor:pointer; color:red;" onclick="this.parentElement.parentElement.remove(); saveCurrentChar()">åˆªé™¤</span></div>
          
          <div class="label-row"><label style="font-size:0.8rem">é¸é …æ–‡å­— (100å­—)</label></div>
          <input type="text" class="opt-text" value="${text}" data-maxlength="100" placeholder="ç©å®¶çœ‹åˆ°çš„é¸é …..." oninput="saveCurrentChar()">
          
          <div class="label-row"><label style="font-size:0.8rem">é¡¯ç¤ºå…§å®¹ (500å­—)</label></div>
          <textarea class="opt-content" data-maxlength="500" style="min-height:60px;" placeholder="é¸äº†ä¹‹å¾Œç™¼ç”Ÿçš„äº‹..." oninput="saveCurrentChar()">${content}</textarea>
          
          <div class="label-row" style="margin-bottom:0; align-items:center;">
             <label style="font-size:0.8rem">å¥½æ„Ÿåº¦å¢æ¸› (-20 ~ +20)</label>
             <input type="number" class="opt-score" value="${score}" min="-20" max="20" style="width:80px;" oninput="saveCurrentChar()">
          </div>
       `;
       list.appendChild(optDiv);
       setupFieldUtils(optDiv);
       saveCurrentChar();
    }

    /* ========= å­—æ•¸çµ±è¨ˆ ========= */
    function updateFieldCounter(el) {
      let wrapper = el.nextElementSibling;
      if (!wrapper || !wrapper.classList.contains('field-utils')) return;
      const counter = wrapper.querySelector('.field-counter');
      if(!counter) return;
      const len = el.value ? el.value.length : 0;
      const max = el.getAttribute('data-maxlength') || el.dataset.maxlength;
      if(max) {
         counter.textContent = `${len} / ${max}`;
         counter.className = 'field-counter'; 
         if(len >= max) counter.classList.add('limit-reach');
      } else { counter.textContent = `${len} å­—`; }
    }

    function setupFieldUtils(scope = document) {
       const fields = scope.querySelectorAll('textarea, input[type="text"]');
       fields.forEach(el => {
           if(el.nextElementSibling && el.nextElementSibling.classList.contains('field-utils')) return;
           const wrapper = document.createElement('div'); wrapper.className = 'field-utils';
           const counter = document.createElement('span'); counter.className = 'field-counter'; counter.textContent = '0 å­—';
           const copyBtn = document.createElement('button'); copyBtn.className = 'button-mini field-copy'; copyBtn.textContent = 'è¤‡è£½'; copyBtn.onclick = () => { navigator.clipboard.writeText(el.value).then(() => showToast('å·²è¤‡è£½ï¼')); };
           wrapper.appendChild(counter); wrapper.appendChild(copyBtn);
           el.parentNode.insertBefore(wrapper, el.nextSibling);
           el.addEventListener('input', () => updateFieldCounter(el));
           updateFieldCounter(el);
       });
    }

    /* ========= å­˜å–é‚è¼¯ ========= */
    function getStore() {
       const raw = localStorage.getItem(STORAGE_KEY);
       try { return JSON.parse(raw) || { currentId: null, chars: {}, templates: {basicInfo:[], personality:[], speechStyle:[], extra:[], event:[]} }; } catch { return { currentId: null, chars: {}, templates: {basicInfo:[], personality:[], speechStyle:[], extra:[], event:[]} }; }
    }
    function setStore(s) { localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
    
    function saveCurrentChar() {
       const store = getStore();
       let id = store.currentId || ('char_' + Date.now());
       store.currentId = id;
       
       const data = { fields: {}, extras: [], events: [], game: {} };
       // 1. ä¸€èˆ¬æ¬„ä½
       document.querySelectorAll('input:not(.tags-input):not([class*="opt-"]):not([id*="story"]), textarea:not([class*="opt-"]):not([id*="story"]), select').forEach(el => {
           if(el.id) data.fields[el.id] = el.value;
       });
       data.fields['charTags'] = document.getElementById('charTags').value;

       // 2. å‹•æ…‹æ¬„ä½
       document.querySelectorAll('.extra-block').forEach(b => data.extras.push({ title: b.querySelector('.extra-title-field').value, text: b.querySelector('.extra-field').value }));
       document.querySelectorAll('.event-block').forEach(b => data.events.push({ title: b.querySelector('.event-title-field').value, text: b.querySelector('.event-field').value }));

       // 3. éŠæˆ²ç®¡ç†è³‡æ–™ scraping
       data.game = {
           title: document.getElementById('gameTitle').value,
           intro: document.getElementById('gameIntro').value,
           ageRating: document.getElementById('gameAgeRating').value,
           publicSetting: document.getElementById('gamePublicSetting').value,
           stories: []
       };
       
       STORY_STAGES.forEach((stage, idx) => {
           const storyData = {
               stage: stage,
               hint: document.getElementById(`storyHint_${idx}`).value,
               title: document.getElementById(`storyTitle_${idx}`).value,
               content: document.getElementById(`storyContent_${idx}`).value,
               multiEnding: document.getElementById(`storyMulti_${idx}`).checked,
               options: []
           };
           
           if(storyData.multiEnding) {
               const optCards = document.getElementById(`optionsList_${idx}`).querySelectorAll('.option-card');
               optCards.forEach(card => {
                   storyData.options.push({
                       text: card.querySelector('.opt-text').value,
                       content: card.querySelector('.opt-content').value,
                       score: card.querySelector('.opt-score').value
                   });
               });
           }
           data.game.stories.push(storyData);
       });

       store.chars[id] = { meta: { name: data.fields.charName || "æœªå‘½å", createdAt: Date.now() }, data: data };
       setStore(store);
       renderCharList(store);
       updateProgress();
       updatePromptTokenInfo();
    }
    
    function loadInitialFromStore() {
       const store = getStore();
       if(!store.currentId && Object.keys(store.chars).length) store.currentId = Object.keys(store.chars)[0];
       if(store.currentId && store.chars[store.currentId]) fillFormFromData(store.chars[store.currentId].data);
       renderCharList(store);
    }
    
    function fillFormFromData(data) {
        if(!data) return;
        // ä¸€èˆ¬æ¬„ä½
        for(let key in data.fields) {
            const el = document.getElementById(key);
            if(el) el.value = data.fields[key];
        }
        // å‹•æ…‹æ¬„ä½
        document.getElementById('extraContainer').innerHTML = '';
        document.getElementById('eventContainer').innerHTML = '';
        if(data.extras) data.extras.forEach(ex => addExtraWithVal(ex.title, ex.text));
        if(data.events) data.events.forEach(ev => addEventWithVal(ev.title, ev.text));
        
        // éŠæˆ²ç®¡ç†è³‡æ–™å›å¡«
        if(data.game) {
            if(document.getElementById('gameTitle')) document.getElementById('gameTitle').value = data.game.title || '';
            if(document.getElementById('gameIntro')) document.getElementById('gameIntro').value = data.game.intro || '';
            if(document.getElementById('gameAgeRating')) document.getElementById('gameAgeRating').value = data.game.ageRating || 'all';
            if(document.getElementById('gamePublicSetting')) document.getElementById('gamePublicSetting').value = data.game.publicSetting || 'free';
            
            if(data.game.stories && Array.isArray(data.game.stories)) {
                data.game.stories.forEach((s, idx) => {
                    if(idx >= 5) return;
                    document.getElementById(`storyHint_${idx}`).value = s.hint || '';
                    document.getElementById(`storyTitle_${idx}`).value = s.title || '';
                    document.getElementById(`storyContent_${idx}`).value = s.content || '';
                    document.getElementById(`storyMulti_${idx}`).checked = s.multiEnding || false;
                    toggleOptions(idx);
                    
                    const list = document.getElementById(`optionsList_${idx}`);
                    list.innerHTML = ''; // å…ˆæ¸…ç©º
                    if(s.options) s.options.forEach(opt => addOption(idx, opt));
                });
            }
        } else {
            // æ¸…ç©ºéŠæˆ²æ¬„ä½
            document.getElementById('gameTitle').value = '';
            document.getElementById('gameIntro').value = '';
            STORY_STAGES.forEach((_, idx) => {
               document.getElementById(`storyHint_${idx}`).value = '';
               document.getElementById(`storyTitle_${idx}`).value = '';
               document.getElementById(`storyContent_${idx}`).value = '';
               document.getElementById(`storyMulti_${idx}`).checked = false;
               document.getElementById(`optionsList_${idx}`).innerHTML = '';
               toggleOptions(idx);
            });
        }

        initTagInput(); updateChatPreview(); updateProgress(); updatePromptTokenInfo();
        setupFieldUtils();
    }

    /* ========= Markdown ç”Ÿæˆ ========= */
    function generateMarkdown() {
      saveCurrentChar();
      const d = getStore().chars[getStore().currentId].data.fields;
      const extras = getStore().chars[getStore().currentId].data.extras;
      const events = getStore().chars[getStore().currentId].data.events;
      const game = getStore().chars[getStore().currentId].data.game;
      
      let md = `# è§’è‰²è¨­å®šï¼š${limitText(d.charName, 15)}\n\n## åŸºæœ¬æª”æ¡ˆ\n`;
      if(d.charCategory) md += `- åˆ†é¡ï¼š${d.charCategory}\n`;
      if(d.gender) md += `- æ€§åˆ¥ï¼š${d.gender}\n`;
      if(d.charAge) md += `- å¹´é½¡ï¼š${limitText(d.charAge, 15)}\n`;
      if(d.charJob) md += `- è·æ¥­ï¼š${limitText(d.charJob, 15)}\n`;
      if(d.charTags) md += `- æ¨™ç±¤ï¼š${d.charTags}\n`;
      
      md += `\n## æ ¸å¿ƒè¨­å®š\n### ç°¡ä»‹\n${limitText(d.charQuote, 80)}\n\n### å¤–è²Œèˆ‡è©³æƒ…\n${limitText(d.charDesc, 700)}\n\n### æ€§æ ¼ç‰¹è³ª\n${limitText(d.personality, 700)}\n\n`;
      md += `## ä¸–ç•Œè§€\n${limitText(d.basicInfo, 700)}\n\n`;
      md += `## èªªè©±é¢¨æ ¼\n${limitText(d.speechStyle, 700)}\n\n`;

      if(extras.length) { md += `## é™„åŠ è¨­å®š\n`; extras.forEach((ex, i) => md += `### ${ex.title || `é …ç›® ${i+1}`}\n${limitText(ex.text, 500)}\n\n`); }
      if(events.length) { md += `## é—œéµäº‹ä»¶\n`; events.forEach((ev, i) => md += `### ${ev.title || `äº‹ä»¶ ${i+1}`}\n${limitText(ev.text, 2000)}\n\n`); }
      if(d.firstScene) md += `## é–‹å ´æƒ…å¢ƒ\n${limitText(d.firstScene, 800)}\n\n`;
      if(d.sampleDialogue) md += `## å°è©±ç¯„ä¾‹\n${limitText(d.sampleDialogue, 800)}\n\n`;
      
      // éŠæˆ²è³‡æ–™è¼¸å‡º
      if(game && game.title) {
          md += `\n---\n# éŠæˆ²è…³æœ¬è¨­å®š\n\n`;
          md += `## éŠæˆ²è³‡è¨Š\n- æ¨™é¡Œï¼š${game.title}\n- ä»‹ç´¹ï¼š${game.intro}\n- ç­‰ç´šï¼š${game.ageRating}\n- åƒ¹æ ¼ï¼š${game.publicSetting}\n\n`;
          
          if(game.stories) {
              md += `## ç§å¯†ç‰©èªè…³æœ¬\n`;
              game.stories.forEach((s) => {
                  if(!s.title && !s.content) return;
                  md += `### [${s.stage}] ${s.title}\n`;
                  md += `> è§£é–æç¤ºï¼š${s.hint}\n\n`;
                  md += `${s.content}\n\n`;
                  if(s.multiEnding && s.options.length) {
                      md += `**å¤šé‡çµå±€é¸é …ï¼š**\n`;
                      s.options.forEach((opt, k) => {
                          md += `- é¸é … ${k+1}ï¼š${opt.text} (å¥½æ„Ÿ ${opt.score>0?'+':''}${opt.score})\n  å›æ‡‰ï¼š${opt.content}\n`;
                      });
                      md += `\n`;
                  }
              });
          }
      }
      
      document.getElementById('output').textContent = md;
      scrollToSection('sec-output');
      showToast("Markdown å·²ç”Ÿæˆï¼");
    }

    /* ========= è¼”åŠ©åŠŸèƒ½çœç•¥ (ä¿æŒä¸è®Š) ========= */
    function addExtra() { addExtraWithVal('',''); }
    function addExtraWithVal(title, text) {
        const div = document.createElement('div'); div.className = 'extra-block';
        div.innerHTML = `<div class="label-row"><label>æ¨™é¡Œ</label><input type="text" class="extra-title-field" data-maxlength="50" value="${title}" oninput="saveCurrentChar()"></div><textarea class="extra-field" data-maxlength="500" oninput="saveCurrentChar()">${text}</textarea><div style="text-align:right; margin-top:4px;"><button class="button-mini" onclick="this.closest('.extra-block').remove(); saveCurrentChar();">åˆªé™¤</button></div>`;
        document.getElementById('extraContainer').appendChild(div); setupFieldUtils(div); 
    }
    function addEvent() { addEventWithVal('',''); }
    function addEventWithVal(title, text) {
        const div = document.createElement('div'); div.className = 'event-block';
        div.innerHTML = `<div class="label-row"><label>äº‹ä»¶æ¨™é¡Œ</label><input type="text" class="event-title-field" data-maxlength="50" value="${title}" oninput="saveCurrentChar()"></div><textarea class="event-field" data-maxlength="2000" oninput="saveCurrentChar()">${text}</textarea><div style="text-align:right; margin-top:4px;"><button class="button-mini" onclick="this.closest('.event-block').remove(); saveCurrentChar();">åˆªé™¤</button></div>`;
        document.getElementById('eventContainer').appendChild(div); setupFieldUtils(div);
    }
    function renderCharList(store) {
        const list = document.getElementById('charList'); list.innerHTML = '';
        Object.entries(store.chars).forEach(([id, item]) => {
            const btn = document.createElement('button'); btn.className = (id === store.currentId) ? 'button-mini' : 'button-secondary';
            if(id === store.currentId) { btn.style.background = 'var(--focus-color)'; btn.style.color='#fff'; }
            btn.textContent = item.meta.name;
            btn.onclick = () => { store.currentId = id; setStore(store); fillFormFromData(item.data); renderCharList(store); };
            list.appendChild(btn);
        });
    }
    function newCharacter() {
        const store = getStore(); store.currentId = 'char_' + Date.now(); setStore(store);
        location.reload();
    }
    function deleteCurrentChar() {
        const store = getStore();
        if(store.currentId && confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { delete store.chars[store.currentId]; store.currentId = Object.keys(store.chars)[0] || null; setStore(store); location.reload(); }
    }
    function setupAutoSave() {
        document.body.addEventListener('input', (e) => { if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') { saveCurrentChar(); updateProgress(); } });
        document.body.addEventListener('change', (e) => { if(e.target.tagName === 'SELECT' || e.target.type === 'checkbox') { saveCurrentChar(); updateProgress(); } });
    }
    function clearOne(id) { document.getElementById(id).value = ''; saveCurrentChar(); updateChatPreview(); }
    function updatePromptTokenInfo() {
       const role = document.getElementById('promptRole').value || ''; const guide = document.getElementById('promptGuideline').value || '';
       document.getElementById('promptTokenInfo').textContent = `é ä¼° Tokenï¼š${(role.length + guide.length) * 1.5}`;
    }
    function exportAllData() { const blob = new Blob([localStorage.getItem(STORAGE_KEY)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `qing_backup.json`; a.click(); showToast("å‚™ä»½å·²ä¸‹è¼‰"); }
    function importAllData() { const file = document.getElementById('allFile').files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { try { JSON.parse(e.target.result); localStorage.setItem(STORAGE_KEY, e.target.result); location.reload(); } catch(err) { showToast("æ ¼å¼éŒ¯èª¤", "error"); } }; reader.readAsText(file); }
    function downloadTxt() { generateMarkdown(); const txt = document.getElementById('output').textContent; const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([txt], {type: 'text/plain'})); a.download = `${document.getElementById('charName').value}_setting.txt`; a.click(); showToast("å·²ä¸‹è¼‰"); }
    
    /* Tag, Progress, Template, Chat, Toast functions are same as before, kept implicit */
    function updateProgress() {
      const requiredIds = ['charName', 'charAge', 'charJob', 'charQuote', 'basicInfo', 'personality', 'speechStyle'];
      let filledCount = 0;
      requiredIds.forEach(id => { const el = document.getElementById(id); if(el && el.value.trim() !== '') filledCount++; });
      if(document.getElementById('gender').value !== 'æœªè¨­ç½®') filledCount++;
      const percent = Math.round((filledCount / (requiredIds.length + 1)) * 100);
      document.getElementById('progressBar').style.width = `${percent}%`; document.getElementById('progressText').textContent = `${percent}%`;
    }
    function initTagInput() {
        const container = document.getElementById('tagsContainer'); const input = document.getElementById('tagInput'); const hiddenInput = document.getElementById('charTags'); if(!container) return;
        function renderTags() {
            container.querySelectorAll('.tag-pill').forEach(p => p.remove());
            const tags = hiddenInput.value.split(' ').filter(t => t.trim());
            tags.forEach(tagText => { const pill = document.createElement('div'); pill.className = 'tag-pill'; pill.innerHTML = `<span>#${tagText}</span><span class="tag-remove" onclick="removeTag('${tagText}')">Ã—</span>`; container.insertBefore(pill, input); });
        }
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); const txt = input.value.trim().replace(/^#/, ''); if (txt) { let tags = hiddenInput.value.split(' ').filter(t => t.trim()); if (!tags.includes(txt)) { tags.push(txt); hiddenInput.value = tags.join(' '); renderTags(); saveCurrentChar(); } input.value = ''; } }
            if (e.key === 'Backspace' && input.value === '') { let tags = hiddenInput.value.split(' ').filter(t => t.trim()); if(tags.length > 0) { tags.pop(); hiddenInput.value = tags.join(' '); renderTags(); saveCurrentChar(); } }
        });
        window.removeTag = function(text) { let tags = hiddenInput.value.split(' ').filter(t => t.trim()); tags = tags.filter(t => t !== text); hiddenInput.value = tags.join(' '); renderTags(); saveCurrentChar(); };
        renderTags();
    }
    function updateChatPreview() {
        const name = document.getElementById('charName').value || "è§’è‰²"; const scene = document.getElementById('firstScene').value || "ï¼ˆç­‰å¾…è¼¸å…¥å ´æ™¯...ï¼‰"; const dialogue = document.getElementById('sampleDialogue').value || "ï¼ˆç­‰å¾…è¼¸å…¥å°è©±...ï¼‰";
        document.getElementById('chatHeaderName').textContent = name; document.getElementById('previewAvatar').textContent = name.charAt(0);
        document.getElementById('previewScene').innerHTML = scene.replace(/\n/g, '<br>'); document.getElementById('previewDialogue').innerHTML = dialogue.replace(/\n/g, '<br>');
    }
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer'); const toast = document.createElement('div'); toast.className = 'toast'; toast.innerHTML = `<span>${type==='warn'?'âš ï¸':(type==='error'?'âŒ':'âœ…')}</span><span>${message}</span>`; container.appendChild(toast);
      setTimeout(() => { toast.classList.add('fade-out'); toast.addEventListener('animationend', () => toast.remove()); }, 3000);
    }
    function limitText(text, max) { return text.trim().slice(0, max); }
    function changeTheme(theme) { document.body.classList.remove('theme-pink','theme-cream','theme-mint','theme-lavender','theme-sky','theme-lemon','theme-grey','theme-black'); document.body.classList.add(`theme-${theme}`); }
    function setLayout(mode) { document.body.classList.remove('layout-desktop','layout-mobile'); document.body.classList.add(`layout-${mode}`); }
    function initLayoutByWidth() { if (window.innerWidth <= 850) setLayout('mobile'); else setLayout('desktop'); }
    function toggleSidebar() { const sb = document.querySelector('.sidebar'); if(sb) { sb.classList.toggle('is-collapsed'); document.querySelector('.sidebar-toggle-btn').textContent = sb.classList.contains('is-collapsed') ? 'â–¶' : 'â—€'; } }
    function scrollToSection(id) { const el = document.getElementById(id); if(el) { expandSection(id); const y = el.getBoundingClientRect().top + window.pageYOffset - 80; window.scrollTo({top:y, behavior:'smooth'}); } }
    function toggleSectionCollapse(id) { document.getElementById(id).classList.toggle('collapsed'); }
    function expandSection(id) { document.getElementById(id).classList.remove('collapsed'); }
    function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
    window.addEventListener('scroll', () => { const btn = document.getElementById('backToTopBtn'); if (window.scrollY > 300) btn.classList.add('show'); else btn.classList.remove('show'); });
    
    // Template functions (placeholder)
    function renderTemplateManager() {}
    function saveTemplateFromField(type, id) { 
        const val = document.getElementById(id).value; if(!val) { showToast("æ¬„ä½æ˜¯ç©ºçš„", "warn"); return; }
        const name = prompt("æ¨¡æ¿åç¨±ï¼š"); if(name) { const store = getStore(); store.templates[type].push({id: Date.now(), name, text: val}); setStore(store); showToast("æ¨¡æ¿å·²å„²å­˜"); }
    }
  </script>
</body>
</html>
