<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿å¿æˆ‘æˆ‘å‰µè§’å°å¹«æ‰‹ (çµ‚æ¥µå®Œå…¨ç‰ˆ)</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap">
  <style>
    :root {
      --radius-md: 12px; --radius-lg: 20px;
      --bg-pink: #fff5f8; --accent-pink: #ff7eb3; --focus-rgb-pink: 255, 126, 179;
      --bg-cream: #fdfbf7; --accent-cream: #ffaa6e; --focus-rgb-cream: 255, 170, 110;
      --bg-mint: #f2fffd; --accent-mint: #4cd9a4; --focus-rgb-mint: 76, 217, 164;
      --bg-lavender: #f9f7ff; --accent-lavender: #b185ff; --focus-rgb-lavender: 177, 133, 255;
      --bg-sky: #f4fbff; --accent-sky: #6ab0ff; --focus-rgb-sky: 106, 176, 255;
      --bg-lemon: #fffffa; --accent-lemon: #facc15; --focus-rgb-lemon: 250, 204, 21;
      --bg-grey: #f8f9fa; --accent-grey: #8d99ae; --focus-rgb-grey: 141, 153, 174;
      --bg-black: #1a1a1a; --accent-black: #71717a; --focus-rgb-black: 113, 113, 122;

      --page-bg: var(--bg-pink); --card-bg: rgba(255, 255, 255, 0.85); --sidebar-bg: rgba(255, 255, 255, 0.9);
      --text-main: #475569; --text-sub: #94a3b8; --border-color: rgba(0,0,0,0.08);
      --focus-color: var(--accent-pink); --focus-rgb: var(--focus-rgb-pink);
      --btn-bg: var(--accent-pink); --btn-text: #fff;
      --shadow-card: 0 4px 20px -4px rgba(0,0,0,0.06); --shadow-hover: 0 10px 25px -5px rgba(0,0,0,0.1);
      --chat-bg: #20232a; --chat-bubble-sys: #3a3f4b;
    }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; font-family: "Noto Sans TC", system-ui, sans-serif; color: var(--text-main); background-color: var(--page-bg); background-image: radial-gradient(at top center, rgba(255,255,255,0.6) 0%, transparent 80%); background-attachment: fixed; min-height: 100vh; padding-bottom: 120px; line-height: 1.6; transition: background 0.5s ease; }
    
    body.theme-pink { --page-bg: var(--bg-pink); --focus-color: #ff7eb3; --focus-rgb: var(--focus-rgb-pink); --btn-bg: #ff7eb3; }
    body.theme-cream { --page-bg: var(--bg-cream); --focus-color: #ffaa6e; --focus-rgb: var(--focus-rgb-cream); --btn-bg: #ffaa6e; }
    body.theme-mint { --page-bg: var(--bg-mint); --focus-color: #4cd9a4; --focus-rgb: var(--focus-rgb-mint); --btn-bg: #4cd9a4; }
    body.theme-lavender { --page-bg: var(--bg-lavender); --focus-color: #b185ff; --focus-rgb: var(--focus-rgb-lavender); --btn-bg: #b185ff; }
    body.theme-sky { --page-bg: var(--bg-sky); --focus-color: #6ab0ff; --focus-rgb: var(--focus-rgb-sky); --btn-bg: #6ab0ff; }
    body.theme-lemon { --page-bg: var(--bg-lemon); --focus-color: #facc15; --focus-rgb: var(--focus-rgb-lemon); --btn-bg: #facc15; --btn-text: #5c4e00; }
    body.theme-grey { --page-bg: var(--bg-grey); --focus-color: #8d99ae; --focus-rgb: var(--focus-rgb-grey); --btn-bg: #8d99ae; }
    body.theme-black { --page-bg: var(--bg-black); --card-bg: #27272a; --sidebar-bg: #27272a; --text-main: #e4e4e7; --text-sub: #a1a1aa; --border-color: rgba(255,255,255,0.1); --focus-color: #a1a1aa; --focus-rgb: 161, 161, 170; --btn-bg: #52525b; --btn-text: #fff; }

    .progress-header { position: sticky; top: 0; z-index: 900; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); padding: 8px 20px; display: flex; justify-content: center; }
    body.theme-black .progress-header { background: rgba(39, 39, 42, 0.9); }
    .progress-container { width: 100%; max-width: 900px; display: flex; align-items: center; gap: 10px; }
    .progress-label { font-size: 0.75rem; font-weight: 700; color: var(--focus-color); white-space: nowrap; }
    .progress-track { flex: 1; height: 6px; background: rgba(0,0,0,0.05); border-radius: 99px; overflow: hidden; }
    body.theme-black .progress-track { background: rgba(255,255,255,0.1); }
    .progress-bar { height: 100%; width: 0%; background: var(--focus-color); border-radius: 99px; transition: width 0.5s ease; }

    .layout-shell { display: flex; gap: 24px; max-width: 1000px; margin: 20px auto; padding: 0 20px; position: relative; }
    .main-area { flex: 1; min-width: 0; }

    .sidebar { flex: 0 0 240px; width: 240px; position: sticky; top: 60px; background: var(--sidebar-bg); backdrop-filter: blur(16px); padding: 16px; border-radius: var(--radius-lg); border: 1px solid var(--border-color); box-shadow: var(--shadow-card); transition: all 0.3s ease; z-index: 100; }
    .sidebar.is-collapsed { flex: 0 0 64px; width: 64px; padding: 16px 8px; }
    .sidebar-header { display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); }
    .sidebar.is-collapsed .sidebar-header { justify-content: center; }
    .sidebar.is-collapsed .sidebar-title, .sidebar.is-collapsed .sidebar-sub { display: none; }
    .sidebar-title { font-weight: 700; font-size: 0.95rem; }
    .sidebar-sub { font-size: 0.7rem; color: var(--text-sub); }
    .sidebar-nav { display: flex; flex-direction: column; gap: 4px; }
    .sidebar-nav button { width: 100%; text-align: left; background: transparent; color: var(--text-main); border: none; padding: 8px 12px; border-radius: 8px; transition: 0.2s; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
    .sidebar-nav button:hover { background: rgba(var(--focus-rgb), 0.08); color: var(--focus-color); }
    .sidebar.is-collapsed .sidebar-nav button { justify-content: center; padding: 8px 0; }
    .sidebar.is-collapsed .sidebar-nav button span.text { display: none; }
    
    .top-bar { max-width: 1000px; margin: 20px auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 16px; }
    h1 { font-family: "Noto Serif TC", serif; font-size: 2rem; margin: 0; font-weight: 700; background: linear-gradient(120deg, var(--text-main), var(--focus-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .tagline { font-size: 0.9rem; color: var(--text-sub); margin-top: 4px; }

    .section { background: var(--card-bg); backdrop-filter: blur(20px); border-radius: var(--radius-lg); padding: 28px; margin-bottom: 20px; box-shadow: var(--shadow-card); border: 1px solid rgba(255,255,255,0.5); transition: all 0.3s; }
    body.theme-black .section { border-color: rgba(255,255,255,0.05); }
    .section:hover { box-shadow: var(--shadow-hover); transform: translateY(-2px); }
    .section.collapsed { padding-bottom: 20px; opacity: 0.7; }
    .section.collapsed .section-body { display: none; }
    h2 { font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center; margin: 0 0 16px 0; font-weight: 700; color: var(--text-main); opacity: 0.9; }
    .section-body { animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    .field-group { margin-bottom: 16px; position: relative; }
    .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    label { font-size: 0.85rem; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 6px; }
    
    input[type="text"], input[type="search"], input[type="date"], input[type="number"], select, textarea, .tags-container { width: 100%; padding: 10px 12px; font-size: 0.95rem; color: var(--text-main); background: rgba(255,255,255,0.6); border: 1px solid var(--border-color); border-radius: var(--radius-md); transition: all 0.2s; outline: none; font-family: inherit; }
    body.theme-black input, body.theme-black select, body.theme-black textarea, body.theme-black .tags-container { background: rgba(0,0,0,0.2); }
    textarea { min-height: 100px; resize: vertical; line-height: 1.6; }
    input:focus, select:focus, textarea:focus, .tags-container:focus-within { background: #fff; border-color: var(--focus-color); box-shadow: 0 0 0 3px rgba(var(--focus-rgb), 0.15); }
    body.theme-black input:focus, body.theme-black textarea:focus, body.theme-black .tags-container:focus-within { background: rgba(40,40,40,0.8); }

    .field-utils { display: flex; justify-content: flex-end; align-items: center; gap: 8px; margin-top: 4px; font-size: 0.75rem; color: var(--text-sub); }
    .field-counter { margin-right: auto; opacity: 0.8; font-variant-numeric: tabular-nums; }
    .field-counter.limit-reach { color: #ef4444; font-weight: bold; }

    .icon-btn { background: transparent; border: none; color: var(--text-sub); cursor: pointer; padding: 4px; border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .icon-btn:hover { background: rgba(0,0,0,0.05); color: var(--focus-color); }
    
    button.main-btn { background: var(--btn-bg); color: var(--btn-text); border: none; padding: 8px 20px; border-radius: 99px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(var(--focus-rgb), 0.3); transition: 0.2s; }
    button.main-btn:hover { transform: translateY(-2px); filter: brightness(1.05); }
    button.sec-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-main); padding: 6px 16px; border-radius: 99px; font-size: 0.85rem; cursor: pointer; transition: 0.2s; }
    button.sec-btn:hover { border-color: var(--focus-color); color: var(--focus-color); background: rgba(255,255,255,0.5); }

    .tags-container { display: flex; flex-wrap: wrap; gap: 6px; padding: 8px; cursor: text; }
    .tag-pill { background: var(--focus-color); color: #fff; padding: 2px 10px; border-radius: 12px; font-size: 0.8rem; display: flex; align-items: center; gap: 6px; }
    .tag-remove { cursor: pointer; opacity: 0.8; } .tag-remove:hover { opacity: 1; }
    .tags-input { border: none; background: transparent; outline: none; flex: 1; min-width: 60px; padding: 0; margin: 0; font-size: 0.9rem; }
    
    .story-card { background: rgba(255,255,255,0.4); border: 1px solid var(--border-color); border-radius: 16px; padding: 16px; margin-bottom: 16px; position: relative; }
    .story-card:hover { border-color: var(--focus-color); }
    .tabs-header { display: flex; gap: 4px; border-bottom: 1px solid var(--border-color); margin-bottom: 16px; overflow-x: auto; padding-bottom: 2px; }
    .tab-btn { background: transparent; border: none; padding: 8px 14px; font-size: 0.85rem; color: var(--text-sub); cursor: pointer; border-radius: 8px 8px 0 0; transition: 0.2s; white-space: nowrap; }
    .tab-btn.active { color: var(--focus-color); background: rgba(var(--focus-rgb), 0.1); font-weight: 700; }
    .story-stage-content { display: none; animation: fadeIn 0.3s; }
    .story-stage-content.active { display: block; }

    .option-card { background: rgba(255,255,255,0.5); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; margin-top: 12px; position: relative; transition: var(--transition); }
    body.theme-black .option-card { background: rgba(0,0,0,0.2); }
    .option-card:hover { border-color: var(--focus-color); }
    .option-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-sub); font-weight: bold; }

    .chat-container { background: var(--chat-bg); border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); max-width: 400px; margin: 20px auto; overflow: hidden; font-family: -apple-system, sans-serif; }
    .chat-header { padding: 12px; text-align: center; color: #fff; font-weight: 600; background: rgba(255,255,255,0.05); font-size: 0.9rem; }
    .chat-body { padding: 20px 16px; display: flex; flex-direction: column; gap: 16px; min-height: 280px; }
    .msg-system { font-size: 0.75rem; color: #9ca3af; text-align: center; background: rgba(255,255,255,0.08); padding: 4px 12px; border-radius: 99px; align-self: center; }
    .msg-row { display: flex; gap: 10px; }
    .msg-avatar { width: 36px; height: 36px; background: #4b5563; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: #fff; font-size: 0.9rem; flex-shrink: 0; }
    .msg-bubble { background: var(--chat-bubble-sys); color: #e0e0e0; padding: 10px 14px; border-radius: 4px 16px 16px 16px; font-size: 0.9rem; line-height: 1.5; }

    .toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast { background: rgba(0,0,0,0.8); color: #fff; padding: 8px 20px; border-radius: 99px; font-size: 0.85rem; pointer-events: auto; animation: toastIn 0.3s forwards; }
    .toast.fade-out { animation: toastOut 0.3s forwards; }
    @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toastOut { to { opacity: 0; transform: translateY(10px); } }
    
    #backToTopBtn { position: fixed; bottom: 30px; right: 30px; width: 48px; height: 48px; border-radius: 50%; background: var(--btn-bg); color: #fff; font-size: 1.2rem; box-shadow: 0 8px 20px rgba(var(--focus-rgb), 0.3); border: none; cursor: pointer; opacity: 0; visibility: hidden; transition: 0.3s; z-index: 900; display: flex; justify-content: center; align-items: center; }
    #backToTopBtn.show { opacity: 1; visibility: visible; transform: translateY(0); }
    #backToTopBtn:hover { transform: translateY(-4px); }

    @media (max-width: 850px) {
      .layout-shell { flex-direction: column; padding: 0 16px; }
      .sidebar { width: 100%; position: static; z-index: 1; }
      .sidebar-nav { flex-direction: row; overflow-x: auto; padding-bottom: 4px; }
      .sidebar-nav button { white-space: nowrap; width: auto; background: rgba(255,255,255,0.5); border: 1px solid var(--border-color); }
      .sidebar-header { display: none; }
    }
    body.layout-mobile .layout-shell { flex-direction: column; padding: 0 12px; }
    body.layout-mobile .sidebar { width: 100%; position: sticky; top: 50px; z-index: 800; padding: 8px; border-radius: 16px; overflow: visible !important; }
    body.layout-mobile .sidebar-nav { flex-direction: row; gap: 6px; }
    
    /* Token Info Box */
    #promptTokenInfo { font-size: 0.8rem; color: var(--text-main); line-height: 1.6; }
    #promptTokenInfo strong { color: var(--focus-color); }
  </style>
</head>
<body class="theme-pink layout-desktop">

  <div class="progress-header">
    <div class="progress-container">
      <div class="progress-label">è¨­å®šå®Œæˆåº¦ <span id="progressText">0%</span></div>
      <div class="progress-track"><div class="progress-bar" id="progressBar"></div></div>
    </div>
  </div>
  <div class="toast-container" id="toastContainer"></div>

  <div class="top-bar">
    <div>
      <h1>ğŸ’• å¿å¿æˆ‘æˆ‘å‰µè§’å°å¹«æ‰‹</h1>
      <div class="tagline">çµ‚æ¥µå®Œå…¨ç‰ˆï¼šå¡«å¯«è¨­å®šï¼Œä¸€éµç”Ÿæˆ AI è§’è‰²å¡èˆ‡éŠæˆ²è…³æœ¬ã€‚</div>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <div class="theme-select">
        <select onchange="changeTheme(this.value)" style="padding:6px 10px; border-radius:99px; border:1px solid var(--border-color); cursor:pointer;">
          <option value="pink" selected>ğŸŒ¸ æ«»èŠ±ç²‰</option>
          <option value="cream">ğŸ å¥¶æ²¹ç™½</option>
          <option value="mint">ğŸŒ¿ è–„è·ç¶ </option>
          <option value="lavender">ğŸ”® è–°è¡£è‰</option>
          <option value="sky">â˜ï¸ å¤©ç©ºè—</option>
          <option value="lemon">ğŸ‹ æª¸æª¬é»ƒ</option>
          <option value="grey">ğŸŒ«ï¸ æ¥µç°¡ç°</option>
          <option value="black">ğŸŒ™ æ·±å¤œé»‘</option>
        </select>
      </div>
    </div>
  </div>

  <div class="layout-shell">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">ğŸ“ åŠŸèƒ½å°èˆª</div>
        <button class="icon-btn" onclick="toggleSidebar()">â—€</button>
      </div>
      <div class="sidebar-sub" style="margin-bottom:10px;">é»æ“Šå¿«é€Ÿè·³è½‰</div>
      <nav class="sidebar-nav">
        <button onclick="scrollToSection('sec-archive')"><span class="icon">ğŸ“‚</span><span class="text">å­˜æª”ç®¡ç†</span></button>
        <button onclick="scrollToSection('sec-info')"><span class="icon">ğŸ’â€â™€ï¸</span><span class="text">è§’è‰²è³‡è¨Š</span></button>
        <button onclick="scrollToSection('sec-basic')"><span class="icon">ğŸŒ</span><span class="text">åŸºæœ¬è³‡è¨Š</span></button>
        <button onclick="scrollToSection('sec-personality')"><span class="icon">ğŸ’—</span><span class="text">æ€§æ ¼ç‰¹è³ª</span></button>
        <button onclick="scrollToSection('sec-speech')"><span class="icon">ğŸ—£ï¸</span><span class="text">èªªè©±é¢¨æ ¼</span></button>
        <button onclick="scrollToSection('sec-prompt')"><span class="icon">ğŸ§ </span><span class="text">Prompt</span></button>
        <button onclick="scrollToSection('sec-game-mgr')"><span class="icon">ğŸ®</span><span class="text">éŠæˆ²ç®¡ç†</span></button>
        <button onclick="scrollToSection('sec-first')"><span class="icon">ğŸ¬</span><span class="text">é–‹å ´å°è©±</span></button>
        <button onclick="scrollToSection('sec-output')"><span class="icon">ğŸ“</span><span class="text">è¼¸å‡ºé è¦½</span></button>
      </nav>
    </aside>

    <main class="main-area">

      <!-- å­˜æª”å€ -->
      <div class="section" id="sec-archive">
        <h2><span>ğŸ“‚ è§’è‰²å­˜æª”</span><button class="icon-btn" onclick="toggleSectionCollapse('sec-archive')">â‡•</button></h2>
        <div class="section-body">
          <div class="label-row">
             <div style="flex:1; margin-right:12px;"><select id="filterCategory" onchange="refreshCharListFromStorage()"><option value="">å…¨éƒ¨åˆ†é¡</option></select></div>
             <div style="flex:1;"><input id="searchName" type="search" placeholder="æœå°‹è§’è‰²..." oninput="refreshCharListFromStorage()" /></div>
          </div>
          <div id="charList" style="margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; min-height:40px;"></div>
          <div style="margin-top:20px; padding-top:20px; border-top:1px dashed var(--border-color); display:flex; gap:10px;">
            <button class="main-btn" onclick="newCharacter()">â• æ–°è§’è‰²</button>
            <button class="main-btn" onclick="saveCurrentChar()">ğŸ’¾ å„²å­˜</button>
            <button class="sec-btn" onclick="deleteCurrentChar()" style="margin-left:auto; color:#ef4444; border-color:#fca5a5;">ğŸ—‘ åˆªé™¤</button>
          </div>
        </div>
      </div>

      <!-- è§’è‰²è³‡è¨Š -->
      <div class="section" id="sec-info">
        <h2>
          <span>ğŸ’â€â™€ï¸ è§’è‰²è³‡è¨Š</span>
          <button class="icon-btn" onclick="toggleSectionCollapse('sec-info')">â‡•</button>
        </h2>
        <div class="section-body">
          <div class="field-group">
            <div class="label-row">
                <label>è§’è‰²åç¨± <span style="color:red">*</span> (15å­—)</label>
                <button class="icon-btn" onclick="clearOne('charName')" title="æ¸…ç©º">ğŸ—‘ï¸</button>
            </div>
            <input id="charName" type="text" data-maxlength="15" placeholder="ä¾‹å¦‚ï¼šæ—æœˆå¦‚" oninput="updateChatPreview()" />
          </div>

          <div style="display:flex; gap:16px;">
            <div class="field-group" style="flex:1;">
               <label style="margin-bottom:6px;">å¹´é½¡ (15å­—)</label>
               <input id="charAge" type="text" data-maxlength="15" placeholder="18æ­²" />
            </div>
            <div class="field-group" style="flex:1;">
               <label style="margin-bottom:6px;">è·æ¥­ (15å­—)</label>
               <input id="charJob" type="text" data-maxlength="15" placeholder="å­¸ç”Ÿ" />
            </div>
          </div>
          
          <div class="field-group">
             <label style="margin-bottom:6px;">è§’è‰²åˆ†é¡</label>
             <input id="charCategory" type="text" placeholder="ç¾ä»£ã€å¥‡å¹»..." />
          </div>

          <div class="field-group">
             <div class="label-row">
                 <label>ä¸€å¥è©±ä»‹ç´¹ <span style="color:red">*</span> (80å­—)</label>
             </div>
             <textarea id="charQuote" data-maxlength="80" style="min-height:80px;" placeholder="é¡¯ç¤ºåœ¨åˆ—è¡¨çš„çŸ­ä»‹ç´¹"></textarea>
          </div>

          <div class="field-group">
             <div class="label-row">
                 <label>æ•˜è¿° (700å­—)</label>
             </div>
             <textarea id="charDesc" data-maxlength="700" placeholder="è§’è‰²çš„å¤–è²Œã€æ°£è³ªç­‰è©³ç´°æå¯«"></textarea>
          </div>

          <div class="field-group">
             <label style="margin-bottom:6px;">æ¨™ç±¤ (è¼¸å…¥å¾ŒæŒ‰ Enter)</label>
             <div class="tags-container" id="tagsContainer" onclick="document.getElementById('tagInput').focus()">
                <input type="text" id="tagInput" class="tags-input" placeholder="è¼¸å…¥æ¨™ç±¤..." />
             </div>
             <input type="hidden" id="charTags" />
          </div>
          
          <div class="field-group">
             <label style="margin-bottom:6px;">å‰µä½œè€…ç­†è¨˜ (200å­—)</label>
             <textarea id="creatorNote" data-maxlength="200" style="min-height:80px;"></textarea>
          </div>
        </div>
      </div>
      
      <div class="section" id="sec-gender">
         <h2><span>ğŸš» æ€§åˆ¥</span><button class="icon-btn" onclick="toggleSectionCollapse('sec-gender')">â‡•</button></h2>
        <div class="section-body">
          <select id="gender"><option value="æœªè¨­ç½®" selected>æœªè¨­ç½®</option><option value="ç”·æ€§">ç”·æ€§</option><option value="å¥³æ€§">å¥³æ€§</option><option value="ç„¡æ€§åˆ¥">ç„¡æ€§åˆ¥</option></select>
        </div>
      </div>

      <!-- æ ¸å¿ƒè¨­å®š -->
      <div class="section" id="sec-basic">
        <h2>
            <span>ğŸŒ åŸºæœ¬è³‡è¨Š (700å­—)</span>
            <button class="icon-btn" onclick="toggleSectionCollapse('sec-basic')">â‡•</button>
        </h2>
        <div class="section-body">
           <div style="text-align:right; margin-bottom:6px;"><button class="sec-btn" style="font-size:0.75rem; padding:2px 10px;" onclick="saveTemplateFromField('basicInfo','basicInfo')">å­˜ç‚ºæ¨¡æ¿</button></div>
          <textarea id="basicInfo" data-maxlength="700" placeholder="å¿…å¡«ã€‚ä¸–ç•Œè§€ã€èƒŒæ™¯æ•…äº‹..."></textarea>
        </div>
      </div>

      <div class="section" id="sec-personality">
        <h2>
            <span>ğŸ’— æ€§æ ¼ (700å­—)</span>
            <button class="icon-btn" onclick="toggleSectionCollapse('sec-personality')">â‡•</button></h2>
        <div class="section-body">
          <div style="text-align:right; margin-bottom:6px;"><button class="sec-btn" style="font-size:0.75rem; padding:2px 10px;" onclick="saveTemplateFromField('personality','personality')">å­˜ç‚ºæ¨¡æ¿</button></div>
          <textarea id="personality" data-maxlength="700" placeholder="å¿…å¡«ã€‚å…§åœ¨æ€§æ ¼ã€å°ç©å®¶çš„æ…‹åº¦..."></textarea>
        </div>
      </div>
      
      <div class="section" id="sec-speech">
        <h2>
            <span>ğŸ—£ï¸ èªªè©±é¢¨æ ¼èˆ‡ç¿’æ…£ (700å­—)</span>
            <button class="icon-btn" onclick="toggleSectionCollapse('sec-speech')">â‡•</button></h2>
        <div class="section-body">
          <div style="text-align:right; margin-bottom:6px;"><button class="sec-btn" style="font-size:0.75rem; padding:2px 10px;" onclick="saveTemplateFromField('speechStyle','speechStyle')">å­˜ç‚ºæ¨¡æ¿</button></div>
          <textarea id="speechStyle" data-maxlength="700" placeholder="å¿…å¡«ã€‚å£é ­ç¦ªã€èªæ°£ã€ç”¨è©ç¿’æ…£..."></textarea>
        </div>
      </div>
      
      <div class="section" id="sec-prompt">
        <h2><span>ğŸ§  Prompt è¨­å®š</span><button class="icon-btn" onclick="toggleSectionCollapse('sec-prompt')">â‡•</button></h2>
        <div class="section-body">
          <div class="field-group">
              <label style="margin-bottom:6px;">ä½¿ç”¨æ¨¡å‹</label>
              <select id="modelType">
                <option value="gemini-3-pro">Gemini 3 Pro</option>
                <option value="claude-sonnet-4-5">Claude Sonnet 4.5</option>
                <option value="claude-haiku-4-5">Claude Haiku 4.5</option>
              </select>
          </div>
          <div class="field-group">
             <div class="label-row">
                 <label>System Role</label>
             </div>
             <textarea id="promptRole" placeholder="ç³»çµ±æŒ‡ä»¤..."></textarea>
          </div>
          <div class="field-group">
             <label style="margin-bottom:6px;">Response Guideline</label>
             <textarea id="promptGuideline" placeholder="å›æ‡‰è¦å‰‡..."></textarea>
          </div>
        </div>
      </div>

      <!-- éŠæˆ²ç®¡ç† -->
      <div class="section" id="sec-game-mgr">
        <h2>
            <span>ğŸ® éŠæˆ²ç®¡ç†</span>
            <button class="icon-btn" onclick="toggleSectionCollapse('sec-game-mgr')">â‡•</button>
        </h2>
        <div class="section-body">
          <h3 style="font-size:0.95rem; font-weight:700; color:var(--focus-color); margin-bottom:12px;">1. éŠæˆ²ä»‹ç´¹åŸºæœ¬è³‡è¨Š</h3>
          <div class="field-group">
              <label style="margin-bottom:6px;">æ¨™é¡Œ (30å­—)</label>
              <input id="gameTitle" type="text" data-maxlength="30" placeholder="è¼¸å…¥éŠæˆ²æ¨™é¡Œ..." oninput="saveCurrentChar()" />
          </div>
          <div class="field-group">
              <label style="margin-bottom:6px;">ä»‹ç´¹ (30å­—)</label>
              <textarea id="gameIntro" data-maxlength="30" style="min-height:60px;" placeholder="ç°¡çŸ­ä»‹ç´¹..." oninput="saveCurrentChar()"></textarea>
          </div>

          <h3 style="font-size:0.95rem; font-weight:700; color:var(--focus-color); margin:30px 0 12px 0;">2. ç§å¯†ç‰©èª</h3>
          <div class="tabs-header">
            <button class="tab-btn active" onclick="switchStoryTab(0)">ç†Ÿäºº</button>
            <button class="tab-btn" onclick="switchStoryTab(1)">æœ‹å‹</button>
            <button class="tab-btn" onclick="switchStoryTab(2)">å¿ƒå‹•</button>
            <button class="tab-btn" onclick="switchStoryTab(3)">æˆ€äºº</button>
            <button class="tab-btn" onclick="switchStoryTab(4)">çµå©š</button>
          </div>
          <div id="story-container"></div>
        </div>
      </div>

      <div class="section" id="sec-first">
        <h2><span>ğŸ¬ é–‹å ´èˆ‡å°è©± (800å­—)</span><button class="icon-btn" onclick="toggleSectionCollapse('sec-first')">â‡•</button></h2>
        <div class="section-body">
          <div class="field-group">
              <div class="label-row">
                  <label>ç¬¬ä¸€èŠå¤©å ´æ™¯</label>
              </div>
              <textarea id="firstScene" data-maxlength="800" oninput="updateChatPreview()" placeholder="è¨­å®šå ´æ™¯..."></textarea>
          </div>
          <div class="field-group">
              <div class="label-row">
                  <label>è§’è‰²å°è©±</label>
              </div>
              <textarea id="sampleDialogue" data-maxlength="800" oninput="updateChatPreview()" placeholder="è§’è‰²ç¬¬ä¸€å¥æœƒèªªçš„è©±..."></textarea>
          </div>
        </div>
      </div>
      
      <div class="section" id="sec-fav">
        <h2>
            <span>ğŸ€ å–œå¥½èˆ‡ç”Ÿæ—¥ (50å­—)</span>
            <button class="icon-btn" onclick="toggleSectionCollapse('sec-fav')">â‡•</button>
        </h2>
        <div class="section-body">
          <div class="field-group"><input id="likes" type="text" data-maxlength="50" placeholder="å–œæ­¡çš„æ±è¥¿" /></div>
          <div class="field-group"><input id="dislikes" type="text" data-maxlength="50" placeholder="ä¸å–œæ­¡çš„æ±è¥¿" /></div>
          <div class="field-group"><input id="birthday" type="date" /></div>
        </div>
      </div>
      
      <div class="section" id="sec-extra">
        <h2><span>ğŸ“Œ é™„åŠ è³‡è¨Š (500å­—)</span><button class="icon-btn" onclick="toggleSectionCollapse('sec-extra')">â‡•</button></h2>
        <div class="section-body">
            <div id="extraContainer"></div>
            <button class="sec-btn" onclick="addExtra()">ï¼‹ æ–°å¢ä¸€ç­†</button>
        </div>
      </div>
      
      <div class="section" id="sec-event">
        <h2><span>ğŸ“š å‰µä½œè€…äº‹ä»¶ (2000å­—)</span><button class="icon-btn" onclick="toggleSectionCollapse('sec-event')">â‡•</button></h2>
        <div class="section-body">
            <div id="eventContainer"></div>
            <button class="sec-btn" onclick="addEvent()">ï¼‹ æ–°å¢äº‹ä»¶</button>
        </div>
      </div>

      <div class="section" id="sec-output">
        <h2><span>ğŸ“ è¼¸å‡ºèˆ‡é è¦½</span><button class="icon-btn" onclick="toggleSectionCollapse('sec-output')">â‡•</button></h2>
        <div class="section-body">
           <div style="display:flex; justify-content:center; margin-bottom:30px;">
             <button class="main-btn" style="width:100%; font-size:1.1rem;" onclick="generateMarkdown()">âœ¨ ç”Ÿæˆ Markdown è…³æœ¬</button>
           </div>
           <div class="chat-container">
            <div class="chat-header"><span id="chatHeaderName">è§’è‰²åç¨±</span></div>
            <div class="chat-body">
              <div class="msg-system" id="previewScene">...</div>
              <div class="msg-row"><div class="msg-avatar" id="previewAvatar">A</div><div class="msg-bubble" id="previewDialogue">...</div></div>
            </div>
          </div>
          <div style="margin-top:30px; display:flex; gap:10px; flex-wrap:wrap;">
             <button class="main-btn" style="background:#4b5563;" onclick="saveSelfHtml()">ğŸ’¾ å„²å­˜ç‚ºç¨ç«‹ App æª”</button>
             <button class="sec-btn" onclick="downloadTxt()">â¬‡ ä¸‹è¼‰ .txt</button>
             <button class="sec-btn" onclick="exportAllData()">ğŸ“¦ å‚™ä»½ JSON</button>
             <label class="sec-btn" style="cursor:pointer; display:flex; align-items:center; margin:0;">
                ğŸ“‚ åŒ¯å…¥<input id="allFile" type="file" accept=".json,.html" style="display:none;" onchange="importAllData()" />
             </label>
          </div>
          <div id="output"></div>
        </div>
      </div>
      
      <div class="section" id="sec-template-center">
        <h2><span>ğŸ§° æ¨¡æ¿ç®¡ç†ä¸­å¿ƒ</span><button class="icon-btn" onclick="toggleSectionCollapse('sec-template-center')">â‡•</button></h2>
        <div class="section-body"><select id="tplFilter" onchange="renderTemplateManager()"><option value="">å…¨éƒ¨é¡å‹</option></select><div id="tplManagerList" style="margin-top:16px;"></div></div>
      </div>
      
      <div class="section" id="sec-layout">
        <h2><span>ğŸ“± ç‰ˆé¢åˆ‡æ›</span></h2>
        <div class="section-body"><div style="display:flex; gap:10px;"><button class="sec-btn" onclick="setLayout('desktop')">ğŸ’» é›»è…¦ç‰ˆ</button><button class="sec-btn" onclick="setLayout('mobile')">ğŸ“± æ‰‹æ©Ÿç‰ˆ</button></div></div>
      </div>
    </main>
  </div>

  <button type="button" id="backToTopBtn" onclick="scrollToTop()" title="å›åˆ°é é¦–">â–²</button>
  <!-- é€™è£¡å­˜æ”¾æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ -->
  <script id="app-state" type="application/json">/*__DATA__*/</script>

  <script>
    const EXTRA_MAX = 10;
    const EVENT_MAX = 20;
    const STORAGE_KEY = 'qing_char_game_v21_strict'; 
    const TEMPLATE_TYPES = ['basicInfo','personality','speechStyle','extra','event'];
    const TEMPLATE_TYPE_LABELS = { basicInfo: 'åŸºæœ¬è³‡è¨Š', personality: 'æ€§æ ¼', speechStyle: 'èªªè©±é¢¨æ ¼', extra: 'é™„åŠ è³‡è¨Š', event: 'å‰µä½œè€…äº‹ä»¶' };
    
    const STORY_STAGES = ['ç†Ÿäººéšæ®µ', 'æœ‹å‹éšæ®µ', 'å¿ƒå‹•éšæ®µ', 'æˆ€äººéšæ®µ', 'çµå©šéšæ®µ'];

    function initLayoutByWidth() {
      if (window.innerWidth <= 850) setLayout('mobile');
      else setLayout('desktop');
    }

    function setupAutoSave() {
        document.body.addEventListener('input', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                saveCurrentChar();
                updateProgress();
            }
        });
        document.body.addEventListener('change', (e) => {
            if (e.target.tagName === 'SELECT' || e.target.type === 'checkbox') {
                saveCurrentChar();
                updateProgress();
            }
        });
    }

    window.addEventListener('DOMContentLoaded', () => {
      initLayoutByWidth();
      initStoryEditors(); 
      
      const stateEl = document.getElementById('app-state');
      if(stateEl && stateEl.textContent.trim() !== '/*__DATA__*/' && stateEl.textContent.trim().length > 0) {
          try {
              const embeddedData = JSON.parse(stateEl.textContent);
              setStore(embeddedData);
              showToast("å·²è¼‰å…¥æª”æ¡ˆå…§å»ºè³‡æ–™");
          } catch(e) { console.error("Load embedded failed", e); }
      }

      loadInitialFromStore();
      setupAutoSave();
      setupFieldUtils();
      initTagInput();
      updateProgress();
      
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(initLayoutByWidth, 200);
      });
    });

    /* ========= å–®æª”å„²å­˜æ ¸å¿ƒ ========= */
    function saveSelfHtml() {
        const currentStore = getStore();
        const dataStr = JSON.stringify(currentStore);
        let htmlContent = document.documentElement.outerHTML;
        const scriptOpen = '<script id="app-state" type="application/json">';
        const scriptClose = '<' + '/script>'; 
        const regex = /<script id="app-state" type="application\/json">([\s\S]*?)<\/script>/;
        const safeData = dataStr.replace(/<\/script>/g, '<\\/script>'); 
        const newScriptTag = `${scriptOpen}${safeData}${scriptClose}`;
        if (regex.test(htmlContent)) { htmlContent = htmlContent.replace(regex, newScriptTag); } 
        else { htmlContent = htmlContent.replace('</body>', `${newScriptTag}</body>`); }
        const blob = new Blob([htmlContent], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `å¿å¿æˆ‘æˆ‘è§’è‰²å‚™ä»½_${new Date().toISOString().slice(0,10)}.html`;
        a.click();
        showToast("å·²å„²å­˜ç‚ºç¨ç«‹ HTML æª”ï¼");
    }

    /* ========= éŠæˆ²ç®¡ç† UI ========= */
    function initStoryEditors() {
      const container = document.getElementById('story-container'); container.innerHTML = '';
      STORY_STAGES.forEach((stage, idx) => {
        const div = document.createElement('div'); div.className = `story-stage-content ${idx===0?'active':''}`; div.id = `story-stage-${idx}`;
        div.innerHTML = `<div id="storyList_${idx}"></div><div style="display:flex; gap:10px; margin-top:16px;"><button type="button" class="sec-btn" style="flex:1; border-style:dashed;" onclick="addStoryBlock(${idx})">ï¼‹ æ–°å¢ã€Œ${stage}ã€æ•…äº‹</button></div>`;
        container.appendChild(div);
      });
    }
    function switchStoryTab(idx) {
      document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',i===idx));
      document.querySelectorAll('.story-stage-content').forEach((d,i)=>d.classList.toggle('active',i===idx));
    }
    function addStoryBlock(idx, d=null) {
        const list = document.getElementById(`storyList_${idx}`); const div = document.createElement('div'); div.className = 'story-card';
        const uid = Date.now() + Math.random().toString(36).substr(2,9);
        div.innerHTML = `
          <div class="story-card-header"><span>æ•…äº‹è¨­å®š</span><button type="button" class="icon-btn" style="color:#ef4444;" onclick="if(confirm('åˆªé™¤?')){this.closest('.story-card').remove();saveCurrentChar();}">ğŸ—‘ï¸</button></div>
          
          <div class="label-row" style="background:rgba(var(--focus-rgb),0.05); padding:8px; border-radius:8px; margin-bottom:12px;">
              <div style="flex:1;"><label>ä½¿ç”¨ç­‰ç´š</label><select class="story-age" onchange="saveCurrentChar()"><option value="all" ${d?.ageRating==='all'?'selected':''}>æ‰€æœ‰å¹´é½¡å±¤</option><option value="adult" ${d?.ageRating==='adult'?'selected':''}>æˆäººé™å®š</option></select></div>
              <div style="flex:1; margin-left:8px;"><label>å…¬é–‹è¨­å®š</label><select class="story-public" onchange="saveCurrentChar()"><option value="free" ${d?.publicSetting==='free'?'selected':''}>å…è²»</option><option value="paid" ${d?.publicSetting==='paid'?'selected':''}>ä»˜è²»(10æœé†¬)</option></select></div>
          </div>

          <div class="field-group"><label>è§£é–æç¤ºèª (60å­—)</label><input type="text" class="story-hint" data-maxlength="60" value="${d?.hint||''}" oninput="saveCurrentChar()"></div>
          <div class="field-group"><label>æ•…äº‹æ¨™é¡Œ (30å­—)</label><input type="text" class="story-title" data-maxlength="30" value="${d?.title||''}" oninput="saveCurrentChar()"></div>
          <div class="field-group"><label>å…§å®¹ (2000å­—)</label><textarea class="story-content" data-maxlength="2000" style="min-height:150px;" oninput="saveCurrentChar()">${d?.content||''}</textarea></div>
          <div style="margin-top:10px; padding:10px; background:rgba(0,0,0,0.03); border-radius:8px;">
             <div style="display:flex; justify-content:space-between;"><label>ğŸ”€ å•Ÿç”¨å¤šé‡çµå±€</label><input type="checkbox" class="story-multi-check" id="chk_${uid}" style="width:18px; height:18px;" onchange="toggleOptionsContainer('${uid}');saveCurrentChar()"></div>
             <div id="optCon_${uid}" style="display:none; margin-top:8px;"><div class="options-list"></div><button type="button" class="sec-btn" style="width:100%; font-size:0.8rem;" onclick="addOptionToStory(this)">ï¼‹ æ–°å¢é¸é …</button></div>
          </div>`;
        list.appendChild(div);
        div.querySelector(`#chk_${uid}`).checked = d?.multiEnding || false; toggleOptionsContainer(uid);
        if(d?.options) d.options.forEach(o => addOptionToStory(null, div.querySelector('.options-list'), o));
        setupFieldUtils(div); saveCurrentChar();
    }
    function toggleOptionsContainer(uid) { const c=document.getElementById(`chk_${uid}`); document.getElementById(`optCon_${uid}`).style.display=c.checked?'block':'none'; }
    function addOptionToStory(btn, container=null, d=null) {
       const list = container || btn.previousElementSibling; const div = document.createElement('div'); div.className = 'option-card';
       div.innerHTML = `<div class="option-header">é¸é … <span style="cursor:pointer; color:#ef4444;" onclick="this.closest('.option-card').remove();saveCurrentChar()">Ã—</span></div>
          <div class="field-group"><label style="font-size:0.8rem">é¸é …æ–‡å­—(100å­—)</label><input type="text" class="opt-text" data-maxlength="100" value="${d?.text||''}" placeholder="é¸é …æ–‡å­—" oninput="saveCurrentChar()"></div>
          <div class="field-group"><label style="font-size:0.8rem">å›æ‡‰å…§å®¹(500å­—)</label><textarea class="opt-content" data-maxlength="500" placeholder="å›æ‡‰å…§å®¹" oninput="saveCurrentChar()">${d?.content||''}</textarea></div>
          <div class="label-row"><label>å¥½æ„Ÿ (-20~+20)</label><input type="number" class="opt-score" value="${d?.score||0}" min="-20" max="20" style="width:60px;" oninput="saveCurrentChar()"></div>`;
       list.appendChild(div); setupFieldUtils(div); saveCurrentChar();
    }

    /* ========= å­—æ•¸çµ±è¨ˆ ========= */
    function updateFieldCounter(el) {
      let wrapper = el.nextElementSibling; if(!wrapper || !wrapper.classList.contains('field-utils')) return;
      const len = el.value.length; 
      const max = el.getAttribute('data-maxlength') || el.getAttribute('maxlength');
      
      const counter = wrapper.querySelector('.field-counter');
      if(counter) {
          counter.textContent = max ? `${len} / ${max}` : `${len} å­—`;
          if(max && len>=max) counter.classList.add('limit-reach');
          else counter.classList.remove('limit-reach');
      }
    }
    
    function setupFieldUtils(scope=document) {
       scope.querySelectorAll('textarea, input[type="text"]').forEach(el => {
           if(el.classList.contains('tags-input') || el.nextElementSibling?.classList.contains('field-utils')) return;
           const div = document.createElement('div'); div.className = 'field-utils';
           div.innerHTML = `<span class="field-counter">0 å­—</span><button type="button" class="icon-btn" title="è¤‡è£½" onclick="navigator.clipboard.writeText(this.parentElement.previousElementSibling.value);showToast('å·²è¤‡è£½')">ğŸ“‹</button>`;
           el.parentNode.insertBefore(div, el.nextSibling);
           el.addEventListener('input', ()=>updateFieldCounter(el)); updateFieldCounter(el);
       });
    }
    function addExtra() { addExtraWithVal('',''); }
    function addExtraWithVal(title, text) {
        const div = document.createElement('div'); div.className = 'field-group extra-block';
        div.innerHTML = `<div class="label-row"><label>æ¨™é¡Œ (50å­—)</label><input type="text" class="extra-title-field" data-maxlength="50" value="${title}" oninput="saveCurrentChar()"></div><textarea class="extra-field" data-maxlength="500" placeholder="å…§å®¹(500å­—)" oninput="saveCurrentChar()">${text}</textarea><div style="text-align:right;"><button class="icon-btn" style="display:inline-flex;" onclick="this.closest('.extra-block').remove();saveCurrentChar()">ğŸ—‘ï¸ åˆªé™¤</button></div>`;
        document.getElementById('extraContainer').appendChild(div); setupFieldUtils(div);
    }
    function addEvent() { addEventWithVal('',''); }
    function addEventWithVal(title, text) {
        const div = document.createElement('div'); div.className = 'field-group event-block';
        div.innerHTML = `<div class="label-row"><label>æ¨™é¡Œ (50å­—)</label><input type="text" class="event-title-field" data-maxlength="50" value="${title}" oninput="saveCurrentChar()"></div><textarea class="event-field" data-maxlength="2000" placeholder="å…§å®¹(2000å­—)" oninput="saveCurrentChar()">${text}</textarea><div style="text-align:right;"><button class="icon-btn" style="display:inline-flex;" onclick="this.closest('.event-block').remove();saveCurrentChar()">ğŸ—‘ï¸ åˆªé™¤</button></div>`;
        document.getElementById('eventContainer').appendChild(div); setupFieldUtils(div);
    }

    // åŸºç¤åŠŸèƒ½
    function getStore() { const r=localStorage.getItem(STORAGE_KEY); try{return JSON.parse(r)||_emptyStore();}catch{return _emptyStore();} }
    function _emptyStore(){ return { currentId: null, chars: {}, templates: {basicInfo:[], personality:[], speechStyle:[], extra:[], event:[]} }; }
    function setStore(s) { localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
    function saveCurrentChar() {
       const s = getStore(); const id = s.currentId || ('char_'+Date.now()); s.currentId = id;
       const d = { fields:{}, extras:[], events:[], game:{title:'', intro:'', stories:[]} };
       document.querySelectorAll('input[id], textarea[id], select[id]').forEach(el=>d.fields[el.id]=el.value);
       d.fields['charTags'] = document.getElementById('charTags').value;
       document.querySelectorAll('.extra-block').forEach(b => d.extras.push({title:b.querySelector('input').value, text:b.querySelector('textarea').value}));
       document.querySelectorAll('.event-block').forEach(b => d.events.push({title:b.querySelector('input').value, text:b.querySelector('textarea').value}));
       // éŠæˆ²å­˜æª”
       d.game.title = document.getElementById('gameTitle').value; d.game.intro = document.getElementById('gameIntro').value;
       STORY_STAGES.forEach((st, idx) => {
           const list = document.getElementById(`storyList_${idx}`); if(!list) return;
           list.querySelectorAll('.story-card').forEach(c => {
               const story = { stage:st, stageIdx:idx, hint:c.querySelector('.story-hint').value, title:c.querySelector('.story-title').value, content:c.querySelector('.story-content').value, ageRating:c.querySelector('.story-age').value, publicSetting:c.querySelector('.story-public').value, multiEnding:c.querySelector('.story-multi-check').checked, options:[] };
               if(story.multiEnding) c.querySelectorAll('.option-card').forEach(o => story.options.push({ text:o.querySelector('.opt-text').value, content:o.querySelector('.opt-content').value, score:o.querySelector('.opt-score').value }));
               d.game.stories.push(story);
           });
       });
       s.chars[id] = { meta: { name: d.fields.charName||"æœªå‘½å", createdAt: Date.now() }, data: d };
       setStore(s); renderCharList(s); updateProgress();
    }
    function loadInitialFromStore() { const s=getStore(); if(!s.currentId && Object.keys(s.chars).length) s.currentId=Object.keys(s.chars)[0]; if(s.currentId) fillFormFromData(s.chars[s.currentId].data); renderCharList(s); }
    function fillFormFromData(d) {
        if(!d) return;
        for(let k in d.fields) { const el=document.getElementById(k); if(el) el.value=d.fields[k]; }
        document.getElementById('extraContainer').innerHTML=''; if(d.extras) d.extras.forEach(e=>addExtraWithVal(e.title,e.text));
        document.getElementById('eventContainer').innerHTML=''; if(d.events) d.events.forEach(e=>addEventWithVal(e.title,e.text));
        if(d.game) {
            document.getElementById('gameTitle').value=d.game.title||''; document.getElementById('gameIntro').value=d.game.intro||'';
            STORY_STAGES.forEach((_,i)=>{ document.getElementById(`storyList_${i}`).innerHTML=''; });
            if(d.game.stories) d.game.stories.forEach(s=>{
                let idx = s.stageIdx!==undefined ? s.stageIdx : STORY_STAGES.indexOf(s.stage);
                if(idx===-1) idx=0; addStoryBlock(idx, s);
            });
        }
        initTagInput(); updateChatPreview(); updateProgress(); setupFieldUtils();
    }
    
    // Markdown ç”Ÿæˆ (Strict Format)
    function generateMarkdown() {
      saveCurrentChar();
      const d = getStore().chars[getStore().currentId].data.fields;
      const extras = getStore().chars[getStore().currentId].data.extras;
      const events = getStore().chars[getStore().currentId].data.events;
      const game = getStore().chars[getStore().currentId].data.game;
      
      let md = `# è§’è‰²è¨­å®šï¼š${limitText(d.charName, 15)}\n\n`;
      md += `## åŸºæœ¬æª”æ¡ˆ\n`;
      if(d.charCategory) md += `- åˆ†é¡ï¼š${d.charCategory}\n`;
      if(d.gender) md += `- æ€§åˆ¥ï¼š${d.gender}\n`;
      if(d.charAge) md += `- å¹´é½¡ï¼š${limitText(d.charAge, 15)}\n`;
      if(d.charJob) md += `- è·æ¥­ï¼š${limitText(d.charJob, 15)}\n`;
      if(d.charTags) md += `- æ¨™ç±¤ï¼š${d.charTags}\n`;
      if(d.likes) md += `- å–œæ­¡ï¼š${limitText(d.likes, 50)}\n`;
      if(d.dislikes) md += `- ä¸å–œæ­¡ï¼š${limitText(d.dislikes, 50)}\n`;
      md += `\n`;
      
      md += `## æ ¸å¿ƒè¨­å®š\n`;
      md += `### ç°¡ä»‹\n- ${limitText(d.charQuote, 80)}\n\n`;
      md += `### å¤–è²Œèˆ‡è©³æƒ…\n- ${limitText(d.charDesc, 700)}\n\n`;
      md += `### æ€§æ ¼ç‰¹è³ª\n- ${limitText(d.personality, 700)}\n\n`;
      
      md += `## ä¸–ç•Œè§€\n- ${limitText(d.basicInfo, 700)}\n\n`;
      md += `## èªªè©±é¢¨æ ¼\n- ${limitText(d.speechStyle, 700)}\n\n`;

      if(extras.length) { 
          md += `## é™„åŠ è¨­å®š\n`; 
          extras.forEach((ex, i) => md += `### ${ex.title || `é …ç›® ${i+1}`}\n- ${limitText(ex.text, 500)}\n\n`); 
      }
      if(events.length) { 
          md += `## é—œéµäº‹ä»¶\n`; 
          events.forEach((ev, i) => md += `### ${ev.title || `äº‹ä»¶ ${i+1}`}\n- ${limitText(ev.text, 2000)}\n\n`); 
      }
      
      if(d.firstScene) md += `## é–‹å ´æƒ…å¢ƒ\n- ${limitText(d.firstScene, 800)}\n\n`;
      if(d.sampleDialogue) md += `## å°è©±ç¯„ä¾‹\n- ${limitText(d.sampleDialogue, 800)}\n\n`;
      if(d.creatorNote) md += `> å‰µä½œè€…ç­†è¨˜ï¼š${limitText(d.creatorNote, 200)}`;
      
      if(game && game.title) {
          md += `\n---\n# éŠæˆ²è…³æœ¬è¨­å®š\n\n`;
          md += `## éŠæˆ²è³‡è¨Š\n- æ¨™é¡Œï¼š${limitText(game.title, 30)}\n- ä»‹ç´¹ï¼š${limitText(game.intro, 30)}\n\n`;
          
          if(game.stories) {
              md += `## ç§å¯†ç‰©èªè…³æœ¬\n`;
              const grouped = {};
              STORY_STAGES.forEach(s => grouped[s] = []);
              game.stories.forEach(s => { if(grouped[s.stage]) grouped[s.stage].push(s); });

              STORY_STAGES.forEach(stage => {
                  if(grouped[stage] && grouped[stage].length > 0) {
                      md += `### ã€${stage}ã€‘\n`;
                      grouped[stage].forEach((s, i) => {
                          const ageLabel = s.ageRating === 'adult' ? 'R18' : 'å…¨é½¡';
                          const payLabel = s.publicSetting === 'paid' ? 'ä»˜è²»' : 'å…è²»';
                          md += `#### ${i+1}. ${limitText(s.title, 30) || 'æœªå‘½å'} (${ageLabel} / ${payLabel})\n`;
                          md += `- è§£é–æç¤ºï¼š${limitText(s.hint, 60)}\n`;
                          md += `- å…§å®¹ï¼š${limitText(s.content, 2000)}\n`;
                          if(s.multiEnding && s.options.length) {
                              md += `**å¤šé‡çµå±€é¸é …ï¼š**\n`;
                              s.options.forEach((opt, k) => {
                                  md += `- é¸é … ${k+1}ï¼š${limitText(opt.text, 100)} (å¥½æ„Ÿ ${opt.score>0?'+':''}${opt.score})\n  å›æ‡‰ï¼š${limitText(opt.content, 500)}\n`;
                              });
                          }
                          md += `\n`;
                      });
                  }
              });
          }
      }
      
      document.getElementById('output').textContent = md;
      scrollToSection('sec-output');
      showToast("Markdown å·²ç”Ÿæˆï¼");
    }

    function renderCharList(s) {
       const l = document.getElementById('charList'); l.innerHTML='';
       Object.entries(s.chars).forEach(([id, v]) => {
           const b = document.createElement('button'); b.className = id===s.currentId ? 'main-btn' : 'sec-btn';
           b.textContent = v.meta.name; b.onclick=()=>{ s.currentId=id; setStore(s); fillFormFromData(v.data); renderCharList(s); };
           l.appendChild(b);
       });
    }
    function newCharacter() { const s=getStore(); s.currentId='char_'+Date.now(); setStore(s); location.reload(); }
    function deleteCurrentChar() { const s=getStore(); if(s.currentId && confirm("åˆªé™¤?")) { delete s.chars[s.currentId]; s.currentId=Object.keys(s.chars)[0]||null; setStore(s); location.reload(); } }
    function clearOne(id) { document.getElementById(id).value=''; saveCurrentChar(); }
    function updateChatPreview() {
        document.getElementById('chatHeaderName').textContent = document.getElementById('charName').value || 'è§’è‰²';
        document.getElementById('previewAvatar').textContent = (document.getElementById('charName').value||'A')[0];
        document.getElementById('previewScene').innerHTML = document.getElementById('firstScene').value.replace(/\n/g,'<br>');
        document.getElementById('previewDialogue').innerHTML = document.getElementById('sampleDialogue').value.replace(/\n/g,'<br>');
    }
    
    function initTagInput() {
        const con = document.getElementById('tagsContainer'); const inp = document.getElementById('tagInput'); const hid = document.getElementById('charTags');
        const render = () => {
            con.querySelectorAll('.tag-pill').forEach(e=>e.remove());
            hid.value.split(' ').filter(x=>x).forEach(t => {
                const p = document.createElement('div'); p.className='tag-pill'; p.innerHTML=`<span>#${t}</span><span class="tag-remove" onclick="removeTag('${t}')">Ã—</span>`; con.insertBefore(p, inp);
            });
        };
        inp.addEventListener('keydown', e => {
            if(e.key==='Enter') { e.preventDefault(); const v=inp.value.trim(); if(v){ let arr=hid.value.split(' ').filter(x=>x); if(!arr.includes(v)) arr.push(v); hid.value=arr.join(' '); render(); inp.value=''; saveCurrentChar(); } }
            if(e.key==='Backspace' && !inp.value) { let arr=hid.value.split(' ').filter(x=>x); if(arr.length){ arr.pop(); hid.value=arr.join(' '); render(); saveCurrentChar(); } }
        });
        window.removeTag = t => { let arr=hid.value.split(' ').filter(x=>x); hid.value=arr.filter(x=>x!==t).join(' '); render(); saveCurrentChar(); };
        render();
    }
    
    function limitText(t,m){ return t ? t.trim().slice(0,m) : ''; }
    function showToast(m){ const c=document.getElementById('toastContainer'); const d=document.createElement('div'); d.className='toast'; d.textContent=m; c.appendChild(d); setTimeout(()=>{d.classList.add('fade-out'); d.addEventListener('animationend',()=>d.remove())},2000); }
    function changeTheme(t) { document.body.className=`theme-${t} layout-desktop`; }
    function setLayout(m) { document.body.classList.remove('layout-desktop','layout-mobile'); document.body.classList.add(`layout-${m}`); }
    function toggleSidebar() { document.querySelector('.sidebar').classList.toggle('is-collapsed'); }
    function scrollToSection(id) { document.getElementById(id).scrollIntoView({behavior:'smooth', block:'start'}); }
    function toggleSectionCollapse(id) { document.getElementById(id).classList.toggle('collapsed'); }
    function scrollToTop() { window.scrollTo({top:0, behavior:'smooth'}); }
    window.addEventListener('scroll', () => { document.getElementById('backToTopBtn').classList.toggle('show', window.scrollY>300); });
    
    function renderTemplateManager() {}
    function saveTemplateFromField(type, id) { 
        const val = document.getElementById(id).value; if(!val) { showToast("æ¬„ä½æ˜¯ç©ºçš„", "warn"); return; }
        const name = prompt("æ¨¡æ¿åç¨±ï¼š"); if(name) { const store = getStore(); store.templates[type].push({id: Date.now(), name, text: val}); setStore(store); showToast("æ¨¡æ¿å·²å„²å­˜"); }
    }
    function downloadTxt() { 
        generateMarkdown();
        const txt = document.getElementById('output').textContent;
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([txt], {type: 'text/plain'}));
        a.download = `${document.getElementById('charName').value}_setting.txt`; a.click();
        showToast("å·²ä¸‹è¼‰"); 
    }
    function exportAllData() { 
        const blob = new Blob([localStorage.getItem(STORAGE_KEY)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `qing_backup_${Date.now()}.json`; a.click();
        showToast("å‚™ä»½å·²ä¸‹è¼‰"); 
    }
    function importAllData() {
        const file = document.getElementById('allFile').files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const content = e.target.result;
            try {
                const json = JSON.parse(content);
                localStorage.setItem(STORAGE_KEY, content);
                location.reload();
            } catch (jsonErr) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(content, 'text/html');
                const script = doc.getElementById('app-state');
                if (script && script.textContent) {
                     try {
                         const embeddedData = JSON.parse(script.textContent);
                         setStore(embeddedData);
                         location.reload();
                     } catch (e) { showToast("HTML è³‡æ–™éŒ¯èª¤", "error"); }
                } else { showToast("æª”æ¡ˆæ ¼å¼éŒ¯èª¤", "error"); }
            }
        };
        reader.readAsText(file);
    }
  </script>
</body>
</html>
