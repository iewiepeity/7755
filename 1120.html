<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿å¿æˆ‘æˆ‘å‰µè§’å°å¹«æ‰‹</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap">
  <style>
    :root {
      /* === æ ¸å¿ƒè®Šæ•¸ === */
      --radius-md: 12px;
      --radius-lg: 20px;
      --radius-full: 999px;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
      --shadow-md: 0 8px 24px -6px rgba(0,0,0,0.12);
      --shadow-lg: 0 12px 40px -8px rgba(0,0,0,0.18);
      --transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
      
      /* èƒŒæ™¯è‰²ç³»å®šç¾© */
      --bg-pink: #ffeef5; --accent-pink: #ff8ebf;
      --bg-cream: #fffbf2; --accent-cream: #ffad6b;
      --bg-mint: #f0fffa; --accent-mint: #5cd6ad;
      --bg-lavender: #f9f2ff; --accent-lavender: #c4a3ff;
      --bg-sky: #f0f9ff; --accent-sky: #7ac0ff;
      --bg-lemon: #fffeec; --accent-lemon: #ffe066;
      --bg-grey: #f7f7f7; --accent-grey: #999;
      --bg-black: #1a1a1a; --accent-black: #666;

      /* é è¨­è®Šæ•¸ (ç”± body class è¦†å¯«) */
      --page-bg: var(--bg-pink);
      --card-bg: rgba(255, 255, 255, 0.85);
      --sidebar-bg: rgba(255, 255, 255, 0.9);
      --text-main: #4a3b45;
      --text-sub: #7a6b75;
      --border-color: rgba(0,0,0,0.08);
      --focus-color: var(--accent-pink);
      --btn-bg: var(--accent-pink);
      --btn-text: #fff;
    }

    /* === å…¨å±€è¨­å®š === */
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 20px;
      font-family: "Noto Sans TC", system-ui, sans-serif;
      line-height: 1.7;
      color: var(--text-main);
      background-color: var(--page-bg);
      /* åŠ å…¥ç´°å¾®çš„èƒŒæ™¯ç´‹ç† */
      background-image: radial-gradient(rgba(0,0,0,0.03) 1px, transparent 1px);
      background-size: 24px 24px;
      transition: background 0.3s ease, color 0.3s ease;
      min-height: 100vh;
    }

    /* === ä¸»é¡Œè‰²è¦†å¯« === */
    body.theme-pink { --page-bg: var(--bg-pink); --focus-color: #ff8ebf; --btn-bg: #ff6fa8; }
    body.theme-cream { --page-bg: var(--bg-cream); --focus-color: #ffad6b; --btn-bg: #ff9c4a; }
    body.theme-mint { --page-bg: var(--bg-mint); --focus-color: #5cd6ad; --btn-bg: #42c79a; }
    body.theme-lavender { --page-bg: var(--bg-lavender); --focus-color: #c4a3ff; --btn-bg: #b48cff; }
    body.theme-sky { --page-bg: var(--bg-sky); --focus-color: #7ac0ff; --btn-bg: #58a9ff; }
    body.theme-lemon { --page-bg: var(--bg-lemon); --focus-color: #ffe066; --btn-bg: #ffd93b; --btn-text: #5c4e00; }
    body.theme-grey { --page-bg: var(--bg-grey); --focus-color: #999; --btn-bg: #b0b0b0; }
    
    body.theme-black { 
      --page-bg: var(--bg-black); 
      --card-bg: rgba(40, 40, 40, 0.85);
      --sidebar-bg: rgba(30, 30, 30, 0.95);
      --text-main: #e0e0e0;
      --text-sub: #aaa;
      --border-color: rgba(255,255,255,0.15);
      --focus-color: #888;
      --btn-bg: #555;
      --btn-text: #fff;
      background-image: radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px);
    }

    /* === ä½ˆå±€å®¹å™¨ === */
    .layout-shell {
      display: flex;
      align-items: flex-start;
      gap: 24px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .main-area {
      flex: 1;
      min-width: 0; /* é˜²æ­¢ flex å­å…ƒç´ æº¢å‡º */
    }

    /* === æ’ç‰ˆ Typography === */
    h1, h2, h3 {
      font-family: "Noto Serif TC", serif;
      margin-top: 0;
      color: var(--text-main);
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 8px;
      font-weight: 700;
    }

    h2 {
      font-size: 1.25rem;
      margin-bottom: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-bottom: 8px;
      border-bottom: 1px dashed var(--border-color);
    }

    .tagline {
      color: var(--text-sub);
      font-size: 0.95rem;
      margin-bottom: 20px;
    }

    .top-bar {
      max-width: 1200px;
      margin: 0 auto 20px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      flex-wrap: wrap;
      gap: 16px;
    }

    .sub-label {
      font-size: 0.85rem;
      color: var(--text-sub);
      margin-top: 4px;
      display: block;
    }

    /* === å´é‚Šæ¬„ Sidebar === */
    .sidebar {
      width: 260px;
      min-width: 260px;
      position: sticky;
      top: 20px;
      background: var(--sidebar-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 16px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(255,255,255,0.3);
      transition: var(--transition);
      z-index: 10;
      overflow: hidden;
    }
    
    /* å´é‚Šæ¬„æ”¶åˆæ¨¡å¼ */
    .sidebar.is-collapsed {
      width: 64px;
      min-width: 64px;
      padding: 16px 8px;
    }
    
    .sidebar.is-collapsed .sidebar-title,
    .sidebar.is-collapsed .sidebar-sub {
      display: none;
    }
    
    .sidebar.is-collapsed .sidebar-header {
      justify-content: center;
      margin-bottom: 16px;
    }

    .sidebar.is-collapsed .sidebar-nav button {
      justify-content: center;
      padding: 8px;
    }
    
    .sidebar.is-collapsed .sidebar-nav button span.btn-text {
      display: none;
    }
    
    .sidebar.is-collapsed .sidebar-nav button span.btn-icon {
      margin-right: 0;
      font-size: 1.2rem;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .sidebar-title {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--text-main);
    }

    .sidebar-sub {
      font-size: 0.8rem;
      color: var(--text-sub);
      margin-bottom: 12px;
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .sidebar-nav button {
      width: 100%;
      text-align: left;
      background: transparent;
      color: var(--text-main);
      box-shadow: none;
      border: 1px solid transparent;
      padding: 8px 12px;
      border-radius: 8px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }

    .sidebar-nav button:hover {
      background: rgba(0,0,0,0.05);
      transform: translateX(4px);
    }
    
    body.theme-black .sidebar-nav button:hover {
      background: rgba(255,255,255,0.1);
    }

    .sidebar-nav button.sidebar-main {
      font-weight: 600;
    }

    .sidebar-nav button.sidebar-subitem {
      font-size: 0.9rem;
      color: var(--text-sub);
      padding-left: 12px;
    }
    
    .sidebar-nav button span.btn-icon {
      margin-right: 8px;
      width: 20px;
      text-align: center;
    }

    /* === å…§å®¹å€å¡Š Card Style === */
    .section {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: var(--radius-lg);
      padding: 24px 28px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(255,255,255,0.4);
      transition: var(--transition);
    }

    .section:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .section.collapsed .section-body {
      display: none;
    }
    
    .section.collapsed {
      padding-bottom: 16px;
      opacity: 0.7;
    }

    .section-body {
      margin-top: 16px;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* === è¡¨å–®å…ƒç´  Forms === */
    .label-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    label {
      font-weight: 500;
      color: var(--text-main);
      margin-right: 8px;
    }

    input[type="text"],
    input[type="search"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 10px 14px;
      font-size: 0.95rem;
      font-family: inherit;
      color: var(--text-main);
      background: rgba(255,255,255,0.6);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      transition: var(--transition);
      margin-bottom: 12px;
      outline: none;
    }
    
    body.theme-black input,
    body.theme-black select,
    body.theme-black textarea {
      background: rgba(0,0,0,0.3);
      color: #fff;
    }

    textarea {
      min-height: 100px;
      line-height: 1.6;
      resize: vertical;
    }

    input:focus, select:focus, textarea:focus {
      background: #fff;
      border-color: var(--focus-color);
      box-shadow: 0 0 0 3px rgba(var(--focus-color), 0.2); /* æ¨¡æ“¬å…‰æšˆï¼Œéœ€èª¿æ•´rgba */
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--focus-color), transparent 80%);
    }
    
    body.theme-black input:focus, 
    body.theme-black textarea:focus {
      background: rgba(0,0,0,0.5);
    }

    /* === æŒ‰éˆ• Buttons === */
    button {
      cursor: pointer;
      border: none;
      border-radius: var(--radius-full);
      padding: 8px 16px;
      font-size: 0.9rem;
      font-family: inherit;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--btn-bg);
      color: var(--btn-text);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: var(--transition);
      margin-right: 6px;
      margin-bottom: 6px;
    }

    button:hover {
      filter: brightness(1.08);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    button:active {
      transform: translateY(0);
    }

    /* æ¬¡è¦æŒ‰éˆ• / å°æŒ‰éˆ• */
    .button-secondary, .button-mini {
      background: transparent;
      color: var(--text-main);
      border: 1px solid var(--border-color);
      box-shadow: none;
    }

    .button-secondary:hover, .button-mini:hover {
      background: rgba(0,0,0,0.05);
      border-color: var(--focus-color);
      color: var(--focus-color);
    }
    
    body.theme-black .button-secondary:hover, 
    body.theme-black .button-mini:hover {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }

    .button-mini {
      padding: 3px 10px;
      font-size: 0.75rem;
      margin: 0;
    }
    
    /* å´é‚Šæ¬„åˆ‡æ›æŒ‰éˆ• */
    .sidebar-toggle-btn {
      width: 28px;
      height: 28px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.05);
      color: var(--text-sub);
      border-radius: 50%;
      margin: 0;
      box-shadow: none;
    }
    .sidebar-toggle-btn:hover {
      background: var(--focus-color);
      color: #fff;
    }

    /* === è¼¸å‡ºå€å¡Š Output === */
    #output {
      background: #222;
      color: #f0f0f0;
      padding: 16px;
      border-radius: var(--radius-md);
      font-family: "Menlo", "Monaco", "Courier New", monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
      line-height: 1.5;
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
      margin-top: 12px;
    }

    /* === å‹•æ…‹ç”Ÿæˆçš„å€å¡Š === */
    .tpl-card {
      background: rgba(0,0,0,0.02);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .tpl-card:hover {
      border-color: var(--focus-color);
    }
    .tpl-name { font-weight: 700; margin-bottom: 4px; color: var(--text-main); }
    .tpl-meta { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 6px; }
    .tpl-preview { 
      font-size: 0.85rem; color: var(--text-sub); 
      background: rgba(0,0,0,0.03); padding: 6px; border-radius: 4px;
      white-space: pre-wrap;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
    }
    
    .field-utils {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      margin-top: -8px;
      margin-bottom: 16px;
      font-size: 0.75rem;
      color: var(--text-sub);
    }
    
    .extra-block, .event-block {
      border-left: 3px solid var(--border-color);
      padding-left: 16px;
      margin-bottom: 24px;
      transition: border-color 0.3s;
    }
    .extra-block:hover, .event-block:hover {
      border-left-color: var(--focus-color);
    }

    /* === RWD éŸ¿æ‡‰å¼ === */
    @media (max-width: 850px) {
      .layout-shell {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        min-width: 100%;
        position: static;
        margin-bottom: 20px;
        /* æ‰‹æ©Ÿç‰ˆå´é‚Šæ¬„æ”¹ç‚ºæ©«å‘æ»¾å‹•é¸å–® */
        display: flex;
        flex-direction: column;
        padding: 12px;
      }
      .sidebar-header {
         display: none; /* æ‰‹æ©Ÿç‰ˆéš±è—å´é‚Šæ¬„æ¨™é¡Œï¼Œç¯€çœç©ºé–“ */
      }
      .sidebar-nav {
        flex-direction: row;
        overflow-x: auto;
        gap: 8px;
        padding-bottom: 4px;
        /* éš±è—å·è»¸ */
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
      }
      .sidebar-nav::-webkit-scrollbar {
        display: none;
      }
      .sidebar-nav button {
        white-space: nowrap;
        width: auto;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
      }
      .section {
        padding: 16px 20px;
      }
    }
    
    /* å¼·åˆ¶æ’ç‰ˆæ¨£å¼ (é€é JS åˆ‡æ› class) */
    body.layout-mobile .layout-shell { flex-direction: column; }
    body.layout-mobile .sidebar { width: 100%; position: static; margin-bottom: 16px; }
    body.layout-mobile .sidebar-nav { flex-direction: row; overflow-x: auto; padding-bottom: 5px; }
    body.layout-mobile .sidebar-nav button { width: auto; white-space: nowrap; }
    
    body.layout-desktop .layout-shell { flex-direction: row; }
    body.layout-desktop .sidebar { width: 260px; position: sticky; }
    body.layout-desktop .sidebar-nav { flex-direction: column; overflow-x: visible; }

  </style>
</head>
<body class="theme-pink layout-desktop">

  <div class="top-bar">
    <div>
      <h1>ğŸ’• å¿å¿æˆ‘æˆ‘å‰µè§’å°å¹«æ‰‹</h1>
      <div class="tagline">å¡«å¯«è¨­å®šï¼Œä¸€éµç”Ÿæˆ AI è§’è‰²å¡ Markdownï¼Œè®“æ•…äº‹é–‹å§‹ã€‚</div>
    </div>
    <div class="theme-select">
      <label style="font-size:0.9rem;">èƒŒæ™¯ä¸»é¡Œï¼š</label>
      <select onchange="changeTheme(this.value)" style="width:auto; display:inline-block; padding:6px 10px; margin-bottom:0;">
        <option value="pink" selected>ğŸŒ¸ æ·¡ç²‰ç´…</option>
        <option value="cream">ğŸ å¥¶æ²¹ç™½</option>
        <option value="mint">ğŸŒ¿ è–„è·ç¶ </option>
        <option value="lavender">ğŸ”® è–°è¡£è‰</option>
        <option value="sky">â˜ï¸ å¤©ç©ºè—</option>
        <option value="lemon">ğŸ‹ æª¸æª¬é»ƒ</option>
        <option value="grey">ğŸŒ«ï¸ æ¥µç°¡ç°</option>
        <option value="black">ğŸŒ™ æ·±å¤œé»‘</option>
      </select>
    </div>
  </div>

  <div style="max-width:1200px; margin:0 auto 20px; opacity:0.8;">
      <p class="sub-label">â€» å„æ¬„ä½æ”¯æ´ Markdown èªæ³•ã€‚è«‹å–„ç”¨ã€ŒåŒ¯å‡ºå­˜æª”ã€åŠŸèƒ½é¿å…è³‡æ–™éºå¤±ã€‚</p>
  </div>

  <div class="layout-shell">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">ğŸ“ åŠŸèƒ½å°èˆª</div>
        <button type="button" class="sidebar-toggle-btn" onclick="toggleSidebar()" title="æ”¶åˆ/å±•é–‹">
          â—€
        </button>
      </div>
      
      <div class="sidebar-sub">é»æ“Šå¿«é€Ÿè·³è½‰</div>
      
      <nav class="sidebar-nav">
        <button type="button" class="sidebar-main" onclick="scrollToSection('sec-archive')">
          <span class="btn-icon">ğŸ“‚</span><span class="btn-text">è§’è‰²å­˜æª”ç®¡ç†</span>
        </button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-info')">
          <span class="btn-icon">ğŸ’â€â™€ï¸</span><span class="btn-text">è§’è‰²è³‡è¨Š</span>
        </button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-gender')">
          <span class="btn-icon">ğŸš»</span><span class="btn-text">æ€§åˆ¥è¨­å®š</span>
        </button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-basic')">
          <span class="btn-icon">ğŸŒ</span><span class="btn-text">åŸºæœ¬è³‡è¨Š (ä¸–ç•Œè§€)</span>
        </button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-personality')">
          <span class="btn-icon">ğŸ’—</span><span class="btn-text">æ€§æ ¼èˆ‡ç‰¹è³ª</span>
        </button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-speech')">
          <span class="btn-icon">ğŸ—£ï¸</span><span class="btn-text">èªªè©±é¢¨æ ¼</span>
        </button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-prompt')">
          <span class="btn-icon">ğŸ§ </span><span class="btn-text">æ¨¡å‹ & Prompt</span>
        </button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-first')">
          <span class="btn-icon">ğŸ¬</span><span class="btn-text">é–‹å ´èˆ‡å°è©±</span>
        </button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-fav')">
          <span class="btn-icon">ğŸ€</span><span class="btn-text">å–œå¥½èˆ‡ç”Ÿæ—¥</span>
        </button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-extra')">
          <span class="btn-icon">ğŸ“Œ</span><span class="btn-text">é™„åŠ è³‡è¨Š</span>
        </button>
        <button type="button" class="sidebar-subitem" onclick="scrollToSection('sec-event')">
          <span class="btn-icon">ğŸ“š</span><span class="btn-text">å‰µä½œè€…äº‹ä»¶</span>
        </button>
        <button type="button" class="sidebar-main" onclick="scrollToSection('sec-output')">
          <span class="btn-icon">ğŸ“</span><span class="btn-text">è¼¸å‡ºèˆ‡åŒ¯å…¥</span>
        </button>
        <button type="button" class="sidebar-main" onclick="scrollToSection('sec-template-center')">
          <span class="btn-icon">ğŸ§°</span><span class="btn-text">æ¨¡æ¿ç®¡ç†</span>
        </button>
        <button type="button" class="sidebar-main" onclick="scrollToSection('sec-layout')">
          <span class="btn-icon">ğŸ“±</span><span class="btn-text">ç‰ˆé¢åˆ‡æ›</span>
        </button>
      </nav>
    </aside>

    <main class="main-area">

      <div class="section" id="sec-archive">
        <h2>
          <span>ğŸ“‚ è§’è‰²å­˜æª”ç®¡ç†</span>
          <button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-archive')">â‡•</button>
        </h2>
        <div class="section-body">
          <div class="label-row">
            <div style="flex:1; margin-right:12px;">
              <label>åˆ†é¡ç¯©é¸</label>
              <select id="filterCategory" onchange="refreshCharListFromStorage()">
                <option value="">å…¨éƒ¨åˆ†é¡</option>
              </select>
            </div>
            <div style="flex:1; margin-right:12px;">
              <label>æ’åºæ–¹å¼</label>
              <select id="charSort" onchange="refreshCharListFromStorage()">
                <option value="created_desc">æ–° â èˆŠ</option>
                <option value="created_asc">èˆŠ â æ–°</option>
                <option value="name_asc">åç¨± A â Z</option>
              </select>
            </div>
             <div style="flex:1;">
              <label>æœå°‹</label>
              <input id="searchName" type="search" placeholder="è¼¸å…¥åå­—..." oninput="refreshCharListFromStorage()" />
            </div>
          </div>

          <div id="charList" style="margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; min-height:40px;">
            </div>

          <div style="margin-top:16px; border-top:1px dashed var(--border-color); padding-top:16px;">
            <button type="button" onclick="newCharacter()">â• æ–°è§’è‰²</button>
            <button type="button" onclick="saveCurrentChar()">ğŸ’¾ å„²å­˜ç›®å‰è§’è‰²</button>
            <button type="button" class="button-secondary" onclick="deleteCurrentChar()" style="float:right;">ğŸ—‘ åˆªé™¤</button>
          </div>
        </div>
      </div>

      <div class="section" id="sec-info">
        <h2>
          <span>ğŸ’â€â™€ï¸ è§’è‰²è³‡è¨Š</span>
          <button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-info')">â‡•</button>
        </h2>
        <div class="section-body">

          <div class="label-row">
            <label>è§’è‰²åç¨± <span style="color:red;font-size:0.8em;">*</span></label>
            <button type="button" class="button-mini" onclick="clearOne('charName')">æ¸…ç©º</button>
          </div>
          <input id="charName" type="text" placeholder="ä¾‹å¦‚ï¼šæ—æœˆå¦‚" />

          <div class="label-row">
            <label>è§’è‰²åˆ†é¡</label>
            <button type="button" class="button-mini" onclick="clearOne('charCategory')">æ¸…ç©º</button>
          </div>
          <input id="charCategory" type="text" placeholder="ä¾‹å¦‚ï¼šç¾ä»£ã€å¥‡å¹»ã€OC..." />

          <div class="label-row">
            <div style="flex:1; margin-right:10px;">
               <label>å¹´é½¡ <span style="color:red;font-size:0.8em;">*</span></label>
               <input id="charAge" type="text" data-maxlength="15" placeholder="ä¾‹å¦‚ï¼š18æ­²" />
            </div>
            <div style="flex:1;">
               <label>è·æ¥­ <span style="color:red;font-size:0.8em;">*</span></label>
               <input id="charJob" type="text" data-maxlength="15" placeholder="ä¾‹å¦‚ï¼šå­¸ç”Ÿ" />
            </div>
          </div>

          <div class="label-row">
            <label>ä¾†è‡ªè§’è‰²çš„ä¸€å¥è©± <span style="color:red;font-size:0.8em;">*</span></label>
            <button type="button" class="button-mini" onclick="clearOne('charQuote')">æ¸…ç©º</button>
          </div>
          <textarea id="charQuote" style="min-height:60px;" data-maxlength="80" placeholder="é¡¯ç¤ºåœ¨åˆ—è¡¨çš„çŸ­ä»‹ç´¹"></textarea>

          <div class="label-row">
            <label>æ•˜è¿° (Description)</label>
            <button type="button" class="button-mini" onclick="clearOne('charDesc')">æ¸…ç©º</button>
          </div>
          <textarea id="charDesc" data-maxlength="700" placeholder="è§’è‰²çš„å¤–è²Œã€æ°£è³ªç­‰è©³ç´°æå¯«"></textarea>

          <div class="label-row">
            <label>æ¨™ç±¤ (Hashtag)</label>
            <button type="button" class="button-mini" onclick="clearOne('charTags')">æ¸…ç©º</button>
          </div>
          <input id="charTags" type="text" placeholder="ç”¨ç©ºç™½æˆ–é€—è™Ÿåˆ†éš”ï¼Œå¦‚ï¼šå‚²å¬Œ, é›™é¦¬å°¾" />

          <div class="label-row">
            <label>å‰µä½œè€…ç­†è¨˜</label>
            <button type="button" class="button-mini" onclick="clearOne('creatorNote')">æ¸…ç©º</button>
          </div>
          <textarea id="creatorNote" style="min-height:70px;" data-maxlength="200"></textarea>
        </div>
      </div>

      <div class="section" id="sec-gender">
        <h2>
          <span>ğŸš» æ€§åˆ¥</span>
          <button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-gender')">â‡•</button>
        </h2>
        <div class="section-body">
          <select id="gender">
            <option value="æœªè¨­ç½®" selected>æœªè¨­ç½®</option>
            <option value="ç”·æ€§">ç”·æ€§</option>
            <option value="å¥³æ€§">å¥³æ€§</option>
          </select>
        </div>
      </div>

      <div class="section" id="sec-basic">
        <h2>
          <span>ğŸŒ ä¸€ã€åŸºæœ¬è³‡è¨Š</span>
          <button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-basic')">â‡•</button>
        </h2>
        <div class="section-body">
          <p class="sub-label">å¿…å¡«ã€‚å»ºè­° â‰¤700å­—ã€‚æè¿°è§’è‰²èƒŒæ™¯ã€ä¸–ç•Œè§€ã€æ™‚é–“é»ã€èˆ‡ç©å®¶çš„é—œä¿‚ç­‰ã€‚</p>
          <div class="label-row" style="justify-content:flex-end; margin-bottom:8px;">
              <select data-template-type="basicInfo"
                      onchange="applyTemplateSingle('basicInfo','basicInfo',this)"
                      class="button-mini" style="width:auto; margin:0;">
                <option value="">âœ¨ å¥—ç”¨æ¨¡æ¿â€¦</option>
              </select>
              <button type="button" class="button-mini" onclick="saveTemplateFromField('basicInfo','basicInfo')">å­˜ç‚ºæ¨¡æ¿</button>
              <button type="button" class="button-mini" onclick="clearOne('basicInfo')">æ¸…ç©º</button>
          </div>
          <textarea id="basicInfo" data-maxlength="700"></textarea>
        </div>
      </div>

      <div class="section" id="sec-personality">
        <h2>
          <span>ğŸ’— äºŒã€æ€§æ ¼</span>
          <button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-personality')">â‡•</button>
        </h2>
        <div class="section-body">
           <p class="sub-label">å¿…å¡«ã€‚å»ºè­° â‰¤700å­—ã€‚æè¿°å°æ™®é€šäºº vs å°ç©å®¶çš„å·®ç•°ï¼Œæˆ–å…§å¿ƒæ´»å‹•ã€‚</p>
          <div class="label-row" style="justify-content:flex-end; margin-bottom:8px;">
              <select data-template-type="personality"
                      onchange="applyTemplateSingle('personality','personality',this)"
                      class="button-mini" style="width:auto; margin:0;">
                <option value="">âœ¨ å¥—ç”¨æ¨¡æ¿â€¦</option>
              </select>
              <button type="button" class="button-mini" onclick="saveTemplateFromField('personality','personality')">å­˜ç‚ºæ¨¡æ¿</button>
              <button type="button" class="button-mini" onclick="clearOne('personality')">æ¸…ç©º</button>
          </div>
          <textarea id="personality" data-maxlength="700"></textarea>
        </div>
      </div>

      <div class="section" id="sec-speech">
        <h2>
          <span>ğŸ—£ï¸ ä¸‰ã€èªªè©±é¢¨æ ¼èˆ‡ç¿’æ…£</span>
          <button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-speech')">â‡•</button>
        </h2>
        <div class="section-body">
          <p class="sub-label">å¿…å¡«ã€‚å»ºè­° â‰¤700å­—ã€‚ä¾‹å¦‚ï¼šèªæ°£ã€å£é ­ç¦ªã€å°ç©å®¶çš„ç¨±å‘¼ã€‚</p>
          <div class="label-row" style="justify-content:flex-end; margin-bottom:8px;">
              <select data-template-type="speechStyle"
                      onchange="applyTemplateSingle('speechStyle','speechStyle',this)"
                      class="button-mini" style="width:auto; margin:0;">
                <option value="">âœ¨ å¥—ç”¨æ¨¡æ¿â€¦</option>
              </select>
              <button type="button" class="button-mini" onclick="saveTemplateFromField('speechStyle','speechStyle')">å­˜ç‚ºæ¨¡æ¿</button>
              <button type="button" class="button-mini" onclick="clearOne('speechStyle')">æ¸…ç©º</button>
          </div>
          <textarea id="speechStyle" data-maxlength="700"></textarea>
        </div>
      </div>

      <div class="section" id="sec-prompt">
        <h2>
          <span>ğŸ§  æ¨¡å‹èˆ‡ Prompt è¨­å®š</span>
          <button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-prompt')">â‡•</button>
        </h2>
        <div class="section-body">
          <div class="label-row"><label>ä½¿ç”¨æ¨¡å‹</label></div>
          <select id="modelType" onchange="updatePromptTokenInfo(); saveCurrentChar();">
            <option value="claude-haiku" data-basecost="5">Claude Haikuï¼ˆèµ·åƒ¹ 5 æœé†¬ï¼‰</option>
            <option value="claude-sonnet" data-basecost="15">Claude Sonnetï¼ˆèµ·åƒ¹ 15 æœé†¬ï¼‰</option>
            <option value="gemini-3" data-basecost="10" selected>Gemini 3ï¼ˆèµ·åƒ¹ 10 æœé†¬ï¼‰</option>
          </select>

          <div class="label-row" style="margin-top:12px;">
            <label>Roleï¼ˆç³»çµ±æç¤ºï¼‰</label>
            <button type="button" class="button-mini" onclick="clearOne('promptRole')">æ¸…ç©º</button>
          </div>
          <textarea id="promptRole" data-maxlength="2000" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä½åªå°ç©å®¶æº«æŸ”ã€æœƒä¸»å‹•å¸¶è©±é¡Œçš„æˆ€æ„›è§’è‰²â€¦â€¦"></textarea>

          <div class="label-row">
            <label>Response Guidelineï¼ˆå›æ‡‰è¦å‰‡ï¼‰</label>
            <button type="button" class="button-mini" onclick="clearOne('promptGuideline')">æ¸…ç©º</button>
          </div>
          <textarea id="promptGuideline" data-maxlength="3000" placeholder="ä¾‹å¦‚ï¼šè«‹ç”¨ç¬¬ä¸€äººç¨±å’Œç©å®¶èªªè©±ã€é¿å…æåˆ°è‡ªå·±æ˜¯ AIâ€¦â€¦"></textarea>

          <div style="background:rgba(0,0,0,0.03); padding:10px; border-radius:8px; margin-top:10px;">
            <div id="promptTokenInfo" class="sub-label" style="color:var(--text-main);"></div>
            <div id="promptJamInfo" class="sub-label" style="font-weight:bold;"></div>
          </div>
        </div>
      </div>

      <div class="section" id="sec-first">
        <h2>
          <span>ğŸ¬ ç¬¬ä¸€æ¬¡èŠå¤©å ´æ™¯èˆ‡å°è©±</span>
          <button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-first')">â‡•</button>
        </h2>
        <div class="section-body">
          <div class="label-row">
            <label>ç¬¬ä¸€æ¬¡èŠå¤©å ´æ™¯</label>
            <button type="button" class="button-mini" onclick="clearOne('firstScene')">æ¸…ç©º</button>
          </div>
          <textarea id="firstScene" data-maxlength="800" placeholder="è¨­å®šé–‹å ´æƒ…å¢ƒ..."></textarea>

          <div class="label-row">
            <label>è§’è‰²å°è©±ç¯„ä¾‹</label>
            <button type="button" class="button-mini" onclick="clearOne('sampleDialogue')">æ¸…ç©º</button>
          </div>
          <textarea id="sampleDialogue" data-maxlength="800" placeholder="è§’è‰²å¯èƒ½æœƒèªªçš„è©±..."></textarea>
        </div>
      </div>

      <div class="section" id="sec-fav">
        <h2>
          <span>ğŸ€ å–œå¥½èˆ‡ç”Ÿæ—¥</span>
          <button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-fav')">â‡•</button>
        </h2>
        <div class="section-body">
          <div class="label-row">
            <label>å–œæ­¡çš„æ±è¥¿</label>
            <button type="button" class="button-mini" onclick="clearOne('likes')">æ¸…ç©º</button>
          </div>
          <input id="likes" type="text" data-maxlength="50" />

          <div class="label-row">
            <label>ä¸å–œæ­¡çš„æ±è¥¿</label>
            <button type="button" class="button-mini" onclick="clearOne('dislikes')">æ¸…ç©º</button>
          </div>
          <input id="dislikes" type="text" data-maxlength="50" />

          <div class="label-row">
            <label>ç”Ÿæ—¥</label>
            <button type="button" class="button-mini" onclick="clearOne('birthday')">æ¸…ç©º</button>
          </div>
          <input id="birthday" type="date" style="max-width:200px;" />
        </div>
      </div>

      <div class="section" id="sec-extra">
        <h2>
          <span>ğŸ“Œ é™„åŠ è³‡è¨Š</span>
          <button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-extra')">â‡•</button>
        </h2>
        <div class="section-body">
          <p class="sub-label">æœ€å¤š 10 ç­†ï¼Œå¯ç”¨æ–¼è£œå……ä¸–ç•Œè§€ç´°ç¯€ã€‚</p>
          <div id="extraContainer"></div>
          
          <div style="margin-top:12px;">
              <button type="button" onclick="addExtra()">ï¼‹ æ–°å¢é™„åŠ è³‡è¨Š</button>
              <button type="button" class="button-secondary" onclick="document.getElementById('extraContainer').innerHTML=''; saveCurrentChar();">æ¸…ç©ºå…¨éƒ¨</button>
          </div>
        </div>
      </div>

      <div class="section" id="sec-event">
        <h2>
          <span>ğŸ“š å‰µä½œè€…äº‹ä»¶</span>
          <button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-event')">â‡•</button>
        </h2>
        <div class="section-body">
          <p class="sub-label">æœ€å¤š 20 ç­†ï¼Œç”¨æ–¼ç´€éŒ„æ•…äº‹ç‰‡æ®µã€‚</p>
          <div id="eventContainer"></div>

          <div style="margin-top:12px;">
            <button type="button" onclick="addEvent()">ï¼‹ æ–°å¢å‰µä½œè€…äº‹ä»¶</button>
            <button type="button" class="button-secondary" onclick="document.getElementById('eventContainer').innerHTML=''; saveCurrentChar();">æ¸…ç©ºå…¨éƒ¨</button>
          </div>
        </div>
      </div>

      <div class="section" id="sec-output">
        <h2>
          <span>ğŸ“ è¼¸å‡ºèˆ‡åŒ¯å…¥</span>
          <button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-output')">â‡•</button>
        </h2>
        <div class="section-body">
          <div class="actions-row" style="margin-bottom:16px;">
            <button onclick="generateMarkdown()" style="width:100%; justify-content:center; padding:12px; font-size:1rem;">âœ¨ ç”Ÿæˆ Markdown è§’è‰²å¡</button>
          </div>

          <div class="label-row" style="border-top:1px solid var(--border-color); padding-top:12px; margin-top:12px;">
             <div style="flex:1;">
                <label>å–®ä¸€è§’è‰²æ“ä½œ (.txt)</label>
                <div style="display:flex; gap:8px; margin-top:4px; flex-wrap:wrap;">
                   <button class="button-secondary" type="button" onclick="downloadTxt()">â¬‡ ä¸‹è¼‰ç›®å‰è§’è‰²</button>
                   <label class="button-secondary" style="cursor:pointer; margin:0;">
                      ğŸ“‚ åŒ¯å…¥ .txt
                      <input id="txtFile" type="file" accept=".txt" style="display:none;" onchange="importTxt()" />
                   </label>
                </div>
             </div>
          </div>

           <div class="label-row" style="border-top:1px solid var(--border-color); padding-top:12px; margin-top:12px;">
             <div style="flex:1;">
                <label>å®Œæ•´å‚™ä»½ (.json)</label>
                <div style="display:flex; gap:8px; margin-top:4px; flex-wrap:wrap;">
                   <button class="button-secondary" type="button" onclick="exportAllData()">ğŸ“¦ å‚™ä»½æ‰€æœ‰è³‡æ–™</button>
                   <label class="button-secondary" style="cursor:pointer; margin:0;">
                      ğŸ“¥ é‚„åŸå‚™ä»½
                      <input id="allFile" type="file" accept=".json" style="display:none;" onchange="importAllData()" />
                   </label>
                </div>
             </div>
          </div>

          <h3 style="margin-top:24px; font-size:1rem;">ğŸ–¨ è¼¸å‡ºé è¦½</h3>
          <div id="output"></div>
        </div>
      </div>

      <div class="section" id="sec-template-center">
        <h2>
          <span>ğŸ§° æ¨¡æ¿ç®¡ç†ä¸­å¿ƒ</span>
          <button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-template-center')">â‡•</button>
        </h2>
        <div class="section-body">
          <div class="label-row">
            <label>ç¯©é¸æ¨¡æ¿é¡å‹ï¼š</label>
            <select id="tplFilter" onchange="renderTemplateManager()" style="width:auto;">
              <option value="">å…¨éƒ¨é¡å‹</option>
              <option value="basicInfo">ä¸€ã€åŸºæœ¬è³‡è¨Š</option>
              <option value="personality">äºŒã€æ€§æ ¼</option>
              <option value="speechStyle">ä¸‰ã€èªªè©±é¢¨æ ¼èˆ‡ç¿’æ…£</option>
              <option value="extra">é™„åŠ è³‡è¨Š</option>
              <option value="event">å‰µä½œè€…äº‹ä»¶</option>
            </select>
          </div>
          <div id="tplManagerList"></div>
        </div>
      </div>

      <div class="section" id="sec-layout">
        <h2>
          <span>ğŸ“± ç‰ˆé¢åˆ‡æ›</span>
          <button type="button" class="button-mini" onclick="toggleSectionCollapse('sec-layout')">â‡•</button>
        </h2>
        <div class="section-body">
          <div style="display:flex; gap:10px;">
              <button type="button" class="button-secondary" onclick="setLayout('desktop')">ğŸ’» é›»è…¦ç‰ˆ</button>
              <button type="button" class="button-secondary" onclick="setLayout('mobile')">ğŸ“± æ‰‹æ©Ÿç‰ˆ</button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script>
    const EXTRA_MAX = 10;
    const EVENT_MAX = 20;
    const STORAGE_KEY = 'qing_char_multi_v1';
    const TEMPLATE_TYPES = ['basicInfo','personality','speechStyle','extra','event'];
    const TEMPLATE_TYPE_LABELS = {
      basicInfo: 'ä¸€ã€åŸºæœ¬è³‡è¨Š',
      personality: 'äºŒã€æ€§æ ¼',
      speechStyle: 'ä¸‰ã€èªªè©±é¢¨æ ¼èˆ‡ç¿’æ…£',
      extra: 'é™„åŠ è³‡è¨Š',
      event: 'å‰µä½œè€…äº‹ä»¶'
    };

    /* ========= ä¸»é¡Œåˆ‡æ› ========= */
    function changeTheme(theme) {
      const body = document.body;
      body.classList.remove(
        'theme-pink','theme-cream','theme-mint',
        'theme-lavender','theme-sky','theme-lemon',
        'theme-grey','theme-black'
      );
      body.classList.add(`theme-${theme}`);
    }

    /* ========= ç‰ˆé¢åˆ‡æ› ========= */
    function setLayout(mode) {
      const body = document.body;
      body.classList.remove('layout-desktop','layout-mobile');
      body.classList.add(`layout-${mode}`);
    }

    function initLayoutByWidth() {
      if (window.innerWidth <= 850) {
        setLayout('mobile');
      } else {
        setLayout('desktop');
      }
    }
    
    function toggleSidebar() {
      const sb = document.querySelector('.sidebar');
      if (!sb) return;
      sb.classList.toggle('is-collapsed');
      const btn = sb.querySelector('.sidebar-toggle-btn');
      if (btn) {
         btn.innerHTML = sb.classList.contains('is-collapsed') ? 'â–¶' : 'â—€';
      }
    }

    /* ========= å´é‚Šæ¬„æ²å‹• & å€å¡Šæ”¶åˆ ========= */
    function scrollToSection(sectionId) {
      const sec = document.getElementById(sectionId);
      if (!sec) return;
      expandSection(sectionId);
      // ä½ç§»ä¸€é»é»ä»¥å…è¢« sticky header æ“‹ä½ (é›–ç„¶é€™è£¡ header ä¸æ˜¯ sticky)
      const yOffset = -20; 
      const y = sec.getBoundingClientRect().top + window.pageYOffset + yOffset;
      window.scrollTo({top: y, behavior: 'smooth'});
    }

    function toggleSectionCollapse(sectionId) {
      const sec = document.getElementById(sectionId);
      if (!sec) return;
      sec.classList.toggle('collapsed');
    }

    function expandSection(sectionId) {
      const sec = document.getElementById(sectionId);
      if (!sec) return;
      sec.classList.remove('collapsed');
    }

    /* ========= å·¥å…· ========= */
    function limitText(text, max) {
      text = text.trim();
      if (text.length > max) {
        return text.slice(0, max);
      }
      return text;
    }

    function initEmptyTemplates() {
      const obj = {};
      TEMPLATE_TYPES.forEach(t => obj[t] = []);
      return obj;
    }

    function ensureTemplateTypes(tpls) {
      TEMPLATE_TYPES.forEach(t => {
        if (!Array.isArray(tpls[t])) tpls[t] = [];
      });
    }

    function getStore() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return { currentId: null, chars: {}, templates: initEmptyTemplates() };
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') {
          return { currentId: null, chars: {}, templates: initEmptyTemplates() };
        }
        if (!parsed.chars) parsed.chars = {};
        if (!parsed.templates) parsed.templates = initEmptyTemplates();
        ensureTemplateTypes(parsed.templates);
        return parsed;
      } catch (e) {
        console.warn('è®€å–å­˜æª”å¤±æ•—ï¼Œé‡ç½® storeï¼š', e);
        return { currentId: null, chars: {}, templates: initEmptyTemplates() };
      }
    }

    function setStore(store) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
      } catch (e) {
        console.warn('å¯«å…¥å­˜æª”å¤±æ•—ï¼š', e);
      }
    }

    function newCharId() {
      return 'char_' + Date.now();
    }

    /* ========= æ¨¡æ¿ç›¸é—œ ========= */
    function getTemplatesByType(type) {
      const store = getStore();
      if (!store.templates) store.templates = initEmptyTemplates();
      ensureTemplateTypes(store.templates);
      return store.templates[type] || [];
    }

    function refreshTemplateSelect(type) {
      const selects = document.querySelectorAll(`select[data-template-type="${type}"]`);
      const list = getTemplatesByType(type);
      selects.forEach(sel => {
        const currentValue = sel.value;
        sel.innerHTML = '<option value="">âœ¨ å¥—ç”¨æ¨¡æ¿â€¦</option>';
        list.forEach(tpl => {
          const opt = document.createElement('option');
          opt.value = tpl.id;
          opt.textContent = tpl.name;
          sel.appendChild(opt);
        });
        if (list.some(t => t.id === currentValue)) {
          sel.value = currentValue;
        }
      });
    }

    function refreshAllTemplateSelects() {
      TEMPLATE_TYPES.forEach(t => refreshTemplateSelect(t));
    }

    function saveTemplate(type, text) {
      const content = (text || '').trim();
      if (!content) {
        alert("ç›®å‰æ¬„ä½æ˜¯ç©ºçš„ï¼Œç„¡æ³•å­˜æˆæ¨¡æ¿å–”ï½");
        return;
      }
      const name = prompt("è«‹è¼¸å…¥é€™å€‹æ¨¡æ¿çš„åç¨±ï¼ˆä¾‹å¦‚ï¼šæ¨™æº–ä¸–ç•Œè§€æ¨¡æ¿ï¼‰ï¼š");
      if (!name) return;

      const store = getStore();
      if (!store.templates) store.templates = initEmptyTemplates();
      ensureTemplateTypes(store.templates);

      store.templates[type].push({
        id: 'tpl_' + Date.now() + '_' + Math.floor(Math.random() * 10000),
        name: name.trim(),
        text: content
      });

      setStore(store);
      refreshTemplateSelect(type);
      renderTemplateManager();
      alert("å·²å„²å­˜æ¨¡æ¿ï¼šã€Œ" + name.trim() + "ã€");
    }

    function saveTemplateFromField(type, textareaId) {
      const el = document.getElementById(textareaId);
      if (!el) return;
      saveTemplate(type, el.value);
    }

    function saveTemplateFromDynamicBlock(type, blockEl) {
      if (!blockEl) return;
      const textarea = blockEl.querySelector(type === 'extra' ? '.extra-field' : '.event-field');
      if (!textarea) return;
      saveTemplate(type, textarea.value);
    }

    function applyTemplateSingle(type, textareaId, selectEl) {
      const tplId = selectEl.value;
      if (!tplId) return;

      const store = getStore();
      if (!store.templates) return;
      ensureTemplateTypes(store.templates);
      const list = store.templates[type] || [];
      const tpl = list.find(t => t.id === tplId);
      if (!tpl) return;

      const ta = document.getElementById(textareaId);
      if (!ta) return;
      ta.value = tpl.text;
      saveCurrentChar();
      if (textareaId === 'promptRole' || textareaId === 'promptGuideline') {
        updatePromptTokenInfo();
      }
      updateFieldCounter(ta);
      selectEl.value = ""; // Reset select
    }

    function applyTemplateDynamic(type, selectEl) {
      const tplId = selectEl.value;
      if (!tplId) return;

      const store = getStore();
      if (!store.templates) return;
      ensureTemplateTypes(store.templates);
      const list = store.templates[type] || [];
      const tpl = list.find(t => t.id === tplId);
      if (!tpl) return;

      const block = selectEl.closest(type === 'extra' ? '.extra-block' : '.event-block');
      if (!block) return;
      const ta = block.querySelector(type === 'extra' ? '.extra-field' : '.event-field');
      if (!ta) return;

      ta.value = tpl.text;
      saveCurrentChar();
      updateFieldCounter(ta);
      selectEl.value = "";
    }

    /* ========= æ¨¡æ¿ç®¡ç†ä¸­å¿ƒæ¸²æŸ“ ========= */
    function renderTemplateManager() {
      const container = document.getElementById('tplManagerList');
      if (!container) return;

      const store = getStore();
      if (!store.templates) store.templates = initEmptyTemplates();
      ensureTemplateTypes(store.templates);

      const filterSel = document.getElementById('tplFilter');
      const filter = filterSel ? filterSel.value : '';

      container.innerHTML = '';
      let total = 0;

      TEMPLATE_TYPES.forEach(type => {
        if (filter && filter !== type) return;
        const list = store.templates[type] || [];
        if (!list.length) return;

        const title = document.createElement('h3');
        title.className = 'tpl-type-title';
        title.style.fontSize = "1rem";
        title.style.marginTop = "16px";
        title.textContent = `${TEMPLATE_TYPE_LABELS[type]}ï¼ˆ${list.length} ç­†ï¼‰`;
        container.appendChild(title);

        list.forEach(tpl => {
          total++;
          const card = document.createElement('div');
          card.className = 'tpl-card';

          const nameEl = document.createElement('div');
          nameEl.className = 'tpl-name';
          nameEl.textContent = tpl.name || 'ï¼ˆæœªå‘½åæ¨¡æ¿ï¼‰';

          const metaEl = document.createElement('div');
          metaEl.className = 'tpl-meta';
          metaEl.textContent = `é¡å‹ï¼š${TEMPLATE_TYPE_LABELS[type]}`;

          const previewEl = document.createElement('div');
          previewEl.className = 'tpl-preview';
          const txt = tpl.text || '';
          previewEl.textContent = txt;

          const btnRow = document.createElement('div');
          btnRow.style.marginTop = "8px";
          const delBtn = document.createElement('button');
          delBtn.type = 'button';
          delBtn.className = 'button-mini';
          delBtn.textContent = 'åˆªé™¤æ­¤æ¨¡æ¿';
          delBtn.onclick = () => deleteTemplate(type, tpl.id);
          btnRow.appendChild(delBtn);

          card.appendChild(nameEl);
          card.appendChild(metaEl);
          card.appendChild(previewEl);
          card.appendChild(btnRow);

          container.appendChild(card);
        });
      });

      if (!total) {
        container.innerHTML = '<p class="sub-label" style="text-align:center; padding:20px;">ç›®å‰å°šæœªå»ºç«‹ä»»ä½•æ¨¡æ¿ï¼Œå¯ä»¥åœ¨å„æ¬„ä½æŒ‰ã€Œå­˜ç‚ºæ¨¡æ¿ã€å»ºç«‹ã€‚</p>';
      }
    }

    function deleteTemplate(type, id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ¨¡æ¿å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸå–”ï½')) return;
      const store = getStore();
      if (!store.templates) return;
      ensureTemplateTypes(store.templates);
      store.templates[type] = (store.templates[type] || []).filter(t => t.id !== id);
      setStore(store);
      refreshTemplateSelect(type);
      renderTemplateManager();
    }

    /* ========= å‹•æ…‹æ¬„ä½ï¼šé™„åŠ è³‡è¨Š & äº‹ä»¶ ========= */
    function renumberExtras() {
      const blocks = document.querySelectorAll(".extra-block");
      blocks.forEach((block, idx) => {
        const labels = block.querySelectorAll("label");
        if (labels.length >= 2) {
          labels[1].textContent = `é™„åŠ è³‡è¨Š ${idx + 1}ï¼š`;
        }
      });
    }

    function renumberEvents() {
      const blocks = document.querySelectorAll(".event-block");
      blocks.forEach((block, idx) => {
        const labels = block.querySelectorAll("label");
        if (labels.length >= 2) {
          labels[1].textContent = `å‰µä½œè€…äº‹ä»¶ ${idx + 1}ï¼š`;
        }
      });
    }

    function addExtra() {
      const current = document.querySelectorAll(".extra-block").length;
      if (current >= EXTRA_MAX) {
        alert("é™„åŠ è³‡è¨Šæœ€å¤šåªèƒ½ 10 ç­†å–”ï½");
        return;
      }
      const container = document.getElementById("extraContainer");

      const block = document.createElement("div");
      block.className = "extra-block";

      // ç¬¬ä¸€è¡Œï¼šæ¨™é¡Œåˆ—
      const titleRow = document.createElement("div");
      titleRow.className = "label-row";

      const titleLabel = document.createElement("label");
      titleLabel.textContent = "æ¨™é¡Œ";

      const titleInput = document.createElement("input");
      titleInput.type = "text";
      titleInput.className = "extra-title-field";
      titleInput.dataset.maxlength = "50";
      titleInput.style.flex = "1";
      titleInput.placeholder = "é¸å¡«ï¼Œä¾‹å¦‚ï¼šç‰¹æ®Šèƒ½åŠ›";
      titleInput.addEventListener('input', () => {
        saveCurrentChar();
        updateFieldCounter(titleInput);
      });

      titleRow.appendChild(titleLabel);
      titleRow.appendChild(titleInput);

      // ç¬¬äºŒè¡Œï¼šå…§å®¹æ¨™ç±¤ + æ¨¡æ¿/åˆªé™¤
      const labelRow = document.createElement("div");
      labelRow.className = "label-row";

      const label = document.createElement("label");
      label.textContent = "é™„åŠ è³‡è¨Šå…§å®¹";

      const controls = document.createElement("div");
      controls.className = "label-controls";
      controls.style.display = "flex";
      controls.style.gap = "4px";

      const tplSelect = document.createElement("select");
      tplSelect.className = "button-mini";
      tplSelect.style.width = "auto";
      tplSelect.style.margin = "0";
      tplSelect.dataset.templateType = "extra";
      tplSelect.innerHTML = '<option value="">âœ¨ å¥—ç”¨æ¨¡æ¿â€¦</option>';
      tplSelect.addEventListener('change', function () {
        applyTemplateDynamic('extra', this);
      });

      const saveTplBtn = document.createElement("button");
      saveTplBtn.type = "button";
      saveTplBtn.className = "button-mini";
      saveTplBtn.textContent = "å­˜ç‚ºæ¨¡æ¿";
      saveTplBtn.onclick = function () {
        saveTemplateFromDynamicBlock('extra', block);
      };

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "button-mini";
      delBtn.textContent = "åˆªé™¤";
      delBtn.onclick = function () {
        block.remove();
        renumberExtras();
        saveCurrentChar();
        updateAllFieldCounters();
      };

      controls.appendChild(tplSelect);
      controls.appendChild(saveTplBtn);
      controls.appendChild(delBtn);

      labelRow.appendChild(label);
      labelRow.appendChild(controls);

      // å…§å®¹æ¬„ä½
      const textarea = document.createElement("textarea");
      textarea.className = "extra-field";
      textarea.dataset.maxlength = "500";
      textarea.addEventListener('input', () => {
        saveCurrentChar();
        updateFieldCounter(textarea);
      });

      block.appendChild(titleRow);
      block.appendChild(labelRow);
      block.appendChild(textarea);
      container.appendChild(block);

      renumberExtras();
      saveCurrentChar();
      refreshTemplateSelect('extra');
      setupFieldUtils(block); // çµ¦æ–°æ¬„ä½åŠ ä¸Šå­—æ•¸ï¼†è¤‡è£½
    }

    function addEvent() {
      const current = document.querySelectorAll(".event-block").length;
      if (current >= EVENT_MAX) {
        alert("å‰µä½œè€…äº‹ä»¶æœ€å¤šåªèƒ½ 20 ç­†å–”ï½");
        return;
      }
      const container = document.getElementById("eventContainer");

      const block = document.createElement("div");
      block.className = "event-block";

      // ç¬¬ä¸€è¡Œï¼šæ¨™é¡Œåˆ—
      const titleRow = document.createElement("div");
      titleRow.className = "label-row";

      const titleLabel = document.createElement("label");
      titleLabel.textContent = "æ¨™é¡Œ";

      const titleInput = document.createElement("input");
      titleInput.type = "text";
      titleInput.className = "event-title-field";
      titleInput.dataset.maxlength = "50";
      titleInput.style.flex = "1";
      titleInput.placeholder = "é¸å¡«ï¼Œä¾‹å¦‚ï¼šåˆæ¬¡ç›¸é‡";
      titleInput.addEventListener('input', () => {
        saveCurrentChar();
        updateFieldCounter(titleInput);
      });

      titleRow.appendChild(titleLabel);
      titleRow.appendChild(titleInput);

      // ç¬¬äºŒè¡Œï¼šå…§å®¹æ¨™ç±¤ + æ¨¡æ¿/åˆªé™¤
      const labelRow = document.createElement("div");
      labelRow.className = "label-row";

      const label = document.createElement("label");
      label.textContent = "äº‹ä»¶å…§å®¹";

      const controls = document.createElement("div");
      controls.style.display = "flex";
      controls.style.gap = "4px";

      const tplSelect = document.createElement("select");
      tplSelect.className = "button-mini";
      tplSelect.style.width = "auto";
      tplSelect.style.margin = "0";
      tplSelect.dataset.templateType = "event";
      tplSelect.innerHTML = '<option value="">âœ¨ å¥—ç”¨æ¨¡æ¿â€¦</option>';
      tplSelect.addEventListener('change', function () {
        applyTemplateDynamic('event', this);
      });

      const saveTplBtn = document.createElement("button");
      saveTplBtn.type = "button";
      saveTplBtn.className = "button-mini";
      saveTplBtn.textContent = "å­˜ç‚ºæ¨¡æ¿";
      saveTplBtn.onclick = function () {
        saveTemplateFromDynamicBlock('event', block);
      };

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "button-mini";
      delBtn.textContent = "åˆªé™¤";
      delBtn.onclick = function () {
        block.remove();
        renumberEvents();
        saveCurrentChar();
        updateAllFieldCounters();
      };

      controls.appendChild(tplSelect);
      controls.appendChild(saveTplBtn);
      controls.appendChild(delBtn);

      labelRow.appendChild(label);
      labelRow.appendChild(controls);

      // å…§å®¹æ¬„ä½
      const textarea = document.createElement("textarea");
      textarea.className = "event-field";
      textarea.dataset.maxlength = "2000";
      textarea.addEventListener('input', () => {
        saveCurrentChar();
        updateFieldCounter(textarea);
      });

      block.appendChild(titleRow);
      block.appendChild(labelRow);
      block.appendChild(textarea);
      container.appendChild(block);

      renumberEvents();
      saveCurrentChar();
      refreshTemplateSelect('event');
      setupFieldUtils(block);
    }

    /* ========= æ¯å€‹æ¬„ä½ï¼šå­—æ•¸é¡¯ç¤º + è¤‡è£½ï¼ˆæœ‰ id çš„æ¬„ä½ï¼‰========= */
    function copyFieldText(idOrEl) {
      let el;
      if (typeof idOrEl === 'string') {
          el = document.getElementById(idOrEl);
      } else {
          // å˜—è©¦æ‰¾åˆ°æŒ‰éˆ•é—œè¯çš„è¼¸å…¥æ¡†
          const wrapper = idOrEl.closest('.field-utils');
          if(wrapper) {
              const prev = wrapper.previousElementSibling;
              if(prev && (prev.tagName === 'INPUT' || prev.tagName === 'TEXTAREA')) {
                  el = prev;
              }
          }
      }
      
      if (!el) return;
      const text = el.value || el.innerText || "";
      if (!text) {
        alert('é€™å€‹æ¬„ä½ç›®å‰æ˜¯ç©ºçš„å–”ï½');
        return;
      }

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => {
               const originalText = 'è¤‡è£½';
               // ç°¡å–®çš„è¦–è¦ºåé¥‹
               const btn = event.target;
               btn.textContent = 'å·²è¤‡è£½ï¼';
               setTimeout(() => btn.textContent = originalText, 1500);
          })
          .catch(err => {
            console.error(err);
            fallbackCopy(el);
          });
      } else {
        fallbackCopy(el);
      }
    }

    function fallbackCopy(el) {
      try {
        el.select();
        document.execCommand('copy');
        alert('å·²è¤‡è£½å…§å®¹');
      } catch (e) {
        alert('è¤‡è£½å¤±æ•—ï¼Œå¯èƒ½è¢«ç€è¦½å™¨æ“‹ä½äº† QQ');
      }
    }

    function updateFieldCounter(el) {
      let wrapper = el.nextElementSibling;
      if (!wrapper || !wrapper.classList || !wrapper.classList.contains('field-utils')) {
        return;
      }
      const counterSpan = wrapper.querySelector('.field-counter');
      if (!counterSpan) return;

      const max = el.dataset.maxlength ? parseInt(el.dataset.maxlength, 10) : null;
      const len = el.value ? el.value.length : 0;
      if (max) {
        counterSpan.textContent = `${len} / ${max}`;
        if(len >= max) counterSpan.style.color = "red";
        else counterSpan.style.color = "inherit";
      } else {
        counterSpan.textContent = `${len} å­—`;
      }
    }

    function updateAllFieldCounters() {
      const fields = document.querySelectorAll('textarea, input[type="text"], input[type="search"], input[type="date"]');
      fields.forEach(updateFieldCounter);
    }

    function setupFieldUtils(scope = document) {
      const fields = scope.querySelectorAll('textarea, input[type="text"], input[type="search"], input[type="date"]');
      fields.forEach(el => {
        // é¿å…é‡è¤‡æ·»åŠ 
        const next = el.nextElementSibling;
        if (next && next.classList && next.classList.contains('field-utils')) return;

        const wrapper = document.createElement('div');
        wrapper.className = 'field-utils';

        const counter = document.createElement('span');
        counter.className = 'field-counter';
        
        const copyBtn = document.createElement('button');
        copyBtn.type = 'button';
        copyBtn.className = 'button-mini field-copy';
        copyBtn.textContent = 'è¤‡è£½';
        copyBtn.style.margin = "0";
        copyBtn.onclick = (e) => copyFieldText(el);

        wrapper.appendChild(counter);
        wrapper.appendChild(copyBtn);
        el.insertAdjacentElement('afterend', wrapper);
        
        updateFieldCounter(el);
      });
    }

    /* ========= è¡¨å–®è³‡æ–™æ”¶é›† & å¡«å› ========= */
    function collectFormData() {
      const fieldIds = [
        'charName','charCategory','charAge','charJob','charQuote','charDesc',
        'charTags','creatorNote','basicInfo','personality','speechStyle',
        'firstScene','sampleDialogue','likes','dislikes','birthday','gender',
        'modelType','promptRole','promptGuideline'
      ];

      const data = { fields: {}, extras: [], events: [] };

      fieldIds.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.tagName === 'SELECT') {
          data.fields[id] = el.value || "";
        } else {
          data.fields[id] = el.value || "";
        }
      });

      data.extras = [];
      document.querySelectorAll('.extra-block').forEach(block => {
        const titleEl = block.querySelector('.extra-title-field');
        const textEl = block.querySelector('.extra-field');
        const title = titleEl ? (titleEl.value || "") : "";
        const text = textEl ? (textEl.value || "") : "";
        if (title || text) {
          data.extras.push({ title, text });
        }
      });

      data.events = [];
      document.querySelectorAll('.event-block').forEach(block => {
        const titleEl = block.querySelector('.event-title-field');
        const textEl = block.querySelector('.event-field');
        const title = titleEl ? (titleEl.value || "") : "";
        const text = textEl ? (textEl.value || "") : "";
        if (title || text) {
          data.events.push({ title, text });
        }
      });

      return data;
    }

    function clearForm() {
      const ids = [
        'charName','charCategory','charAge','charJob','charQuote','charDesc',
        'charTags','creatorNote','basicInfo','personality','speechStyle',
        'firstScene','sampleDialogue','likes','dislikes','birthday',
        'promptRole','promptGuideline'
      ];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
      });

      const genderSel = document.getElementById('gender');
      if (genderSel) genderSel.value = 'æœªè¨­ç½®';

      const modelSel = document.getElementById('modelType');
      if (modelSel) modelSel.value = 'gemini-3';

      const extraContainer = document.getElementById('extraContainer');
      const eventContainer = document.getElementById('eventContainer');
      if (extraContainer) extraContainer.innerHTML = "";
      if (eventContainer) eventContainer.innerHTML = "";

      updatePromptTokenInfo();
      // é‡æ–°åˆå§‹åŒ– utils
      // setupFieldUtils(); // ä¸éœ€è¦ï¼Œå› ç‚ºDOMæ²’è®Šï¼Œåªæ˜¯å€¼è®Šäº†ï¼Œé™¤äº†å‹•æ…‹å€å¡Š
    }

    function fillFormFromData(data) {
      clearForm();
      if (!data || !data.fields) return;

      Object.keys(data.fields).forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.value = data.fields[id] || "";
      });

      if (Array.isArray(data.extras)) {
        data.extras.forEach(item => {
          let title = "";
          let text = "";
          if (typeof item === "string") {
            text = item;
          } else if (item && typeof item === "object") {
            title = item.title || "";
            text = item.text || "";
          }
          // if (!title && !text) return; // å³ä½¿æ˜¯ç©ºçš„ä¹Ÿé‚„åŸçµæ§‹

          addExtra();
          const blocks = document.querySelectorAll(".extra-block");
          const lastBlock = blocks[blocks.length - 1];
          if (!lastBlock) return;
          const titleEl = lastBlock.querySelector(".extra-title-field");
          const textEl = lastBlock.querySelector(".extra-field");
          if (titleEl) titleEl.value = title;
          if (textEl) textEl.value = text;
        });
      }

      if (Array.isArray(data.events)) {
        data.events.forEach(item => {
          let title = "";
          let text = "";
          if (typeof item === "string") {
            text = item;
          } else if (item && typeof item === "object") {
            title = item.title || "";
            text = item.text || "";
          }
          
          addEvent();
          const blocks = document.querySelectorAll(".event-block");
          const lastBlock = blocks[blocks.length - 1];
          if (!lastBlock) return;
          const titleEl = lastBlock.querySelector(".event-title-field");
          const textEl = lastBlock.querySelector(".event-field");
          if (titleEl) titleEl.value = title;
          if (textEl) textEl.value = text;
        });
      }

      updatePromptTokenInfo();
      refreshAllTemplateSelects();
      updateAllFieldCounters();
    }

    /* ========= è§’è‰²å­˜æª”é‚è¼¯ï¼šå¤šè§’è‰² ========= */
    function saveCurrentChar() {
      const store = getStore();
      let id = store.currentId;
      if (!id) {
        id = newCharId();
        store.currentId = id;
      }

      const existing = store.chars[id];
      const existingCreated = existing && existing.meta && existing.meta.createdAt
        ? existing.meta.createdAt
        : Date.now();

      const data = collectFormData();
      const name = (document.getElementById('charName').value.trim() || "æœªå‘½åè§’è‰²");
      const category = document.getElementById('charCategory').value.trim() || "";
      const tagsArray = (document.getElementById('charTags').value.trim() || "")
        .split(/[,ï¼Œ\s]+/).filter(Boolean);

      store.chars[id] = {
        meta: {
          name,
          category,
          tags: tagsArray,
          createdAt: existingCreated
        },
        data
      };

      setStore(store);
      renderCharList(store);
    }

    function newCharacter() {
      const store = getStore();
      const id = newCharId();
      store.currentId = id;
      setStore(store);

      clearForm();
      document.getElementById('output').textContent = "";
      saveCurrentChar();
      
      // æ»¾å‹•åˆ°é ‚éƒ¨
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function deleteCurrentChar() {
      const store = getStore();
      const id = store.currentId;
      if (!id || !store.chars[id]) {
        alert("ç›®å‰æ²’æœ‰é¸ä¸­çš„è§’è‰²å¯ä»¥åˆªé™¤å“¦ï½");
        return;
      }
      if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹è§’è‰²å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼")) return;

      delete store.chars[id];
      const ids = Object.keys(store.chars);
      store.currentId = ids.length ? ids[0] : null;
      setStore(store);

      if (store.currentId && store.chars[store.currentId]) {
        const target = store.chars[store.currentId];
        fillFormFromData(target.data);
      } else {
        clearForm();
        document.getElementById('output').textContent = "";
      }
      renderCharList(store);
    }

    function loadChar(id) {
      const store = getStore();
      const item = store.chars[id];
      if (!item) return;
      store.currentId = id;
      setStore(store);

      fillFormFromData(item.data);
      document.getElementById('output').textContent = "";
      renderCharList(store);
      
      // ç‚ºäº†é¿å…ä½¿ç”¨è€…ä¸çŸ¥é“åˆ‡æ›äº†ï¼Œçµ¦é»æç¤ºæˆ–æ»¾å‹•
      // window.scrollTo({top:0, behavior:'smooth'});
    }

    function renderCharList(store) {
      const listEl = document.getElementById('charList');
      if (!listEl) return;

      const filterCategory = document.getElementById('filterCategory').value;
      const keyword = document.getElementById('searchName').value.trim().toLowerCase();
      const sortMode = document.getElementById('charSort') ? document.getElementById('charSort').value : 'created_desc';

      listEl.innerHTML = "";

      const entries = Object.entries(store.chars || {});

      // æ”¶é›†åˆ†é¡
      const categorySet = new Set();
      entries.forEach(([id, item]) => {
        if (item.meta && item.meta.category) {
          categorySet.add(item.meta.category);
        }
      });

      const filterSel = document.getElementById('filterCategory');
      if (filterSel) {
        const prev = filterSel.value;
        // ä¿å­˜åŸæœ¬é¸é …
        let html = '<option value="">å…¨éƒ¨åˆ†é¡</option>';
        [...categorySet].sort().forEach(cat => {
          html += `<option value="${cat}">${cat}</option>`;
        });
        filterSel.innerHTML = html;
        if (prev) filterSel.value = prev;
      }

      // æ’åº
      entries.sort((a, b) => {
        const A = a[1];
        const B = b[1];
        const nameA = (A.meta?.name || '').toLowerCase();
        const nameB = (B.meta?.name || '').toLowerCase();
        const ca = A.meta?.createdAt || 0;
        const cb = B.meta?.createdAt || 0;

        if (sortMode === 'name_asc') {
          if (nameA < nameB) return -1;
          if (nameA > nameB) return 1;
          return ca - cb;
        } else if (sortMode === 'created_asc') {
          return ca - cb;
        } else { // created_desc
          return cb - ca;
        }
      });

      entries.forEach(([id, item]) => {
        const name = item.meta?.name || "æœªå‘½åè§’è‰²";
        const cat = item.meta?.category || "";

        if (filterCategory && cat !== filterCategory) return;
        if (keyword && !name.toLowerCase().includes(keyword)) return;

        const btn = document.createElement('button');
        btn.type = "button";
        // æ ¹æ“šæ˜¯å¦é¸ä¸­æ”¹è®Šæ¨£å¼
        if (store.currentId === id) {
          btn.className = "button-mini"; // ä¸»è¦æŒ‰éˆ•æ¨£å¼
          btn.style.background = "var(--focus-color)";
          btn.style.color = "#fff";
        } else {
          btn.className = "button-secondary"; // æ¬¡è¦
        }
        
        btn.textContent = cat ? `${name} (${cat})` : name;
        btn.onclick = () => loadChar(id);

        listEl.appendChild(btn);
      });
    }

    function refreshCharListFromStorage() {
      const store = getStore();
      renderCharList(store);
    }

    /* ========= å¿…å¡«æ¬„ä½æé†’ ========= */
    function validateRequired() {
      const requiredFields = [
        { id: 'charName', label: 'è§’è‰²åç¨±' },
        { id: 'charAge', label: 'å¹´é½¡' },
        { id: 'charJob', label: 'è·æ¥­' },
        { id: 'charQuote', label: 'ä¾†è‡ªè§’è‰²çš„ä¸€å¥è©±' },
        { id: 'gender', label: 'æ€§åˆ¥' },
        { id: 'basicInfo', label: 'ä¸€ã€åŸºæœ¬è³‡è¨Š' },
        { id: 'personality', label: 'äºŒã€æ€§æ ¼' },
        { id: 'speechStyle', label: 'ä¸‰ã€èªªè©±é¢¨æ ¼èˆ‡ç¿’æ…£' }
      ];

      const missing = [];

      requiredFields.forEach(f => {
        const el = document.getElementById(f.id);
        if (!el) return;
        let value = '';
        value = el.value.trim();
        if (!value || value === 'æœªè¨­ç½®') {
          missing.push(f.label);
        }
      });

      if (missing.length > 0) {
        alert("ä»¥ä¸‹æ¬„ä½å»ºè­°å¡«å¯«ï¼Œè³‡æ–™æœƒæ›´å®Œæ•´å–”ï¼š\n" +
          missing.join("ã€") +
          "\n\nï¼ˆä»ç„¶æœƒå¹«ä½ ç”Ÿæˆ Markdownï¼‰");
      }
      return true;
    }

    /* ========= Prompt token & æœé†¬è¨ˆç®— ========= */
    function estimateTextTokens(text) {
      let total = 0;
      for (const ch of text) {
        if (/\s/.test(ch)) continue;
        if (/[\u3400-\u4DBF\u4E00-\u9FFF]/.test(ch)) {
          total += 2;
        } else {
          total += 1;
        }
      }
      return total;
    }

    function estimatePromptTokens() {
      const role = (document.getElementById('promptRole').value || "");
      const guide = (document.getElementById('promptGuideline').value || "");
      return estimateTextTokens(role) + estimateTextTokens(guide);
    }

    function getSelectedModelBaseCost() {
      const sel = document.getElementById('modelType');
      if (!sel) return 0;
      const opt = sel.options[sel.selectedIndex];
      const base = parseInt(opt.dataset.basecost || "0", 10);
      return isNaN(base) ? 0 : base;
    }

    function updatePromptTokenInfo() {
      const tokenSpan = document.getElementById('promptTokenInfo');
      const jamSpan = document.getElementById('promptJamInfo');
      if (!tokenSpan || !jamSpan) return;

      const totalTokens = estimatePromptTokens();
      const baseCost = getSelectedModelBaseCost();

      let extraTokens = Math.max(0, totalTokens - 500);
      let extraJams = extraTokens > 0 ? Math.ceil(extraTokens / 500) : 0;
      const totalJam = baseCost + extraJams;

      tokenSpan.textContent = `é ä¼° Tokenï¼š${totalTokens} (ä¸­æ–‡ç´„ 2, è‹±æ–‡ç´„ 1)`;
      jamSpan.textContent = `é ä¼°èŠ±è²»ï¼šç´„ ${totalJam} æœé†¬ (åŸºç¤ ${baseCost} + é¡å¤– ${extraJams})`;
    }

    /* ========= Markdown ç”Ÿæˆ ========= */
    function generateMarkdown() {
      validateRequired();
      saveCurrentChar();

      const name = document.getElementById('charName').value.trim();
      const age = limitText(document.getElementById('charAge').value, 15);
      const job = limitText(document.getElementById('charJob').value, 15);
      const quote = limitText(document.getElementById('charQuote').value, 80);
      const desc = limitText(document.getElementById('charDesc').value, 700);
      const tagsRaw = document.getElementById('charTags').value.trim();
      const creatorNote = limitText(document.getElementById('creatorNote').value, 200);
      const gender = document.getElementById('gender').value.trim();
      const category = limitText(document.getElementById('charCategory').value, 100);

      const basic = limitText(document.getElementById('basicInfo').value, 700);
      const personality = limitText(document.getElementById('personality').value, 700);
      const speech = limitText(document.getElementById('speechStyle').value, 700);

      const firstScene = limitText(document.getElementById('firstScene').value, 800);
      const sampleDialogue = limitText(document.getElementById('sampleDialogue').value, 800);
      const likes = limitText(document.getElementById('likes').value, 50);
      const dislikes = limitText(document.getElementById('dislikes').value, 50);
      const birthdayRaw = document.getElementById('birthday').value;

      const modelSel = document.getElementById('modelType');
      const modelValue = modelSel ? modelSel.value : "";
      const modelLabel = modelSel ? modelSel.options[modelSel.selectedIndex].textContent : "";
      const promptRole = document.getElementById('promptRole').value;
      const promptGuideline = document.getElementById('promptGuideline').value;
      const promptTokens = estimatePromptTokens();

      let birthdayText = birthdayRaw ? birthdayRaw : "";

      let tagsFormatted = "";
      if (tagsRaw) {
        const parts = tagsRaw.split(/[,ï¼Œ\s]+/).filter(Boolean);
        tagsFormatted = parts.map(t => "#" + t.replace(/^#/, "")).join(" ");
      }

      let md = [];

      md.push(`ã€è§’è‰²è³‡è¨Šã€‘`);
      md.push(`- åç¨±ï¼š${name || "ï¼ˆæœªå‘½åï¼‰"}`);
      if (category) md.push(`- åˆ†é¡ï¼š${category}`);
      if (gender && gender !== 'æœªè¨­ç½®') md.push(`- æ€§åˆ¥ï¼š${gender}`);
      if (age) md.push(`- å¹´é½¡ï¼š${age}`);
      if (job) md.push(`- è·æ¥­ï¼š${job}`);
      if (birthdayText) md.push(`- ç”Ÿæ—¥ï¼š${birthdayText}`);
      if (tagsFormatted) md.push(`- æ¨™ç±¤ï¼š${tagsFormatted}`);

      if (quote) {
        md.push(`- ä¸€å¥è©±ï¼š`);
        md.push(quote);
      }

      if (desc) {
        md.push(`- æ•˜è¿°ï¼š`);
        md.push(desc);
      }

      if (creatorNote) {
        md.push(`- å‰µä½œè€…ç­†è¨˜ï¼š`);
        md.push(creatorNote);
      }

      md.push("");

      md.push(`ã€åŸºæœ¬è³‡è¨Šã€‘`);
      md.push(basic || "ï¼ˆå°šæœªå¡«å¯«ï¼‰");
      md.push("");

      md.push(`ã€æ€§æ ¼ã€‘`);
      md.push(personality || "ï¼ˆå°šæœªå¡«å¯«ï¼‰");
      md.push("");

      md.push(`ã€èªªè©±é¢¨æ ¼èˆ‡ç¿’æ…£ã€‘`);
      md.push(speech || "ï¼ˆå°šæœªå¡«å¯«ï¼‰");
      md.push("");

      if (modelValue || promptRole || promptGuideline) {
        md.push(`ã€æ¨¡å‹èˆ‡ Prompt è¨­å®šã€‘`);
        if (modelLabel) md.push(`- æ¨¡å‹ï¼š${modelLabel}`);
        md.push(`- é ä¼° tokenï¼š${promptTokens}ï¼ˆåƒ…ä¾›åƒè€ƒï¼‰`);
        if (promptRole) {
          md.push(`- Roleï¼š`);
          md.push(promptRole);
        }
        if (promptGuideline) {
          md.push(`- Response Guidelineï¼š`);
          md.push(promptGuideline);
        }
        md.push("");
      }

      if (firstScene) {
        md.push(`ã€ç¬¬ä¸€æ¬¡èŠå¤©å ´æ™¯ã€‘`);
        md.push(firstScene);
        md.push("");
      }

      if (sampleDialogue) {
        md.push(`ã€è§’è‰²å°è©±ã€‘`);
        md.push(sampleDialogue);
        md.push("");
      }

      if (likes || dislikes) {
        md.push(`ã€å–œå¥½ã€‘`);
        if (likes) md.push(`- å–œæ­¡ï¼š${likes}`);
        if (dislikes) md.push(`- ä¸å–œæ­¡ï¼š${dislikes}`);
        md.push("");
      }

      // é™„åŠ è³‡è¨Š
      md.push(`ã€é™„åŠ è³‡è¨Šã€‘`);
      const extraBlocks = document.querySelectorAll(".extra-block");
      if (extraBlocks.length === 0) {
        md.push("- ï¼ˆå°šæœªå¡«å¯«ï¼‰\n");
      } else {
        extraBlocks.forEach((block, idx) => {
          const titleEl = block.querySelector(".extra-title-field");
          const textEl = block.querySelector(".extra-field");
          const title = titleEl ? limitText(titleEl.value, 50) : "";
          const txt = textEl ? limitText(textEl.value, 500) : "";
          if (!title && !txt) return;

          md.push(`ï¼»é™„åŠ è³‡è¨Š ${idx + 1}ï¼½`);
          if (title) {
            md.push(`- æ¨™é¡Œï¼š${title}`);
          }
          if (txt) {
            md.push(txt);
          }
          md.push("");
        });
      }

      // å‰µä½œè€…äº‹ä»¶
      md.push(`ã€å‰µä½œè€…äº‹ä»¶ã€‘`);
      const eventBlocks = document.querySelectorAll(".event-block");
      if (eventBlocks.length === 0) {
        md.push("- ï¼ˆå°šæœªå¡«å¯«ï¼‰\n");
      } else {
        eventBlocks.forEach((block, idx) => {
          const titleEl = block.querySelector(".event-title-field");
          const textEl = block.querySelector(".event-field");
          const title = titleEl ? limitText(titleEl.value, 50) : "";
          const txt = textEl ? limitText(textEl.value, 2000) : "";
          if (!title && !txt) return;

          md.push(`ï¼»å‰µä½œè€…äº‹ä»¶ ${idx + 1}ï¼½`);
          if (title) {
            md.push(`- æ¨™é¡Œï¼š${title}`);
          }
          if (txt) {
            md.push(txt);
          }
          md.push("");
        });
      }

      const outputBox = document.getElementById('output');
      outputBox.textContent = md.join("\n");
      // æ»¾å‹•åˆ°è¼¸å‡ºå€
      outputBox.scrollIntoView({behavior: "smooth", block: "center"});
    }

    /* ========= Markdown è§£æ ========= */
    function readBlockUntilHeading(lines, startIndex) {
      let i = startIndex;
      const buf = [];
      while (i < lines.length) {
        const t = lines[i];
        const trimmed = t.trim();
        if (trimmed.startsWith("#") || trimmed.startsWith("ã€") || trimmed.startsWith("ï¼»")) break;
        buf.push(t);
        i++;
      }
      while (buf.length && buf[buf.length - 1].trim() === "") {
        buf.pop();
      }
      return { text: buf.join("\n").trim(), nextIndex: i - 1 };
    }

    function parseMarkdownToForm(md) {
      clearForm();

      const lines = md.split(/\r?\n/);
      const extrasData = [];
      const eventsData = [];

      for (let i = 0; i < lines.length; i++) {
        const raw = lines[i];
        const line = raw.trim();

        if (line.startsWith("- åç¨±ï¼š")) {
          document.getElementById('charName').value = line.replace("- åç¨±ï¼š", "").trim().replace(/^ï¼ˆæœªå‘½åï¼‰$/, "");
        } else if (line.startsWith("- åˆ†é¡ï¼š")) {
          document.getElementById('charCategory').value = line.replace("- åˆ†é¡ï¼š", "").trim();
        } else if (line.startsWith("- æ€§åˆ¥ï¼š")) {
          const v = line.replace("- æ€§åˆ¥ï¼š", "").trim();
          const genderSel = document.getElementById('gender');
          if (genderSel && v) genderSel.value = v;
        } else if (line.startsWith("- å¹´é½¡ï¼š")) {
          document.getElementById('charAge').value = line.replace("- å¹´é½¡ï¼š", "").trim();
        } else if (line.startsWith("- è·æ¥­ï¼š")) {
          document.getElementById('charJob').value = line.replace("- è·æ¥­ï¼š", "").trim();
        } else if (line.startsWith("- ç”Ÿæ—¥ï¼š")) {
          const v = line.replace("- ç”Ÿæ—¥ï¼š", "").trim();
          document.getElementById('birthday').value = v;
        } else if (line.startsWith("- æ¨™ç±¤ï¼š")) {
          const t = line.replace("- æ¨™ç±¤ï¼š", "").trim();
          if (t) {
            const parts = t.split(/\s+/).map(x => x.replace(/^#/, "")).filter(Boolean);
            document.getElementById('charTags').value = parts.join(" ");
          }
        } else if (line.startsWith("- ä¸€å¥è©±ï¼š")) {
          const res = readBlockUntilHeading(lines, i + 1);
          document.getElementById('charQuote').value = res.text;
          i = res.nextIndex;
        } else if (line.startsWith("- æ•˜è¿°ï¼š")) {
          const res = readBlockUntilHeading(lines, i + 1);
          document.getElementById('charDesc').value = res.text;
          i = res.nextIndex;
        } else if (line.startsWith("- å‰µä½œè€…ç­†è¨˜ï¼š")) {
          const res = readBlockUntilHeading(lines, i + 1);
          document.getElementById('creatorNote').value = res.text;
          i = res.nextIndex;
        }

        else if (line === "ã€åŸºæœ¬è³‡è¨Šã€‘") {
          const res = readBlockUntilHeading(lines, i + 1);
          document.getElementById('basicInfo').value = res.text === "ï¼ˆå°šæœªå¡«å¯«ï¼‰" ? "" : res.text;
          i = res.nextIndex;
        } else if (line === "ã€æ€§æ ¼ã€‘") {
          const res = readBlockUntilHeading(lines, i + 1);
          document.getElementById('personality').value = res.text === "ï¼ˆå°šæœªå¡«å¯«ï¼‰" ? "" : res.text;
          i = res.nextIndex;
        } else if (line === "ã€èªªè©±é¢¨æ ¼èˆ‡ç¿’æ…£ã€‘") {
          const res = readBlockUntilHeading(lines, i + 1);
          document.getElementById('speechStyle').value = res.text === "ï¼ˆå°šæœªå¡«å¯«ï¼‰" ? "" : res.text;
          i = res.nextIndex;
        }

        else if (line === "ã€æ¨¡å‹èˆ‡ Prompt è¨­å®šã€‘") {
          let j = i + 1;
          while (j < lines.length) {
            const t = lines[j].trim();
            if (t.startsWith("ã€")) break;
            if (t.startsWith("- æ¨¡å‹ï¼š")) {
              // ç°¡æ˜“åŒ¹é…
              const label = t.replace("- æ¨¡å‹ï¼š", "").trim();
              const sel = document.getElementById('modelType');
              if (sel) {
                 // å˜—è©¦éƒ¨åˆ†åŒ¹é…
                 for(let opt of sel.options) {
                     if(label.includes(opt.value) || opt.text.includes(label)) {
                         sel.value = opt.value;
                         break;
                     }
                 }
              }
            } else if (t.startsWith("- Roleï¼š")) {
              const res2 = readBlockUntilHeading(lines, j + 1);
              document.getElementById('promptRole').value = res2.text;
              j = res2.nextIndex;
            } else if (t.startsWith("- Response Guidelineï¼š")) {
              const res2 = readBlockUntilHeading(lines, j + 1);
              document.getElementById('promptGuideline').value = res2.text;
              j = res2.nextIndex;
            }
            j++;
          }
          i = j - 1;
        }

        else if (line === "ã€ç¬¬ä¸€æ¬¡èŠå¤©å ´æ™¯ã€‘") {
          const res = readBlockUntilHeading(lines, i + 1);
          document.getElementById('firstScene').value = res.text;
          i = res.nextIndex;
        } else if (line.startsWith("ã€è§’è‰²å°è©±ã€‘")) {
          const res = readBlockUntilHeading(lines, i + 1);
          document.getElementById('sampleDialogue').value = res.text;
          i = res.nextIndex;
        }

        else if (line === "ã€å–œå¥½ã€‘") {
          let j = i + 1;
          while (j < lines.length) {
            const t = lines[j].trim();
            if (t.startsWith("ã€") || t.startsWith("ï¼»")) break;
            if (t.startsWith("- å–œæ­¡ï¼š")) {
              document.getElementById('likes').value = t.replace("- å–œæ­¡ï¼š", "").trim();
            } else if (t.startsWith("- ä¸å–œæ­¡ï¼š")) {
              document.getElementById('dislikes').value = t.replace("- ä¸å–œæ­¡ï¼š", "").trim();
            }
            j++;
          }
          i = j - 1;
        }

        else if (line.startsWith("ï¼»é™„åŠ è³‡è¨Š ")) {
          const res = readBlockUntilHeading(lines, i + 1);
          if (res.text && res.text !== "ï¼ˆå°šæœªå¡«å¯«ï¼‰") {
            let title = "";
            let body = res.text;

            const parts = res.text.split(/\r?\n/);
            if (parts.length > 0) {
              const first = parts[0].trim();
              if (first.startsWith("- æ¨™é¡Œï¼š")) {
                title = first.replace("- æ¨™é¡Œï¼š", "").trim();
                body = parts.slice(1).join("\n").trim();
              }
            }
            extrasData.push({ title, text: body });
          }
          i = res.nextIndex;
        } else if (line.startsWith("ï¼»å‰µä½œè€…äº‹ä»¶ ")) {
          const res = readBlockUntilHeading(lines, i + 1);
          if (res.text && res.text !== "ï¼ˆå°šæœªå¡«å¯«ï¼‰") {
            let title = "";
            let body = res.text;

            const parts = res.text.split(/\r?\n/);
            if (parts.length > 0) {
              const first = parts[0].trim();
              if (first.startsWith("- æ¨™é¡Œï¼š")) {
                title = first.replace("- æ¨™é¡Œï¼š", "").trim();
                body = parts.slice(1).join("\n").trim();
              }
            }
            eventsData.push({ title, text: body });
          }
          i = res.nextIndex;
        }
      }

      if (extrasData.length > 0) {
        extrasData.forEach(item => {
          addExtra();
          const blocks = document.querySelectorAll(".extra-block");
          const lastBlock = blocks[blocks.length - 1];
          if (!lastBlock) return;
          const titleEl = lastBlock.querySelector(".extra-title-field");
          const textEl = lastBlock.querySelector(".extra-field");
          if (titleEl) titleEl.value = item.title || "";
          if (textEl) textEl.value = item.text || "";
        });
      }

      if (eventsData.length > 0) {
        eventsData.forEach(item => {
          addEvent();
          const blocks = document.querySelectorAll(".event-block");
          const lastBlock = blocks[blocks.length - 1];
          if (!lastBlock) return;
          const titleEl = lastBlock.querySelector(".event-title-field");
          const textEl = lastBlock.querySelector(".event-field");
          if (titleEl) titleEl.value = item.title || "";
          if (textEl) textEl.value = item.text || "";
        });
      }

      updatePromptTokenInfo();
      refreshAllTemplateSelects();
      updateAllFieldCounters();
      saveCurrentChar();
    }

    /* ========= åŒ¯å…¥ / åŒ¯å‡º ========= */
    function importTxt() {
      const input = document.getElementById('txtFile');
      if (!input.files || !input.files[0]) {
        alert("è«‹å…ˆé¸æ“‡ä¸€å€‹ txt æª”æ¡ˆå–”ï½");
        return;
      }

      const file = input.files[0];
      const reader = new FileReader();

      reader.onload = function (e) {
        const content = e.target.result || "";
        document.getElementById('output').textContent = content;
        parseMarkdownToForm(content);
        alert("å·²è¼‰å…¥ï¼š" + file.name);
      };

      reader.readAsText(file, "utf-8");
    }

    function downloadTxt() {
      if (!document.getElementById('output').textContent.trim()) {
        generateMarkdown();
      }
      const text = document.getElementById('output').textContent;
      if (!text.trim()) return;

      const name = document.getElementById('charName').value.trim() || "character";
      const filename = `${name}_prompt.txt`;

      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportAllData() {
      const store = getStore();
      const text = JSON.stringify(store, null, 2);
      const filename = `qing_backup_${new Date().toISOString().slice(0,10)}.json`;

      const blob = new Blob([text], { type: "application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importAllData() {
      const input = document.getElementById('allFile');
      if (!input.files || !input.files[0]) {
        alert("è«‹å…ˆé¸æ“‡ä¸€å€‹ JSON æª”æ¡ˆå–”ï½");
        return;
      }

      const file = input.files[0];
      const reader = new FileReader();

      reader.onload = function (e) {
        try {
          const content = e.target.result || "";
          const parsed = JSON.parse(content);

          if (!parsed || typeof parsed !== 'object') {
            alert("åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤");
            return;
          }
          if (!parsed.chars || typeof parsed.chars !== 'object') {
            alert("åŒ¯å…¥å¤±æ•—ï¼šç¼ºå°‘ chars è³‡æ–™");
            return;
          }
          if (!parsed.templates) {
            parsed.templates = initEmptyTemplates();
          } else {
            ensureTemplateTypes(parsed.templates);
          }

          setStore(parsed);
          loadInitialFromStore();

          alert("åŒ¯å…¥å®Œæˆï¼å·²é‚„åŸæ‰€æœ‰è³‡æ–™ã€‚");
        } catch (err) {
          console.error(err);
          alert("åŒ¯å…¥å¤±æ•—ï¼šç„¡æ³•è§£æ JSON");
        }
      };

      reader.readAsText(file, "utf-8");
    }

    /* ========= æ¸…ç©ºå–®æ¬„ ========= */
    function clearOne(id) {
      const el = document.getElementById(id);
      if (!el) return;
      if (el.tagName === 'SELECT' && id === 'gender') {
        el.value = 'æœªè¨­ç½®';
      } else {
        el.value = '';
      }
      if (id === 'promptRole' || id === 'promptGuideline' || id === 'modelType') {
        updatePromptTokenInfo();
      }
      saveCurrentChar();
      updateFieldCounter(el);
    }

    /* ========= è‡ªå‹•æš«å­˜ ========= */
    function setupAutoSave() {
      const els = document.querySelectorAll('input, textarea, select');
      els.forEach(el => {
        el.addEventListener('input', () => {
          saveCurrentChar();
          if (el.id === 'promptRole' || el.id === 'promptGuideline') {
            updatePromptTokenInfo();
          }
          if (el.tagName === 'TEXTAREA' ||
              el.type === 'text' ||
              el.type === 'search' ||
              el.type === 'date') {
            updateFieldCounter(el);
          }
        });
        // select change ä¹Ÿè¦å­˜
        el.addEventListener('change', () => {
           saveCurrentChar();
           if(el.tagName === 'SELECT') updatePromptTokenInfo();
        });
      });
    }

    function loadInitialFromStore() {
      const store = getStore();
      const ids = Object.keys(store.chars);
      if (!store.currentId && ids.length) {
        store.currentId = ids[0];
        setStore(store);
      }

      if (store.currentId && store.chars[store.currentId]) {
        fillFormFromData(store.chars[store.currentId].data);
      }

      renderCharList(store);
      updatePromptTokenInfo();
      refreshAllTemplateSelects();
      setupFieldUtils();
      renderTemplateManager();
    }

    window.addEventListener('DOMContentLoaded', () => {
      initLayoutByWidth();
      loadInitialFromStore();
      setupAutoSave();
      
      // ç›£è½è¦–çª—å¤§å°æ”¹è®Š
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(initLayoutByWidth, 200);
      });
    });
  </script>
</body>
</html>
